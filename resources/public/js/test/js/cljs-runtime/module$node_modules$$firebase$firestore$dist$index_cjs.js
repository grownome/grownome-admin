shadow$provide.module$node_modules$$firebase$firestore$dist$index_cjs=function(global,process,require,module,exports,shadow$shims){function getLogLevel(){return logClient.logLevel===logger.LogLevel.DEBUG?LogLevel$jscomp$0.DEBUG:logClient.logLevel===logger.LogLevel.SILENT?LogLevel$jscomp$0.SILENT:LogLevel$jscomp$0.ERROR}function setLogLevel(newLevel){switch(newLevel){case LogLevel$jscomp$0.DEBUG:logClient.logLevel=logger.LogLevel.DEBUG;break;case LogLevel$jscomp$0.ERROR:logClient.logLevel=logger.LogLevel.ERROR;
break;case LogLevel$jscomp$0.SILENT:logClient.logLevel=logger.LogLevel.SILENT;break;default:logClient.error("Firestore ("+SDK_VERSION+"): Invalid value passed to `setLogLevel`")}}function debug(tag,msg){for(var obj=[],_i=2;_i<arguments.length;_i++)obj[_i-2]=arguments[_i];logClient.logLevel<=logger.LogLevel.DEBUG&&(obj=obj.map(argToString),logClient.debug.apply(logClient,["Firestore ("+SDK_VERSION+") ["+tag+"]: "+msg].concat(obj)))}function error$jscomp$0(msg){for(var obj=[],_i=1;_i<arguments.length;_i++)obj[_i-
1]=arguments[_i];logClient.logLevel<=logger.LogLevel.ERROR&&(obj=obj.map(argToString),logClient.error.apply(logClient,["Firestore ("+SDK_VERSION+"): "+msg].concat(obj)))}function argToString(obj){if("string"===typeof obj)return obj;var platform=PlatformSupport.getPlatform();try{return platform.formatJSON(obj)}catch(e){return obj}}function fail(failure){failure="FIRESTORE ("+SDK_VERSION+") INTERNAL ASSERTION FAILED: "+failure;error$jscomp$0(failure);throw Error(failure);}function assert(assertion,
message){assertion||fail(message)}function emptyByteString(){return PlatformSupport.getPlatform().emptyByteString}function makeConstructorPrivate(cls,optionalMessage){function PublicConstructor(){var error="This constructor is private.";optionalMessage&&(error=error+" "+optionalMessage);throw new FirestoreError(Code.INVALID_ARGUMENT,error);}PublicConstructor.prototype=cls.prototype;for(var staticProperty in cls)cls.hasOwnProperty(staticProperty)&&(PublicConstructor[staticProperty]=cls[staticProperty]);
return PublicConstructor}function contains(obj,key){return Object.prototype.hasOwnProperty.call(obj,key)}function forEachNumber(obj,fn){for(var key in obj)if(Object.prototype.hasOwnProperty.call(obj,key)){var num=Number(key);isNaN(num)||fn(num,obj[key])}}function forEach(obj,fn){for(var key in obj)Object.prototype.hasOwnProperty.call(obj,key)&&fn(key,obj[key])}function isEmpty(obj){assert(null!=obj&&"object"===typeof obj,"isEmpty() expects object parameter.");for(var key in obj)if(Object.prototype.hasOwnProperty.call(obj,
key))return!1;return!0}function shallowCopy(obj){assert(obj&&"object"===typeof obj,"shallowCopy() expects object parameter.");var result={},key;for(key in obj)Object.prototype.hasOwnProperty.call(obj,key)&&(result[key]=obj[key]);return result}function validateExactNumberOfArgs(functionName,args,numberOfArgs){if(args.length!==numberOfArgs)throw new FirestoreError(Code.INVALID_ARGUMENT,"Function "+functionName+"() requires "+formatPlural(numberOfArgs,"argument")+", but was called with "+formatPlural(args.length,
"argument")+".");}function validateAtLeastNumberOfArgs(functionName,args,minNumberOfArgs){if(args.length<minNumberOfArgs)throw new FirestoreError(Code.INVALID_ARGUMENT,"Function "+functionName+"() requires at least "+formatPlural(minNumberOfArgs,"argument")+", but was called with "+formatPlural(args.length,"argument")+".");}function validateBetweenNumberOfArgs(functionName,args,minNumberOfArgs,maxNumberOfArgs){if(args.length<minNumberOfArgs||args.length>maxNumberOfArgs)throw new FirestoreError(Code.INVALID_ARGUMENT,
"Function "+functionName+"() requires between "+minNumberOfArgs+" and "+(maxNumberOfArgs+" arguments, but was called with ")+formatPlural(args.length,"argument")+".");}function validateArgType(functionName,type,position,argument){validateType(functionName,type,ordinal(position)+" argument",argument)}function validateOptionalArgType(functionName,type,position,argument){void 0!==argument&&validateArgType(functionName,type,position,argument)}function validateNamedOptionalType(functionName,type,optionName,
argument){void 0!==argument&&validateType(functionName,type,optionName+" option",argument)}function validateOptionalArrayElements(functionName,optionName,typeDescription,argument,validator){if(void 0!==argument){if(!(argument instanceof Array))throw new FirestoreError(Code.INVALID_ARGUMENT,"Function "+functionName+"() requires its "+optionName+" "+("option to be an array, but it was: "+valueDescription(argument)));for(var i=0;i<argument.length;++i)if(!validator(argument[i]))throw new FirestoreError(Code.INVALID_ARGUMENT,
"Function "+functionName+"() requires all "+optionName+" "+("elements to be "+typeDescription+", but the value at index "+i+" ")+("was: "+valueDescription(argument[i])));}}function validateNamedOptionalPropertyEquals(functionName,inputName,optionName,input,expected){if(void 0!==input)a:{inputName=[];for(var _i=0;_i<expected.length;_i++){var val=expected[_i];if(val===input)break a;inputName.push(valueDescription(val))}input=valueDescription(input);throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid value "+
input+" provided to function "+functionName+'() for option "'+optionName+'". Acceptable values: '+inputName.join(", "));}}function validateType(functionName,type,inputName,input){if(typeof input!==type||"object"===type&&!isPlainObject(input))throw input=valueDescription(input),new FirestoreError(Code.INVALID_ARGUMENT,"Function "+functionName+"() requires its "+inputName+" "+("to be of type "+type+", but it was: "+input));}function isPlainObject(input){return"object"===typeof input&&null!==input&&
(Object.getPrototypeOf(input)===Object.prototype||null===Object.getPrototypeOf(input))}function valueDescription(input){if(void 0===input)return"undefined";if(null===input)return"null";if("string"===typeof input)return 20<input.length&&(input=input.substring(0,20)+"..."),JSON.stringify(input);if("number"===typeof input||"boolean"===typeof input)return""+input;if("object"===typeof input){if(input instanceof Array)return"an array";a:{if(input.constructor&&(input=/function\s+([^\s(]+)\s*\(/.exec(input.constructor.toString()))&&
1<input.length){input=input[1];break a}input=null}return input?"a custom "+input+" object":"an object"}return"function"===typeof input?"a function":fail("Unknown wrong type: "+typeof input)}function validateDefined(functionName,position,argument){if(void 0===argument)throw new FirestoreError(Code.INVALID_ARGUMENT,"Function "+functionName+"() requires a valid "+ordinal(position)+" argument, but it was undefined.");}function validateOptionNames(functionName,options,optionNames){forEach(options,function(key,
_){if(0>optionNames.indexOf(key))throw new FirestoreError(Code.INVALID_ARGUMENT,"Unknown option '"+key+"' passed to function "+functionName+"(). Available options: "+optionNames.join(", "));})}function invalidClassError(functionName,type,position,argument){argument=valueDescription(argument);return new FirestoreError(Code.INVALID_ARGUMENT,"Function "+functionName+"() requires its "+ordinal(position)+" "+("argument to be a "+type+", but it was: "+argument))}function ordinal(num){switch(num){case 1:return"first";
case 2:return"second";case 3:return"third";default:return num+"th"}}function formatPlural(num,str){return num+" "+str+(1===num?"":"s")}function primitiveComparator(left,right){return left<right?-1:left>right?1:0}function arrayEquals(left,right){if(left.length!==right.length)return!1;for(var i=0;i<left.length;i++)if(!left[i].isEqual(right[i]))return!1;return!0}function assertUint8ArrayAvailable(){if("undefined"===typeof Uint8Array)throw new FirestoreError(Code.UNIMPLEMENTED,"Uint8Arrays are not available in this environment.");
}function assertBase64Available(){if(!PlatformSupport.getPlatform().base64Available)throw new FirestoreError(Code.UNIMPLEMENTED,"Blobs are unavailable in Firestore in this environment.");}function numericEquals(left,right){return left===right?0!==left||1/left===1/right:left!==left&&right!==right}function isNullOrUndefined(value){return null===value||void 0===value}function isPermanentError(code){switch(code){case Code.OK:return fail("Treated status OK as error");case Code.CANCELLED:case Code.UNKNOWN:case Code.DEADLINE_EXCEEDED:case Code.RESOURCE_EXHAUSTED:case Code.INTERNAL:case Code.UNAVAILABLE:case Code.UNAUTHENTICATED:return!1;
case Code.INVALID_ARGUMENT:case Code.NOT_FOUND:case Code.ALREADY_EXISTS:case Code.PERMISSION_DENIED:case Code.FAILED_PRECONDITION:case Code.ABORTED:case Code.OUT_OF_RANGE:case Code.UNIMPLEMENTED:case Code.DATA_LOSS:return!0;default:return fail("Unknown status code: "+code)}}function mapCodeFromRpcCode(code){if(void 0===code)return error$jscomp$0("GRPC error has no .code"),Code.UNKNOWN;switch(code){case RpcCode.OK:return Code.OK;case RpcCode.CANCELLED:return Code.CANCELLED;case RpcCode.UNKNOWN:return Code.UNKNOWN;
case RpcCode.DEADLINE_EXCEEDED:return Code.DEADLINE_EXCEEDED;case RpcCode.RESOURCE_EXHAUSTED:return Code.RESOURCE_EXHAUSTED;case RpcCode.INTERNAL:return Code.INTERNAL;case RpcCode.UNAVAILABLE:return Code.UNAVAILABLE;case RpcCode.UNAUTHENTICATED:return Code.UNAUTHENTICATED;case RpcCode.INVALID_ARGUMENT:return Code.INVALID_ARGUMENT;case RpcCode.NOT_FOUND:return Code.NOT_FOUND;case RpcCode.ALREADY_EXISTS:return Code.ALREADY_EXISTS;case RpcCode.PERMISSION_DENIED:return Code.PERMISSION_DENIED;case RpcCode.FAILED_PRECONDITION:return Code.FAILED_PRECONDITION;
case RpcCode.ABORTED:return Code.ABORTED;case RpcCode.OUT_OF_RANGE:return Code.OUT_OF_RANGE;case RpcCode.UNIMPLEMENTED:return Code.UNIMPLEMENTED;case RpcCode.DATA_LOSS:return Code.DATA_LOSS;default:return fail("Unknown status code: "+code)}}function mapRpcCodeFromCode(code){if(void 0===code)return RpcCode.OK;switch(code){case Code.OK:return RpcCode.OK;case Code.CANCELLED:return RpcCode.CANCELLED;case Code.UNKNOWN:return RpcCode.UNKNOWN;case Code.DEADLINE_EXCEEDED:return RpcCode.DEADLINE_EXCEEDED;
case Code.RESOURCE_EXHAUSTED:return RpcCode.RESOURCE_EXHAUSTED;case Code.INTERNAL:return RpcCode.INTERNAL;case Code.UNAVAILABLE:return RpcCode.UNAVAILABLE;case Code.UNAUTHENTICATED:return RpcCode.UNAUTHENTICATED;case Code.INVALID_ARGUMENT:return RpcCode.INVALID_ARGUMENT;case Code.NOT_FOUND:return RpcCode.NOT_FOUND;case Code.ALREADY_EXISTS:return RpcCode.ALREADY_EXISTS;case Code.PERMISSION_DENIED:return RpcCode.PERMISSION_DENIED;case Code.FAILED_PRECONDITION:return RpcCode.FAILED_PRECONDITION;case Code.ABORTED:return RpcCode.ABORTED;
case Code.OUT_OF_RANGE:return RpcCode.OUT_OF_RANGE;case Code.UNIMPLEMENTED:return RpcCode.UNIMPLEMENTED;case Code.DATA_LOSS:return RpcCode.DATA_LOSS;default:return fail("Unknown status code: "+code)}}function mapCodeFromHttpStatus(status){switch(status){case 200:return Code.OK;case 400:return Code.INVALID_ARGUMENT;case 401:return Code.UNAUTHENTICATED;case 403:return Code.PERMISSION_DENIED;case 404:return Code.NOT_FOUND;case 409:return Code.ABORTED;case 416:return Code.OUT_OF_RANGE;case 429:return Code.RESOURCE_EXHAUSTED;
case 499:return Code.CANCELLED;case 500:return Code.UNKNOWN;case 501:return Code.UNIMPLEMENTED;case 503:return Code.UNAVAILABLE;case 504:return Code.DEADLINE_EXCEEDED;default:return 200<=status&&300>status?Code.OK:400<=status&&500>status?Code.FAILED_PRECONDITION:500<=status&&600>status?Code.INTERNAL:Code.UNKNOWN}}function assertPresent(value,description){assert(!isNullOrUndefined(value),description+" is missing")}function parseInt64(value){return"number"===typeof value?value:"string"===typeof value?
Number(value):fail("can't parse "+value)}function hasTag(obj,type,tag){return type===tag||!type&&tag in obj}function compareChangeType(c1,c2){var order=function(change){switch(change){case ChangeType.Added:return 1;case ChangeType.Modified:return 2;case ChangeType.Metadata:return 2;case ChangeType.Removed:return 0;default:return fail("Unknown ChangeType: "+change)}};return order(c1)-order(c2)}function encode(path){for(var result="",i=0;i<path.length;i++){0<result.length&&(result+="");for(var segment=
path.get(i),length=segment.length,i$jscomp$0=0;i$jscomp$0<length;i$jscomp$0++){var c=segment.charAt(i$jscomp$0);switch(c){case "\x00":result+="";break;case "":result+="";break;default:result+=c}}}return result+""}function decode$1(path){var length=path.length;assert(2<=length,"Invalid path "+path);if(2===length)return assert(""===path.charAt(0)&&""===path.charAt(1),"Non-empty path "+path+" had length 2"),ResourcePath.EMPTY_PATH;for(var lastReasonableEscapeIndex=length-2,segments=[],segmentBuilder=
"",start=0;start<length;){var end=path.indexOf("",start);(0>end||end>lastReasonableEscapeIndex)&&fail('Invalid encoded resource path: "'+path+'"');switch(path.charAt(end+1)){case "":start=path.substring(start,end);0!==segmentBuilder.length&&(start=segmentBuilder+=start,segmentBuilder="");segments.push(start);break;case "":segmentBuilder+=path.substring(start,end);segmentBuilder+="\x00";break;case "":segmentBuilder+=path.substring(start,end+1);break;default:fail('Invalid encoded resource path: "'+
path+'"')}start=end+2}return new ResourcePath(segments)}function createOrUpgradeDb(db,txn,fromVersion,toVersion){assert(fromVersion<toVersion&&0<=fromVersion&&3>=toVersion,"Unexpected schema upgrade from v${fromVersion} to v{toVersion}.");1>fromVersion&&1<=toVersion&&(db.createObjectStore(DbOwner.store),createMutationQueue(db),createQueryCache(db),db.createObjectStore(DbRemoteDocument.store));var p=PersistencePromise.resolve();3>fromVersion&&3<=toVersion&&(0!==fromVersion&&(dropQueryCache(db),createQueryCache(db)),
p=p.next(function(){var globalStore=txn.store(DbTargetGlobal.store),metadata=new DbTargetGlobal(0,0,SnapshotVersion.MIN.toTimestamp(),0);return globalStore.put(DbTargetGlobal.key,metadata)}));return p}function createMutationQueue(db){db.createObjectStore(DbMutationQueue.store,{keyPath:DbMutationQueue.keyPath});db.createObjectStore(DbMutationBatch.store,{keyPath:DbMutationBatch.keyPath});db.createObjectStore(DbDocumentMutation.store)}function createQueryCache(db){db.createObjectStore(DbTargetDocument.store,
{keyPath:DbTargetDocument.keyPath}).createIndex(DbTargetDocument.documentTargetsIndex,DbTargetDocument.documentTargetsKeyPath,{unique:!0});db.createObjectStore(DbTarget.store,{keyPath:DbTarget.keyPath}).createIndex(DbTarget.queryTargetsIndexName,DbTarget.queryTargetsKeyPath,{unique:!0});db.createObjectStore(DbTargetGlobal.store)}function dropQueryCache(db){db.deleteObjectStore(DbTargetDocument.store);db.deleteObjectStore(DbTarget.store);db.deleteObjectStore(DbTargetGlobal.store)}function convertStreamToken(token){return token instanceof
Uint8Array?(assert("YES"===process.env.USE_MOCK_PERSISTENCE,"Persisting non-string stream tokens is only supported with mock persistence ."),token.toString()):token}function mutationsStore(txn){return IndexedDbPersistence.getStore(txn,DbMutationBatch.store)}function documentMutationsStore(txn){return IndexedDbPersistence.getStore(txn,DbDocumentMutation.store)}function documentTargetStore(txn){return IndexedDbPersistence.getStore(txn,DbTargetDocument.store)}function wrapRequest(request){return new PersistencePromise(function(resolve,
reject){request.onsuccess=function(event){resolve(event.target.result)};request.onerror=function(event){reject(event.target.error)}})}function isPartialObserver(obj){a:{if("object"===typeof obj&&null!==obj)for(var _i=0,methods_1=["next","error","complete"];_i<methods_1.length;_i++){var method=methods_1[_i];if(method in obj&&"function"===typeof obj[method]){obj=!0;break a}}obj=!1}return obj}function isWrite(dataSource){switch(dataSource){case UserDataSource.Set:case UserDataSource.MergeSet:case UserDataSource.Update:return!0;
case UserDataSource.Argument:return!1;default:throw fail("Unexpected case for UserDataSource: "+dataSource);}}function looksLikeJsonObject(input){return"object"===typeof input&&null!==input&&!(input instanceof Array)&&!(input instanceof Date)&&!(input instanceof Timestamp)&&!(input instanceof GeoPoint)&&!(input instanceof Blob$jscomp$0)&&!(input instanceof DocumentKeyReference)&&!(input instanceof FieldValueImpl)}function validatePlainObject(message,context,input){if(!looksLikeJsonObject(input)||
!isPlainObject(input)){input=valueDescription(input);if("an object"===input)throw context.createError(message+" a custom object");throw context.createError(message+" "+input);}}function fieldPathFromArgument(methodName,path){if(path instanceof FieldPath$1)return path._internalPath;if("string"===typeof path)return fieldPathFromDotSeparatedString(methodName,path);throw new FirestoreError(Code.INVALID_ARGUMENT,"Function "+methodName+"() called with invalid data. Field path arguments must be of type string or FieldPath.");
}function fieldPathFromDotSeparatedString(methodName,path){try{if(0<=path.search(RESERVED))throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid field path ("+path+"). Paths must not contain '~', '*', '/', '[', or ']'");try{var JSCompiler_inline_result=new (FieldPath$1.bind.apply(FieldPath$1,[void 0].concat(path.split("."))))}catch(e){throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid field path ("+path+"). Paths must not be empty, begin with '.', end with '.', or contain '..'");}return JSCompiler_inline_result._internalPath}catch(e){throw new FirestoreError(Code.INVALID_ARGUMENT,
"Function "+methodName+"() called with invalid data. "+(e instanceof Error?e.message:e.toString()));}}function validateSetOptions(methodName,options){if(void 0===options)return{merge:!1};validateOptionNames(methodName,options,["merge","mergeFields"]);validateNamedOptionalType(methodName,"boolean","merge",options.merge);validateOptionalArrayElements(methodName,"mergeFields","a string or a FieldPath",options.mergeFields,function(element){return"string"===typeof element||element instanceof FieldPath$1});
if(void 0!==options.mergeFields&&void 0!==options.merge)throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid options passed to function "+methodName+'(): You cannot specify both "merge" and "mergeFields".');return options}function validateSnapshotOptions(methodName,options){if(void 0===options)return{};validateOptionNames(methodName,options,["serverTimestamps"]);validateNamedOptionalPropertyEquals(methodName,"options","serverTimestamps",options.serverTimestamps,["estimate","previous","none"]);
return options}function validateReference(methodName,documentRef,firestore){if(documentRef instanceof DocumentReference){if(documentRef.firestore!==firestore)throw new FirestoreError(Code.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return documentRef}throw invalidClassError(methodName,"DocumentReference",1,documentRef);}function changesFromSnapshot(firestore,includeMetadataChanges,snapshot){if(snapshot.oldDocs.isEmpty()){var lastDoc_1,index_1=0;return snapshot.docChanges.map(function(change){var doc=
new QueryDocumentSnapshot(firestore,change.doc.key,change.doc,snapshot.fromCache);assert(change.type===ChangeType.Added,"Invalid event type for first snapshot");assert(!lastDoc_1||0>snapshot.query.docComparator(lastDoc_1,change.doc),"Got added events in wrong order");lastDoc_1=change.doc;return{type:"added",doc:doc,oldIndex:-1,newIndex:index_1++}})}var indexTracker_1=snapshot.oldDocs;return snapshot.docChanges.filter(function(change){return includeMetadataChanges||change.type!==ChangeType.Metadata}).map(function(change){var doc=
new QueryDocumentSnapshot(firestore,change.doc.key,change.doc,snapshot.fromCache),oldIndex=-1,newIndex=-1;change.type!==ChangeType.Added&&(oldIndex=indexTracker_1.indexOf(change.doc.key),assert(0<=oldIndex,"Index for document not found"),indexTracker_1=indexTracker_1.delete(change.doc.key));change.type!==ChangeType.Removed&&(indexTracker_1=indexTracker_1.add(change.doc),newIndex=indexTracker_1.indexOf(change.doc.key));return{type:resultChangeType(change.type),doc:doc,oldIndex:oldIndex,newIndex:newIndex}})}
function resultChangeType(type){switch(type){case ChangeType.Added:return"added";case ChangeType.Modified:case ChangeType.Metadata:return"modified";case ChangeType.Removed:return"removed";default:return fail("Unknown change type: "+type)}}function configureForFirebase(firebase$$1){firebase$$1.INTERNAL.registerService("firestore",function(app){return new Firestore(app)},shallowCopy(firestoreNamespace))}Object.defineProperty(exports,"__esModule",{value:!0});var firebase=function(ex){return ex&&"object"===
typeof ex&&"default"in ex?ex["default"]:ex}(require("module$node_modules$$firebase$app$dist$index_cjs")),logger=require("module$node_modules$$firebase$logger$dist$index_cjs"),tslib_1=require("module$node_modules$tslib$tslib"),webchannelWrapper=require("module$node_modules$$firebase$webchannel_wrapper$dist$index"),SDK_VERSION=firebase.SDK_VERSION,logClient=new logger.Logger("@firebase/firestore"),LogLevel$jscomp$0;(function(LogLevel){LogLevel[LogLevel.DEBUG=0]="DEBUG";LogLevel[LogLevel.ERROR=1]="ERROR";
LogLevel[LogLevel.SILENT=2]="SILENT"})(LogLevel$jscomp$0||(LogLevel$jscomp$0={}));var PlatformSupport=function(){function PlatformSupport(){}PlatformSupport.setPlatform=function(platform){PlatformSupport.platform&&fail("Platform already defined");PlatformSupport.platform=platform};PlatformSupport.getPlatform=function(){PlatformSupport.platform||fail("Platform not set");return PlatformSupport.platform};return PlatformSupport}(),Code={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",
DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"},FirestoreError=function(_super){function FirestoreError(code,message){var _this=_super.call(this,message)||this;
_this.code=code;_this.message=message;_this.name="FirebaseError";_this.toString=function(){return _this.name+": [code\x3d"+_this.code+"]: "+_this.message};return _this}tslib_1.__extends(FirestoreError,_super);return FirestoreError}(Error),AutoId=function(){function AutoId(){}AutoId.newId=function(){for(var autoId="",i=0;20>i;i++)autoId+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(Math.floor(62*Math.random()));assert(20===autoId.length,"Invalid auto ID: "+autoId);return autoId};
return AutoId}(),Blob$jscomp$0=function(){function Blob(binaryString){assertBase64Available();this._binaryString=binaryString}Blob.fromBase64String=function(base64){validateExactNumberOfArgs("Blob.fromBase64String",arguments,1);validateArgType("Blob.fromBase64String","string",1,base64);assertBase64Available();try{var binaryString=PlatformSupport.getPlatform().atob(base64);return new Blob(binaryString)}catch(e){throw new FirestoreError(Code.INVALID_ARGUMENT,"Failed to construct Blob from Base64 string: "+
e);}};Blob.fromUint8Array=function(array){validateExactNumberOfArgs("Blob.fromUint8Array",arguments,1);assertUint8ArrayAvailable();if(!(array instanceof Uint8Array))throw invalidClassError("Blob.fromUint8Array","Uint8Array",1,array);var binaryString=Array.prototype.map.call(array,function(char){return String.fromCharCode(char)}).join("");return new Blob(binaryString)};Blob.prototype.toBase64=function(){validateExactNumberOfArgs("Blob.toBase64",arguments,0);assertBase64Available();return PlatformSupport.getPlatform().btoa(this._binaryString)};
Blob.prototype.toUint8Array=function(){validateExactNumberOfArgs("Blob.toUint8Array",arguments,0);assertUint8ArrayAvailable();for(var buffer=new Uint8Array(this._binaryString.length),i=0;i<this._binaryString.length;i++)buffer[i]=this._binaryString.charCodeAt(i);return buffer};Blob.prototype.toString=function(){return"Blob(base64: "+this.toBase64()+")"};Blob.prototype.isEqual=function(other){return this._binaryString===other._binaryString};Blob.prototype._compareTo=function(other){return primitiveComparator(this._binaryString,
other._binaryString)};return Blob}(),PublicBlob=makeConstructorPrivate(Blob$jscomp$0,"Use Blob.fromUint8Array() or Blob.fromBase64String() instead."),GeoPoint=function(){function GeoPoint(latitude,longitude){validateExactNumberOfArgs("GeoPoint",arguments,2);validateArgType("GeoPoint","number",1,latitude);validateArgType("GeoPoint","number",2,longitude);if(!isFinite(latitude)||-90>latitude||90<latitude)throw new FirestoreError(Code.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+
latitude);if(!isFinite(longitude)||-180>longitude||180<longitude)throw new FirestoreError(Code.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+longitude);this._lat=latitude;this._long=longitude}Object.defineProperty(GeoPoint.prototype,"latitude",{get:function(){return this._lat},enumerable:!0,configurable:!0});Object.defineProperty(GeoPoint.prototype,"longitude",{get:function(){return this._long},enumerable:!0,configurable:!0});GeoPoint.prototype.isEqual=function(other){return this._lat===
other._lat&&this._long===other._long};GeoPoint.prototype._compareTo=function(other){return primitiveComparator(this._lat,other._lat)||primitiveComparator(this._long,other._long)};return GeoPoint}(),Timestamp=function(){function Timestamp(seconds,nanoseconds){this.seconds=seconds;this.nanoseconds=nanoseconds;if(0>nanoseconds)throw new FirestoreError(Code.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+nanoseconds);if(1E9<=nanoseconds)throw new FirestoreError(Code.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+
nanoseconds);if(-62135596800>seconds)throw new FirestoreError(Code.INVALID_ARGUMENT,"Timestamp seconds out of range: "+seconds);if(253402300800<=seconds)throw new FirestoreError(Code.INVALID_ARGUMENT,"Timestamp seconds out of range: "+seconds);}Timestamp.now=function(){return Timestamp.fromMillis(Date.now())};Timestamp.fromDate=function(date){return Timestamp.fromMillis(date.getTime())};Timestamp.fromMillis=function(milliseconds){var seconds=Math.floor(milliseconds/1E3);return new Timestamp(seconds,
1E6*(milliseconds-1E3*seconds))};Timestamp.prototype.toDate=function(){return new Date(this.toMillis())};Timestamp.prototype.toMillis=function(){return 1E3*this.seconds+this.nanoseconds/1E6};Timestamp.prototype._compareTo=function(other){return this.seconds===other.seconds?primitiveComparator(this.nanoseconds,other.nanoseconds):primitiveComparator(this.seconds,other.seconds)};Timestamp.prototype.isEqual=function(other){return other.seconds===this.seconds&&other.nanoseconds===this.nanoseconds};Timestamp.prototype.toString=
function(){return"Timestamp(seconds\x3d"+this.seconds+", nanoseconds\x3d"+this.nanoseconds+")"};return Timestamp}(),DatabaseInfo=function(){return function(databaseId,persistenceKey,host,ssl){this.databaseId=databaseId;this.persistenceKey=persistenceKey;this.host=host;this.ssl=ssl}}(),DatabaseId=function(){function DatabaseId(projectId,database){this.projectId=projectId;this.database=database?database:"(default)"}Object.defineProperty(DatabaseId.prototype,"isDefaultDatabase",{get:function(){return"(default)"===
this.database},enumerable:!0,configurable:!0});DatabaseId.prototype.isEqual=function(other){return other instanceof DatabaseId&&other.projectId===this.projectId&&other.database===this.database};DatabaseId.prototype.compareTo=function(other){return primitiveComparator(this.projectId,other.projectId)||primitiveComparator(this.database,other.database)};return DatabaseId}(),Path$jscomp$0=function(){function Path(segments,offset,length){this.init(segments,offset,length)}Path.prototype.init=function(segments,
offset,length){void 0===offset?offset=0:offset>segments.length&&fail("offset "+offset+" out of range "+segments.length);void 0===length?length=segments.length-offset:length>segments.length-offset&&fail("length "+length+" out of range "+(segments.length-offset));this.segments=segments;this.offset=offset;this.len=length};Path.prototype.construct=function(segments,offset,length){var path=Object.create(Object.getPrototypeOf(this));path.init(segments,offset,length);return path};Object.defineProperty(Path.prototype,
"length",{get:function(){return this.len},enumerable:!0,configurable:!0});Path.prototype.isEqual=function(other){return 0===Path.comparator(this,other)};Path.prototype.child=function(nameOrPath){var segments=this.segments.slice(this.offset,this.limit());nameOrPath instanceof Path?nameOrPath.forEach(function(segment){segments.push(segment)}):"string"===typeof nameOrPath?segments.push(nameOrPath):fail("Unknown parameter type for Path.child(): "+nameOrPath);return this.construct(segments)};Path.prototype.limit=
function(){return this.offset+this.length};Path.prototype.popFirst=function(size){size=void 0===size?1:size;assert(this.length>=size,"Can't call popFirst() with less segments");return this.construct(this.segments,this.offset+size,this.length-size)};Path.prototype.popLast=function(){assert(!this.isEmpty(),"Can't call popLast() on empty path");return this.construct(this.segments,this.offset,this.length-1)};Path.prototype.firstSegment=function(){assert(!this.isEmpty(),"Can't call firstSegment() on empty path");
return this.segments[this.offset]};Path.prototype.lastSegment=function(){assert(!this.isEmpty(),"Can't call lastSegment() on empty path");return this.segments[this.limit()-1]};Path.prototype.get=function(index){assert(index<this.length,"Index out of range");return this.segments[this.offset+index]};Path.prototype.isEmpty=function(){return 0===this.length};Path.prototype.isPrefixOf=function(other){if(other.length<this.length)return!1;for(var i=0;i<this.length;i++)if(this.get(i)!==other.get(i))return!1;
return!0};Path.prototype.isImmediateParentOf=function(potentialChild){if(this.length+1!==potentialChild.length)return!1;for(var i=0;i<this.length;i++)if(this.get(i)!==potentialChild.get(i))return!1;return!0};Path.prototype.forEach=function(fn){for(var i=this.offset,end=this.limit();i<end;i++)fn(this.segments[i])};Path.prototype.toArray=function(){return this.segments.slice(this.offset,this.limit())};Path.comparator=function(p1,p2){for(var len=Math.min(p1.length,p2.length),i=0;i<len;i++){var left=
p1.get(i),right=p2.get(i);if(left<right)return-1;if(left>right)return 1}return p1.length<p2.length?-1:p1.length>p2.length?1:0};return Path}(),ResourcePath=function(_super){function ResourcePath(){return null!==_super&&_super.apply(this,arguments)||this}tslib_1.__extends(ResourcePath,_super);ResourcePath.prototype.canonicalString=function(){return this.toArray().join("/")};ResourcePath.prototype.toString=function(){return this.canonicalString()};ResourcePath.fromString=function(path){if(0<=path.indexOf("//"))throw new FirestoreError(Code.INVALID_ARGUMENT,
"Invalid path ("+path+"). Paths must not contain // in them.");path=path.split("/").filter(function(segment){return 0<segment.length});return new ResourcePath(path)};ResourcePath.EMPTY_PATH=new ResourcePath([]);return ResourcePath}(Path$jscomp$0),identifierRegExp=/^[_a-zA-Z][_a-zA-Z0-9]*$/,FieldPath=function(_super){function FieldPath(){return null!==_super&&_super.apply(this,arguments)||this}tslib_1.__extends(FieldPath,_super);FieldPath.isValidIdentifier=function(segment){return identifierRegExp.test(segment)};
FieldPath.prototype.canonicalString=function(){return this.toArray().map(function(str){str=str.replace("\\","\\\\").replace("`","\\`");FieldPath.isValidIdentifier(str)||(str="`"+str+"`");return str}).join(".")};FieldPath.prototype.toString=function(){return this.canonicalString()};FieldPath.prototype.isKeyField=function(){return 1===this.length&&"__name__"===this.get(0)};FieldPath.keyField=function(){return new FieldPath(["__name__"])};FieldPath.fromServerFormat=function(path){for(var segments=[],
current="",i=0,addCurrentSegment=function(){if(0===current.length)throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid field path ("+path+"). Paths must not be empty, begin with '.', end with '.', or contain '..'");segments.push(current);current=""},inBackticks=!1;i<path.length;){var c=path[i];if("\\"===c){if(i+1===path.length)throw new FirestoreError(Code.INVALID_ARGUMENT,"Path has trailing escape character: "+path);c=path[i+1];if("\\"!==c&&"."!==c&&"`"!==c)throw new FirestoreError(Code.INVALID_ARGUMENT,
"Path has invalid escape sequence: "+path);current+=c;i+=2}else"`"===c?inBackticks=!inBackticks:"."!==c||inBackticks?current+=c:addCurrentSegment(),i++}addCurrentSegment();if(inBackticks)throw new FirestoreError(Code.INVALID_ARGUMENT,"Unterminated ` in path: "+path);return new FieldPath(segments)};FieldPath.EMPTY_PATH=new FieldPath([]);return FieldPath}(Path$jscomp$0),DocumentKey=function(){function DocumentKey(path){this.path=path;assert(DocumentKey.isDocumentKey(path),"Invalid DocumentKey with an odd number of segments: "+
path.toArray().join("/"))}DocumentKey.prototype.isEqual=function(other){return null!==other&&0===ResourcePath.comparator(this.path,other.path)};DocumentKey.prototype.toString=function(){return this.path.toString()};DocumentKey.comparator=function(k1,k2){return ResourcePath.comparator(k1.path,k2.path)};DocumentKey.isDocumentKey=function(path){return 0===path.length%2};DocumentKey.fromSegments=function(segments){return new DocumentKey(new ResourcePath(segments.slice()))};DocumentKey.fromPathString=
function(path){return new DocumentKey(ResourcePath.fromString(path))};DocumentKey.EMPTY=new DocumentKey(new ResourcePath([]));return DocumentKey}(),Document$jscomp$0=function(){function Document(key,version,data,options){this.key=key;this.version=version;this.data=data;this.hasLocalMutations=options.hasLocalMutations}Document.prototype.field=function(path){return this.data.field(path)};Document.prototype.fieldValue=function(path){return(path=this.field(path))?path.value():void 0};Document.prototype.value=
function(){return this.data.value()};Document.prototype.isEqual=function(other){return other instanceof Document&&this.key.isEqual(other.key)&&this.version.isEqual(other.version)&&this.data.isEqual(other.data)&&this.hasLocalMutations===other.hasLocalMutations};Document.prototype.toString=function(){return"Document("+this.key+", "+this.version+", "+this.data.toString()+", "+("{hasLocalMutations: "+this.hasLocalMutations+"})")};Document.compareByKey=function(d1,d2){return DocumentKey.comparator(d1.key,
d2.key)};Document.compareByField=function(field,d1,d2){d1=d1.field(field);field=d2.field(field);return void 0!==d1&&void 0!==field?d1.compareTo(field):fail("Trying to compare documents on fields that don't exist")};return Document}(),NoDocument=function(){function NoDocument(key,version){this.key=key;this.version=version}NoDocument.prototype.toString=function(){return"NoDocument("+this.key+", "+this.version+")"};NoDocument.prototype.isEqual=function(other){return other&&other.version.isEqual(this.version)&&
other.key.isEqual(this.key)};NoDocument.compareByKey=function(d1,d2){return DocumentKey.comparator(d1.key,d2.key)};return NoDocument}(),SortedMap$jscomp$0=function(){function SortedMap(comparator,root){this.comparator=comparator;this.root=root?root:LLRBNode$jscomp$0.EMPTY}SortedMap.prototype.insert=function(key,value){return new SortedMap(this.comparator,this.root.insert(key,value,this.comparator).copy(null,null,LLRBNode$jscomp$0.BLACK,null,null))};SortedMap.prototype.remove=function(key){return new SortedMap(this.comparator,
this.root.remove(key,this.comparator).copy(null,null,LLRBNode$jscomp$0.BLACK,null,null))};SortedMap.prototype.get=function(key){for(var node=this.root;!node.isEmpty();){var cmp=this.comparator(key,node.key);if(0===cmp)return node.value;0>cmp?node=node.left:0<cmp&&(node=node.right)}return null};SortedMap.prototype.indexOf=function(key){for(var prunedNodes=0,node=this.root;!node.isEmpty();){var cmp=this.comparator(key,node.key);if(0===cmp)return prunedNodes+node.left.size;0>cmp?node=node.left:(prunedNodes+=
node.left.size+1,node=node.right)}return-1};SortedMap.prototype.isEmpty=function(){return this.root.isEmpty()};Object.defineProperty(SortedMap.prototype,"size",{get:function(){return this.root.size},enumerable:!0,configurable:!0});SortedMap.prototype.minKey=function(){return this.root.minKey()};SortedMap.prototype.maxKey=function(){return this.root.maxKey()};SortedMap.prototype.inorderTraversal=function(action){return this.root.inorderTraversal(action)};SortedMap.prototype.forEach=function(fn){this.inorderTraversal(function(k,
v){fn(k,v);return!1})};SortedMap.prototype.reverseTraversal=function(action){return this.root.reverseTraversal(action)};SortedMap.prototype.getIterator=function(){return new SortedMapIterator$jscomp$0(this.root,null,this.comparator,!1)};SortedMap.prototype.getIteratorFrom=function(key){return new SortedMapIterator$jscomp$0(this.root,key,this.comparator,!1)};SortedMap.prototype.getReverseIterator=function(){return new SortedMapIterator$jscomp$0(this.root,null,this.comparator,!0)};SortedMap.prototype.getReverseIteratorFrom=
function(key){return new SortedMapIterator$jscomp$0(this.root,key,this.comparator,!0)};return SortedMap}(),SortedMapIterator$jscomp$0=function(){function SortedMapIterator(node,startKey,comparator,isReverse){this.isReverse=isReverse;this.nodeStack=[];for(var cmp;!node.isEmpty();)if(cmp=startKey?comparator(node.key,startKey):1,isReverse&&(cmp*=-1),0>cmp)node=this.isReverse?node.left:node.right;else if(0===cmp){this.nodeStack.push(node);break}else this.nodeStack.push(node),node=this.isReverse?node.right:
node.left}SortedMapIterator.prototype.getNext=function(){assert(0<this.nodeStack.length,"getNext() called on iterator when hasNext() is false.");var node=this.nodeStack.pop(),result={key:node.key,value:node.value};if(this.isReverse)for(node=node.left;!node.isEmpty();)this.nodeStack.push(node),node=node.right;else for(node=node.right;!node.isEmpty();)this.nodeStack.push(node),node=node.left;return result};SortedMapIterator.prototype.hasNext=function(){return 0<this.nodeStack.length};SortedMapIterator.prototype.peek=
function(){if(0===this.nodeStack.length)return null;var node=this.nodeStack[this.nodeStack.length-1];return{key:node.key,value:node.value}};return SortedMapIterator}(),LLRBNode$jscomp$0=function(){function LLRBNode(key,value,color,left,right){this.key=key;this.value=value;this.color=null!=color?color:LLRBNode.RED;this.left=null!=left?left:LLRBNode.EMPTY;this.right=null!=right?right:LLRBNode.EMPTY;this.size=this.left.size+1+this.right.size}LLRBNode.prototype.copy=function(key,value,color,left,right){return new LLRBNode(null!=
key?key:this.key,null!=value?value:this.value,null!=color?color:this.color,null!=left?left:this.left,null!=right?right:this.right)};LLRBNode.prototype.isEmpty=function(){return!1};LLRBNode.prototype.inorderTraversal=function(action){return this.left.inorderTraversal(action)||action(this.key,this.value)||this.right.inorderTraversal(action)};LLRBNode.prototype.reverseTraversal=function(action){return this.right.reverseTraversal(action)||action(this.key,this.value)||this.left.reverseTraversal(action)};
LLRBNode.prototype.min=function(){return this.left.isEmpty()?this:this.left.min()};LLRBNode.prototype.minKey=function(){return this.min().key};LLRBNode.prototype.maxKey=function(){return this.right.isEmpty()?this.key:this.right.maxKey()};LLRBNode.prototype.insert=function(key,value,comparator){var n=this,cmp=comparator(key,n.key);n=0>cmp?n.copy(null,null,null,n.left.insert(key,value,comparator),null):0===cmp?n.copy(null,value,null,null,null):n.copy(null,null,null,null,n.right.insert(key,value,comparator));
return n.fixUp()};LLRBNode.prototype.removeMin=function(){if(this.left.isEmpty())return LLRBNode.EMPTY;var n=this;n.left.isRed()||n.left.left.isRed()||(n=n.moveRedLeft());n=n.copy(null,null,null,n.left.removeMin(),null);return n.fixUp()};LLRBNode.prototype.remove=function(key,comparator){var n=this;if(0>comparator(key,n.key))n.left.isEmpty()||n.left.isRed()||n.left.left.isRed()||(n=n.moveRedLeft()),n=n.copy(null,null,null,n.left.remove(key,comparator),null);else{n.left.isRed()&&(n=n.rotateRight());
n.right.isEmpty()||n.right.isRed()||n.right.left.isRed()||(n=n.moveRedRight());if(0===comparator(key,n.key)){if(n.right.isEmpty())return LLRBNode.EMPTY;var smallest=n.right.min();n=n.copy(smallest.key,smallest.value,null,null,n.right.removeMin())}n=n.copy(null,null,null,null,n.right.remove(key,comparator))}return n.fixUp()};LLRBNode.prototype.isRed=function(){return this.color};LLRBNode.prototype.fixUp=function(){var n=this;n.right.isRed()&&!n.left.isRed()&&(n=n.rotateLeft());n.left.isRed()&&n.left.left.isRed()&&
(n=n.rotateRight());n.left.isRed()&&n.right.isRed()&&(n=n.colorFlip());return n};LLRBNode.prototype.moveRedLeft=function(){var n=this.colorFlip();n.right.left.isRed()&&(n=n.copy(null,null,null,null,n.right.rotateRight()),n=n.rotateLeft(),n=n.colorFlip());return n};LLRBNode.prototype.moveRedRight=function(){var n=this.colorFlip();n.left.left.isRed()&&(n=n.rotateRight(),n=n.colorFlip());return n};LLRBNode.prototype.rotateLeft=function(){var nl=this.copy(null,null,LLRBNode.RED,null,this.right.left);
return this.right.copy(null,null,this.color,nl,null)};LLRBNode.prototype.rotateRight=function(){var nr=this.copy(null,null,LLRBNode.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,nr)};LLRBNode.prototype.colorFlip=function(){var left=this.left.copy(null,null,!this.left.color,null,null),right=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,left,right)};LLRBNode.prototype.checkMaxDepth=function(){var blackDepth=this.check();return Math.pow(2,
blackDepth)<=this.size+1?!0:!1};LLRBNode.prototype.check=function(){if(this.isRed()&&this.left.isRed())throw fail("Red node has red child("+this.key+","+this.value+")");if(this.right.isRed())throw fail("Right child of ("+this.key+","+this.value+") is red");var blackDepth=this.left.check();if(blackDepth!==this.right.check())throw fail("Black depths differ");return blackDepth+(this.isRed()?0:1)};LLRBNode.EMPTY=null;LLRBNode.RED=!0;LLRBNode.BLACK=!1;return LLRBNode}(),LLRBEmptyNode$jscomp$0=function(){function LLRBEmptyNode(){this.size=
0}LLRBEmptyNode.prototype.copy=function(key,value,color,left,right){return this};LLRBEmptyNode.prototype.insert=function(key,value,comparator){return new LLRBNode$jscomp$0(key,value)};LLRBEmptyNode.prototype.remove=function(key,comparator){return this};LLRBEmptyNode.prototype.isEmpty=function(){return!0};LLRBEmptyNode.prototype.inorderTraversal=function(action){return!1};LLRBEmptyNode.prototype.reverseTraversal=function(action){return!1};LLRBEmptyNode.prototype.minKey=function(){return null};LLRBEmptyNode.prototype.maxKey=
function(){return null};LLRBEmptyNode.prototype.isRed=function(){return!1};LLRBEmptyNode.prototype.checkMaxDepth=function(){return!0};LLRBEmptyNode.prototype.check=function(){return 0};return LLRBEmptyNode}();LLRBNode$jscomp$0.EMPTY=new LLRBEmptyNode$jscomp$0;var TypeOrder;(function(TypeOrder){TypeOrder[TypeOrder.NullValue=0]="NullValue";TypeOrder[TypeOrder.BooleanValue=1]="BooleanValue";TypeOrder[TypeOrder.NumberValue=2]="NumberValue";TypeOrder[TypeOrder.TimestampValue=3]="TimestampValue";TypeOrder[TypeOrder.StringValue=
4]="StringValue";TypeOrder[TypeOrder.BlobValue=5]="BlobValue";TypeOrder[TypeOrder.RefValue=6]="RefValue";TypeOrder[TypeOrder.GeoPointValue=7]="GeoPointValue";TypeOrder[TypeOrder.ArrayValue=8]="ArrayValue";TypeOrder[TypeOrder.ObjectValue=9]="ObjectValue"})(TypeOrder||(TypeOrder={}));var ServerTimestampBehavior;(function(ServerTimestampBehavior){ServerTimestampBehavior[ServerTimestampBehavior.Default=0]="Default";ServerTimestampBehavior[ServerTimestampBehavior.Estimate=1]="Estimate";ServerTimestampBehavior[ServerTimestampBehavior.Previous=
2]="Previous"})(ServerTimestampBehavior||(ServerTimestampBehavior={}));var FieldValueOptions=function(){function FieldValueOptions(serverTimestampBehavior,timestampsInSnapshots){this.serverTimestampBehavior=serverTimestampBehavior;this.timestampsInSnapshots=timestampsInSnapshots}FieldValueOptions.fromSnapshotOptions=function(options,timestampsInSnapshots){switch(options.serverTimestamps){case "estimate":return new FieldValueOptions(ServerTimestampBehavior.Estimate,timestampsInSnapshots);case "previous":return new FieldValueOptions(ServerTimestampBehavior.Previous,
timestampsInSnapshots);case "none":case void 0:return new FieldValueOptions(ServerTimestampBehavior.Default,timestampsInSnapshots);default:return fail("fromSnapshotOptions() called with invalid options.")}};return FieldValueOptions}(),FieldValue=function(){function FieldValue(){}FieldValue.prototype.toString=function(){var val=this.value();return null===val?"null":val.toString()};FieldValue.prototype.defaultCompareTo=function(other){assert(this.typeOrder!==other.typeOrder,"Default compareTo should not be used for values of same type.");
return primitiveComparator(this.typeOrder,other.typeOrder)};return FieldValue}(),NullValue=function(_super){function NullValue(){var _this=_super.call(this)||this;_this.typeOrder=TypeOrder.NullValue;_this.internalValue=null;return _this}tslib_1.__extends(NullValue,_super);NullValue.prototype.value=function(options){return null};NullValue.prototype.isEqual=function(other){return other instanceof NullValue};NullValue.prototype.compareTo=function(other){return other instanceof NullValue?0:this.defaultCompareTo(other)};
NullValue.INSTANCE=new NullValue;return NullValue}(FieldValue),BooleanValue=function(_super){function BooleanValue(internalValue){var _this=_super.call(this)||this;_this.internalValue=internalValue;_this.typeOrder=TypeOrder.BooleanValue;return _this}tslib_1.__extends(BooleanValue,_super);BooleanValue.prototype.value=function(options){return this.internalValue};BooleanValue.prototype.isEqual=function(other){return other instanceof BooleanValue&&this.internalValue===other.internalValue};BooleanValue.prototype.compareTo=
function(other){return other instanceof BooleanValue?primitiveComparator(this,other):this.defaultCompareTo(other)};BooleanValue.of=function(value){return value?BooleanValue.TRUE:BooleanValue.FALSE};BooleanValue.TRUE=new BooleanValue(!0);BooleanValue.FALSE=new BooleanValue(!1);return BooleanValue}(FieldValue),NumberValue=function(_super){function NumberValue(internalValue){var _this=_super.call(this)||this;_this.internalValue=internalValue;_this.typeOrder=TypeOrder.NumberValue;return _this}tslib_1.__extends(NumberValue,
_super);NumberValue.prototype.value=function(options){return this.internalValue};NumberValue.prototype.compareTo=function(other){if(other instanceof NumberValue){var JSCompiler_temp=this.internalValue;other=other.internalValue;JSCompiler_temp=JSCompiler_temp<other?-1:JSCompiler_temp>other?1:JSCompiler_temp===other?0:isNaN(JSCompiler_temp)?isNaN(other)?0:-1:1}else JSCompiler_temp=this.defaultCompareTo(other);return JSCompiler_temp};return NumberValue}(FieldValue),IntegerValue=function(_super){function IntegerValue(internalValue){return _super.call(this,
internalValue)||this}tslib_1.__extends(IntegerValue,_super);IntegerValue.prototype.isEqual=function(other){return other instanceof IntegerValue?numericEquals(this.internalValue,other.internalValue):!1};return IntegerValue}(NumberValue),DoubleValue=function(_super){function DoubleValue(internalValue){var _this=_super.call(this,internalValue)||this;_this.internalValue=internalValue;return _this}tslib_1.__extends(DoubleValue,_super);DoubleValue.prototype.isEqual=function(other){return other instanceof
DoubleValue?numericEquals(this.internalValue,other.internalValue):!1};DoubleValue.NAN=new DoubleValue(NaN);DoubleValue.POSITIVE_INFINITY=new DoubleValue(Infinity);DoubleValue.NEGATIVE_INFINITY=new DoubleValue(-Infinity);return DoubleValue}(NumberValue),StringValue=function(_super){function StringValue(internalValue){var _this=_super.call(this)||this;_this.internalValue=internalValue;_this.typeOrder=TypeOrder.StringValue;return _this}tslib_1.__extends(StringValue,_super);StringValue.prototype.value=
function(options){return this.internalValue};StringValue.prototype.isEqual=function(other){return other instanceof StringValue&&this.internalValue===other.internalValue};StringValue.prototype.compareTo=function(other){return other instanceof StringValue?primitiveComparator(this.internalValue,other.internalValue):this.defaultCompareTo(other)};return StringValue}(FieldValue),TimestampValue=function(_super){function TimestampValue(internalValue){var _this=_super.call(this)||this;_this.internalValue=
internalValue;_this.typeOrder=TypeOrder.TimestampValue;return _this}tslib_1.__extends(TimestampValue,_super);TimestampValue.prototype.value=function(options){return options&&options.timestampsInSnapshots?this.internalValue:this.internalValue.toDate()};TimestampValue.prototype.isEqual=function(other){return other instanceof TimestampValue&&this.internalValue.isEqual(other.internalValue)};TimestampValue.prototype.compareTo=function(other){return other instanceof TimestampValue?this.internalValue._compareTo(other.internalValue):
other instanceof ServerTimestampValue?-1:this.defaultCompareTo(other)};return TimestampValue}(FieldValue),ServerTimestampValue=function(_super){function ServerTimestampValue(localWriteTime,previousValue){var _this=_super.call(this)||this;_this.localWriteTime=localWriteTime;_this.previousValue=previousValue;_this.typeOrder=TypeOrder.TimestampValue;return _this}tslib_1.__extends(ServerTimestampValue,_super);ServerTimestampValue.prototype.value=function(options){return options&&options.serverTimestampBehavior===
ServerTimestampBehavior.Estimate?(new TimestampValue(this.localWriteTime)).value(options):options&&options.serverTimestampBehavior===ServerTimestampBehavior.Previous?this.previousValue?this.previousValue.value(options):null:null};ServerTimestampValue.prototype.isEqual=function(other){return other instanceof ServerTimestampValue&&this.localWriteTime.isEqual(other.localWriteTime)};ServerTimestampValue.prototype.compareTo=function(other){return other instanceof ServerTimestampValue?this.localWriteTime._compareTo(other.localWriteTime):
other instanceof TimestampValue?1:this.defaultCompareTo(other)};ServerTimestampValue.prototype.toString=function(){return"\x3cServerTimestamp localTime\x3d"+this.localWriteTime.toString()+"\x3e"};return ServerTimestampValue}(FieldValue),BlobValue=function(_super){function BlobValue(internalValue){var _this=_super.call(this)||this;_this.internalValue=internalValue;_this.typeOrder=TypeOrder.BlobValue;return _this}tslib_1.__extends(BlobValue,_super);BlobValue.prototype.value=function(options){return this.internalValue};
BlobValue.prototype.isEqual=function(other){return other instanceof BlobValue&&this.internalValue.isEqual(other.internalValue)};BlobValue.prototype.compareTo=function(other){return other instanceof BlobValue?this.internalValue._compareTo(other.internalValue):this.defaultCompareTo(other)};return BlobValue}(FieldValue),RefValue=function(_super){function RefValue(databaseId,key){var _this=_super.call(this)||this;_this.databaseId=databaseId;_this.key=key;_this.typeOrder=TypeOrder.RefValue;return _this}
tslib_1.__extends(RefValue,_super);RefValue.prototype.value=function(options){return this.key};RefValue.prototype.isEqual=function(other){return other instanceof RefValue?this.key.isEqual(other.key)&&this.databaseId.isEqual(other.databaseId):!1};RefValue.prototype.compareTo=function(other){if(other instanceof RefValue){var cmp=this.databaseId.compareTo(other.databaseId);return 0!==cmp?cmp:DocumentKey.comparator(this.key,other.key)}return this.defaultCompareTo(other)};return RefValue}(FieldValue),
GeoPointValue=function(_super){function GeoPointValue(internalValue){var _this=_super.call(this)||this;_this.internalValue=internalValue;_this.typeOrder=TypeOrder.GeoPointValue;return _this}tslib_1.__extends(GeoPointValue,_super);GeoPointValue.prototype.value=function(options){return this.internalValue};GeoPointValue.prototype.isEqual=function(other){return other instanceof GeoPointValue&&this.internalValue.isEqual(other.internalValue)};GeoPointValue.prototype.compareTo=function(other){return other instanceof
GeoPointValue?this.internalValue._compareTo(other.internalValue):this.defaultCompareTo(other)};return GeoPointValue}(FieldValue),ObjectValue=function(_super){function ObjectValue(internalValue){var _this=_super.call(this)||this;_this.internalValue=internalValue;_this.typeOrder=TypeOrder.ObjectValue;return _this}tslib_1.__extends(ObjectValue,_super);ObjectValue.prototype.value=function(options){var result={};this.internalValue.inorderTraversal(function(key,val){result[key]=val.value(options)});return result};
ObjectValue.prototype.forEach=function(action){this.internalValue.inorderTraversal(action)};ObjectValue.prototype.isEqual=function(other){if(other instanceof ObjectValue){var it1=this.internalValue.getIterator();for(other=other.internalValue.getIterator();it1.hasNext()&&other.hasNext();){var next1=it1.getNext(),next2=other.getNext();if(next1.key!==next2.key||!next1.value.isEqual(next2.value))return!1}return!it1.hasNext()&&!other.hasNext()}return!1};ObjectValue.prototype.compareTo=function(other){if(other instanceof
ObjectValue){var it1=this.internalValue.getIterator();for(other=other.internalValue.getIterator();it1.hasNext()&&other.hasNext();){var next1=it1.getNext(),next2=other.getNext();if(next1=primitiveComparator(next1.key,next2.key)||next1.value.compareTo(next2.value))return next1}return primitiveComparator(it1.hasNext(),other.hasNext())}return this.defaultCompareTo(other)};ObjectValue.prototype.set=function(path,to){assert(!path.isEmpty(),"Cannot set field for empty path on ObjectValue");if(1===path.length)return this.setChild(path.firstSegment(),
to);var child=this.child(path.firstSegment());child instanceof ObjectValue||(child=ObjectValue.EMPTY);to=child.set(path.popFirst(),to);return this.setChild(path.firstSegment(),to)};ObjectValue.prototype.delete=function(path){assert(!path.isEmpty(),"Cannot delete field for empty path on ObjectValue");if(1===path.length)return new ObjectValue(this.internalValue.remove(path.firstSegment()));var child=this.child(path.firstSegment());return child instanceof ObjectValue?(child=child.delete(path.popFirst()),
new ObjectValue(this.internalValue.insert(path.firstSegment(),child))):this};ObjectValue.prototype.contains=function(path){return void 0!==this.field(path)};ObjectValue.prototype.field=function(path){assert(!path.isEmpty(),"Can't get field of empty path");var field=this;path.forEach(function(pathSegment){field=field instanceof ObjectValue?field.internalValue.get(pathSegment)||void 0:void 0});return field};ObjectValue.prototype.toString=function(){return JSON.stringify(this.value())};ObjectValue.prototype.child=
function(childName){return this.internalValue.get(childName)||void 0};ObjectValue.prototype.setChild=function(childName,value){return new ObjectValue(this.internalValue.insert(childName,value))};ObjectValue.EMPTY=new ObjectValue(new SortedMap$jscomp$0(primitiveComparator));return ObjectValue}(FieldValue),ArrayValue=function(_super){function ArrayValue(internalValue){var _this=_super.call(this)||this;_this.internalValue=internalValue;_this.typeOrder=TypeOrder.ArrayValue;return _this}tslib_1.__extends(ArrayValue,
_super);ArrayValue.prototype.value=function(options){return this.internalValue.map(function(v){return v.value(options)})};ArrayValue.prototype.forEach=function(action){this.internalValue.forEach(action)};ArrayValue.prototype.isEqual=function(other){if(other instanceof ArrayValue){if(this.internalValue.length!==other.internalValue.length)return!1;for(var i=0;i<this.internalValue.length;i++)if(!this.internalValue[i].isEqual(other.internalValue[i]))return!1;return!0}return!1};ArrayValue.prototype.compareTo=
function(other){if(other instanceof ArrayValue){for(var minLength=Math.min(this.internalValue.length,other.internalValue.length),i=0;i<minLength;i++){var cmp=this.internalValue[i].compareTo(other.internalValue[i]);if(cmp)return cmp}return primitiveComparator(this.internalValue.length,other.internalValue.length)}return this.defaultCompareTo(other)};ArrayValue.prototype.toString=function(){return JSON.stringify(this.value())};return ArrayValue}(FieldValue),NumberAsAny=Number,MIN_SAFE_INTEGER=NumberAsAny.MIN_SAFE_INTEGER||
-(Math.pow(2,53)-1),MAX_SAFE_INTEGER=NumberAsAny.MAX_SAFE_INTEGER||Math.pow(2,53)-1,isInteger=NumberAsAny.isInteger||function(value){return"number"===typeof value&&isFinite(value)&&Math.floor(value)===value},Query$jscomp$0=function(){function Query(path,explicitOrderBy,filters,limit,startAt,endAt){void 0===explicitOrderBy&&(explicitOrderBy=[]);void 0===filters&&(filters=[]);void 0===limit&&(limit=null);void 0===startAt&&(startAt=null);void 0===endAt&&(endAt=null);this.path=path;this.explicitOrderBy=
explicitOrderBy;this.filters=filters;this.limit=limit;this.startAt=startAt;this.endAt=endAt;this.memoizedOrderBy=this.memoizedCanonicalId=null;this.startAt&&this.assertValidBound(this.startAt);this.endAt&&this.assertValidBound(this.endAt)}Query.atPath=function(path){return new Query(path)};Object.defineProperty(Query.prototype,"orderBy",{get:function(){if(null===this.memoizedOrderBy){var inequalityField=this.getInequalityFilterField(),firstOrderByField=this.getFirstOrderByField();if(null!==inequalityField&&
null===firstOrderByField)inequalityField.isKeyField()?this.memoizedOrderBy=[KEY_ORDERING_ASC]:this.memoizedOrderBy=[new OrderBy(inequalityField),KEY_ORDERING_ASC];else{assert(null===inequalityField||null!==firstOrderByField&&inequalityField.isEqual(firstOrderByField),"First orderBy should match inequality field.");this.memoizedOrderBy=[];inequalityField=!1;firstOrderByField=0;for(var _a=this.explicitOrderBy;firstOrderByField<_a.length;firstOrderByField++){var orderBy=_a[firstOrderByField];this.memoizedOrderBy.push(orderBy);
orderBy.field.isKeyField()&&(inequalityField=!0)}inequalityField||this.memoizedOrderBy.push((0<this.explicitOrderBy.length?this.explicitOrderBy[this.explicitOrderBy.length-1].dir:Direction.ASCENDING)===Direction.ASCENDING?KEY_ORDERING_ASC:KEY_ORDERING_DESC)}}return this.memoizedOrderBy},enumerable:!0,configurable:!0});Query.prototype.addFilter=function(filter){assert(null==this.getInequalityFilterField()||!(filter instanceof RelationFilter)||!filter.isInequality()||filter.field.isEqual(this.getInequalityFilterField()),
"Query must only have one inequality field.");assert(!DocumentKey.isDocumentKey(this.path),"No filtering allowed for document query");filter=this.filters.concat([filter]);return new Query(this.path,this.explicitOrderBy.slice(),filter,this.limit,this.startAt,this.endAt)};Query.prototype.addOrderBy=function(orderBy){assert(!DocumentKey.isDocumentKey(this.path),"No ordering allowed for document query");assert(!this.startAt&&!this.endAt,"Bounds must be set after orderBy");orderBy=this.explicitOrderBy.concat([orderBy]);
return new Query(this.path,orderBy,this.filters.slice(),this.limit,this.startAt,this.endAt)};Query.prototype.withLimit=function(limit){return new Query(this.path,this.explicitOrderBy.slice(),this.filters.slice(),limit,this.startAt,this.endAt)};Query.prototype.withStartAt=function(bound){return new Query(this.path,this.explicitOrderBy.slice(),this.filters.slice(),this.limit,bound,this.endAt)};Query.prototype.withEndAt=function(bound){return new Query(this.path,this.explicitOrderBy.slice(),this.filters.slice(),
this.limit,this.startAt,bound)};Query.prototype.canonicalId=function(){if(null===this.memoizedCanonicalId){var canonicalId=this.path.canonicalString();canonicalId+="|f:";for(var _i=0,_a=this.filters;_i<_a.length;_i++)canonicalId+=_a[_i].canonicalId(),canonicalId+=",";canonicalId+="|ob:";_i=0;for(_a=this.orderBy;_i<_a.length;_i++)canonicalId+=_a[_i].canonicalId(),canonicalId+=",";isNullOrUndefined(this.limit)||(canonicalId=canonicalId+"|l:"+this.limit);this.startAt&&(canonicalId=canonicalId+"|lb:"+
this.startAt.canonicalId());this.endAt&&(canonicalId=canonicalId+"|ub:"+this.endAt.canonicalId());this.memoizedCanonicalId=canonicalId}return this.memoizedCanonicalId};Query.prototype.toString=function(){var str="Query("+this.path.canonicalString();0<this.filters.length&&(str+=", filters: ["+this.filters.join(", ")+"]");isNullOrUndefined(this.limit)||(str+=", limit: "+this.limit);0<this.explicitOrderBy.length&&(str+=", orderBy: ["+this.explicitOrderBy.join(", ")+"]");this.startAt&&(str+=", startAt: "+
this.startAt.canonicalId());this.endAt&&(str+=", endAt: "+this.endAt.canonicalId());return str+")"};Query.prototype.isEqual=function(other){if(this.limit!==other.limit||this.orderBy.length!==other.orderBy.length)return!1;for(var i=0;i<this.orderBy.length;i++)if(!this.orderBy[i].isEqual(other.orderBy[i]))return!1;if(this.filters.length!==other.filters.length)return!1;for(i=0;i<this.filters.length;i++)if(!this.filters[i].isEqual(other.filters[i]))return!1;return this.path.isEqual(other.path)&&(null!==
this.startAt?this.startAt.isEqual(other.startAt):null===other.startAt)?null!==this.endAt?this.endAt.isEqual(other.endAt):null===other.endAt:!1};Query.prototype.docComparator=function(d1,d2){for(var comparedOnKeyField=!1,_i=0,_a=this.orderBy;_i<_a.length;_i++){var orderBy=_a[_i],comp=orderBy.compare(d1,d2);if(0!==comp)return comp;comparedOnKeyField=comparedOnKeyField||orderBy.field.isKeyField()}assert(comparedOnKeyField,"orderBy used that doesn't compare on key field");return 0};Query.prototype.matches=
function(doc){return this.matchesAncestor(doc)&&this.matchesOrderBy(doc)&&this.matchesFilters(doc)&&this.matchesBounds(doc)};Query.prototype.hasLimit=function(){return!isNullOrUndefined(this.limit)};Query.prototype.getFirstOrderByField=function(){return 0<this.explicitOrderBy.length?this.explicitOrderBy[0].field:null};Query.prototype.getInequalityFilterField=function(){for(var _i=0,_a=this.filters;_i<_a.length;_i++){var filter=_a[_i];if(filter instanceof RelationFilter&&filter.isInequality())return filter.field}return null};
Query.prototype.hasArrayContainsFilter=function(){return void 0!==this.filters.find(function(filter){return filter instanceof RelationFilter&&filter.op===RelationOp.ARRAY_CONTAINS})};Query.prototype.isDocumentQuery=function(){return DocumentKey.isDocumentKey(this.path)&&0===this.filters.length};Query.prototype.matchesAncestor=function(doc){doc=doc.key.path;return DocumentKey.isDocumentKey(this.path)?this.path.isEqual(doc):this.path.isPrefixOf(doc)&&this.path.length===doc.length-1};Query.prototype.matchesOrderBy=
function(doc){for(var _i=0,_a=this.explicitOrderBy;_i<_a.length;_i++){var orderBy=_a[_i];if(!orderBy.field.isKeyField()&&void 0===doc.field(orderBy.field))return!1}return!0};Query.prototype.matchesFilters=function(doc){for(var _i=0,_a=this.filters;_i<_a.length;_i++)if(!_a[_i].matches(doc))return!1;return!0};Query.prototype.matchesBounds=function(doc){return this.startAt&&!this.startAt.sortsBeforeDocument(this.orderBy,doc)||this.endAt&&this.endAt.sortsBeforeDocument(this.orderBy,doc)?!1:!0};Query.prototype.assertValidBound=
function(bound){assert(bound.position.length<=this.orderBy.length,"Bound is longer than orderBy")};return Query}(),Filter=function(){function Filter(){}Filter.create=function(field,op,value){if(value.isEqual(NullValue.INSTANCE)){if(op!==RelationOp.EQUAL)throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid query. You can only perform equals comparisons on null.");return new NullFilter(field)}if(value.isEqual(DoubleValue.NAN)){if(op!==RelationOp.EQUAL)throw new FirestoreError(Code.INVALID_ARGUMENT,
"Invalid query. You can only perform equals comparisons on NaN.");return new NanFilter(field)}return new RelationFilter(field,op,value)};return Filter}(),RelationOp=function(){function RelationOp(name){this.name=name}RelationOp.fromString=function(op){switch(op){case "\x3c":return RelationOp.LESS_THAN;case "\x3c\x3d":return RelationOp.LESS_THAN_OR_EQUAL;case "\x3d\x3d":return RelationOp.EQUAL;case "\x3e\x3d":return RelationOp.GREATER_THAN_OR_EQUAL;case "\x3e":return RelationOp.GREATER_THAN;case "array-contains":return RelationOp.ARRAY_CONTAINS;
default:return fail("Unknown relation: "+op)}};RelationOp.prototype.toString=function(){return this.name};RelationOp.prototype.isEqual=function(other){return this.name===other.name};RelationOp.LESS_THAN=new RelationOp("\x3c");RelationOp.LESS_THAN_OR_EQUAL=new RelationOp("\x3c\x3d");RelationOp.EQUAL=new RelationOp("\x3d\x3d");RelationOp.GREATER_THAN=new RelationOp("\x3e");RelationOp.GREATER_THAN_OR_EQUAL=new RelationOp("\x3e\x3d");RelationOp.ARRAY_CONTAINS=new RelationOp("array-contains");return RelationOp}(),
RelationFilter=function(_super){function RelationFilter(field,op,value){var _this=_super.call(this)||this;_this.field=field;_this.op=op;_this.value=value;return _this}tslib_1.__extends(RelationFilter,_super);RelationFilter.prototype.matches=function(doc){if(this.field.isKeyField())return assert(this.value instanceof RefValue,"Comparing on key, but filter value not a RefValue"),assert(this.op!==RelationOp.ARRAY_CONTAINS,"array-contains queries don't make sense on document keys."),doc=DocumentKey.comparator(doc.key,
this.value.key),this.matchesComparison(doc);doc=doc.field(this.field);return void 0!==doc&&this.matchesValue(doc)};RelationFilter.prototype.matchesValue=function(value){var _this=this;return this.op===RelationOp.ARRAY_CONTAINS?value instanceof ArrayValue&&void 0!==value.internalValue.find(function(element){return element.isEqual(_this.value)}):this.value.typeOrder===value.typeOrder&&this.matchesComparison(value.compareTo(this.value))};RelationFilter.prototype.matchesComparison=function(comparison){switch(this.op){case RelationOp.LESS_THAN:return 0>
comparison;case RelationOp.LESS_THAN_OR_EQUAL:return 0>=comparison;case RelationOp.EQUAL:return 0===comparison;case RelationOp.GREATER_THAN:return 0<comparison;case RelationOp.GREATER_THAN_OR_EQUAL:return 0<=comparison;default:return fail("Unknown relation op"+this.op)}};RelationFilter.prototype.isInequality=function(){return this.op!==RelationOp.EQUAL&&this.op!==RelationOp.ARRAY_CONTAINS};RelationFilter.prototype.canonicalId=function(){return this.field.canonicalString()+this.op.toString()+this.value.toString()};
RelationFilter.prototype.isEqual=function(other){return other instanceof RelationFilter?this.op.isEqual(other.op)&&this.field.isEqual(other.field)&&this.value.isEqual(other.value):!1};RelationFilter.prototype.toString=function(){return this.field.canonicalString()+" "+this.op+" "+this.value.value()};return RelationFilter}(Filter),NullFilter=function(_super){function NullFilter(field){var _this=_super.call(this)||this;_this.field=field;return _this}tslib_1.__extends(NullFilter,_super);NullFilter.prototype.matches=
function(doc){doc=doc.field(this.field);return void 0!==doc&&null===doc.value()};NullFilter.prototype.canonicalId=function(){return this.field.canonicalString()+" IS null"};NullFilter.prototype.toString=function(){return this.field.canonicalString()+" IS null"};NullFilter.prototype.isEqual=function(other){return other instanceof NullFilter?this.field.isEqual(other.field):!1};return NullFilter}(Filter),NanFilter=function(_super){function NanFilter(field){var _this=_super.call(this)||this;_this.field=
field;return _this}tslib_1.__extends(NanFilter,_super);NanFilter.prototype.matches=function(doc){doc=doc.field(this.field).value();return"number"===typeof doc&&isNaN(doc)};NanFilter.prototype.canonicalId=function(){return this.field.canonicalString()+" IS NaN"};NanFilter.prototype.toString=function(){return this.field.canonicalString()+" IS NaN"};NanFilter.prototype.isEqual=function(other){return other instanceof NanFilter?this.field.isEqual(other.field):!1};return NanFilter}(Filter),Direction=function(){function Direction(name){this.name=
name}Direction.prototype.toString=function(){return this.name};Direction.ASCENDING=new Direction("asc");Direction.DESCENDING=new Direction("desc");return Direction}(),Bound=function(){function Bound(position,before){this.position=position;this.before=before}Bound.prototype.canonicalId=function(){for(var canonicalId=this.before?"b:":"a:",_i=0,_a=this.position;_i<_a.length;_i++)canonicalId+=_a[_i].toString();return canonicalId};Bound.prototype.sortsBeforeDocument=function(orderBy,doc){assert(this.position.length<=
orderBy.length,"Bound has more components than query's orderBy");for(var comparison=0,i=0;i<this.position.length;i++){var orderByComponent=orderBy[i];comparison=this.position[i];if(orderByComponent.field.isKeyField())assert(comparison instanceof RefValue,"Bound has a non-key value where the key path is being used."),comparison=DocumentKey.comparator(comparison.key,doc.key);else{var docValue=doc.field(orderByComponent.field);assert(void 0!==docValue,"Field should exist since document matched the orderBy already.");
comparison=comparison.compareTo(docValue)}orderByComponent.dir===Direction.DESCENDING&&(comparison*=-1);if(0!==comparison)break}return this.before?0>=comparison:0>comparison};Bound.prototype.isEqual=function(other){if(null===other||this.before!==other.before||this.position.length!==other.position.length)return!1;for(;0<this.position.length;)return this.position[0].isEqual(other.position[0]);return!0};return Bound}(),OrderBy=function(){function OrderBy(field,dir){this.field=field;void 0===dir&&(dir=
Direction.ASCENDING);this.dir=dir;this.isKeyOrderBy=field.isKeyField()}OrderBy.prototype.compare=function(d1,d2){d1=this.isKeyOrderBy?Document$jscomp$0.compareByKey(d1,d2):Document$jscomp$0.compareByField(this.field,d1,d2);switch(this.dir){case Direction.ASCENDING:return d1;case Direction.DESCENDING:return-1*d1;default:return fail("Unknown direction: "+this.dir)}};OrderBy.prototype.canonicalId=function(){return this.field.canonicalString()+this.dir.toString()};OrderBy.prototype.toString=function(){return this.field.canonicalString()+
" ("+this.dir+")"};OrderBy.prototype.isEqual=function(other){return this.dir===other.dir&&this.field.isEqual(other.field)};return OrderBy}(),KEY_ORDERING_ASC=new OrderBy(FieldPath.keyField(),Direction.ASCENDING),KEY_ORDERING_DESC=new OrderBy(FieldPath.keyField(),Direction.DESCENDING),SnapshotVersion=function(){function SnapshotVersion(timestamp){this.timestamp=timestamp}SnapshotVersion.fromMicroseconds=function(value){return new SnapshotVersion(new Timestamp(Math.floor(value/1E6),value%1E6*1E3))};
SnapshotVersion.fromTimestamp=function(value){return new SnapshotVersion(value)};SnapshotVersion.forDeletedDoc=function(){return SnapshotVersion.MIN};SnapshotVersion.prototype.compareTo=function(other){return this.timestamp._compareTo(other.timestamp)};SnapshotVersion.prototype.isEqual=function(other){return this.timestamp.isEqual(other.timestamp)};SnapshotVersion.prototype.toMicroseconds=function(){return 1E6*this.timestamp.seconds+this.timestamp.nanoseconds/1E3};SnapshotVersion.prototype.toString=
function(){return"SnapshotVersion("+this.timestamp.toString()+")"};SnapshotVersion.prototype.toTimestamp=function(){return this.timestamp};SnapshotVersion.MIN=new SnapshotVersion(new Timestamp(0,0));return SnapshotVersion}(),QueryPurpose;(function(QueryPurpose){QueryPurpose[QueryPurpose.Listen=0]="Listen";QueryPurpose[QueryPurpose.ExistenceFilterMismatch=1]="ExistenceFilterMismatch";QueryPurpose[QueryPurpose.LimboResolution=2]="LimboResolution"})(QueryPurpose||(QueryPurpose={}));var QueryData=function(){function QueryData(query,
targetId,purpose,snapshotVersion,resumeToken){void 0===snapshotVersion&&(snapshotVersion=SnapshotVersion.MIN);void 0===resumeToken&&(resumeToken=emptyByteString());this.query=query;this.targetId=targetId;this.purpose=purpose;this.snapshotVersion=snapshotVersion;this.resumeToken=resumeToken}QueryData.prototype.copy=function(overwrite){return new QueryData(this.query,this.targetId,this.purpose,void 0===overwrite.snapshotVersion?this.snapshotVersion:overwrite.snapshotVersion,void 0===overwrite.resumeToken?
this.resumeToken:overwrite.resumeToken)};QueryData.prototype.isEqual=function(other){return this.targetId===other.targetId&&this.purpose===other.purpose&&this.snapshotVersion.isEqual(other.snapshotVersion)&&this.resumeToken===other.resumeToken&&this.query.isEqual(other.query)};return QueryData}(),FieldMask=function(){function FieldMask(fields){this.fields=fields}FieldMask.prototype.covers=function(fieldPath){for(var _i=0,_a=this.fields;_i<_a.length;_i++)if(_a[_i].isPrefixOf(fieldPath))return!0;return!1};
FieldMask.prototype.isEqual=function(other){return arrayEquals(this.fields,other.fields)};return FieldMask}(),FieldTransform=function(){function FieldTransform(field,transform){this.field=field;this.transform=transform}FieldTransform.prototype.isEqual=function(other){return this.field.isEqual(other.field)&&this.transform.isEqual(other.transform)};return FieldTransform}(),MutationResult=function(){return function(version,transformResults){this.version=version;this.transformResults=transformResults}}(),
MutationType;(function(MutationType){MutationType[MutationType.Set=0]="Set";MutationType[MutationType.Patch=1]="Patch";MutationType[MutationType.Transform=2]="Transform";MutationType[MutationType.Delete=3]="Delete"})(MutationType||(MutationType={}));var Precondition=function(){function Precondition(updateTime,exists){this.updateTime=updateTime;this.exists=exists;assert(void 0===updateTime||void 0===exists,'Precondition can specify "exists" or "updateTime" but not both')}Precondition.exists=function(exists){return new Precondition(void 0,
exists)};Precondition.updateTime=function(version){return new Precondition(version)};Object.defineProperty(Precondition.prototype,"isNone",{get:function(){return void 0===this.updateTime&&void 0===this.exists},enumerable:!0,configurable:!0});Precondition.prototype.isValidFor=function(maybeDoc){if(void 0!==this.updateTime)return maybeDoc instanceof Document$jscomp$0&&maybeDoc.version.isEqual(this.updateTime);if(void 0!==this.exists)return this.exists?maybeDoc instanceof Document$jscomp$0:null===maybeDoc||
maybeDoc instanceof NoDocument;assert(this.isNone,"Precondition should be empty");return!0};Precondition.prototype.isEqual=function(other){var JSCompiler_inline_result=this.updateTime;var right=other.updateTime;JSCompiler_inline_result=null!==JSCompiler_inline_result&&void 0!==JSCompiler_inline_result?!(!right||!JSCompiler_inline_result.isEqual(right)):JSCompiler_inline_result===right;return JSCompiler_inline_result&&this.exists===other.exists};Precondition.NONE=new Precondition;return Precondition}(),
Mutation=function(){function Mutation(){}Mutation.prototype.verifyKeyMatches=function(maybeDoc){null!=maybeDoc&&assert(maybeDoc.key.isEqual(this.key),"Can only apply a mutation to a document with the same key")};Mutation.getPostMutationVersion=function(maybeDoc){return maybeDoc instanceof Document$jscomp$0?maybeDoc.version:SnapshotVersion.MIN};return Mutation}(),SetMutation=function(_super){function SetMutation(key,value,precondition){var _this=_super.call(this)||this;_this.key=key;_this.value=value;
_this.precondition=precondition;_this.type=MutationType.Set;return _this}tslib_1.__extends(SetMutation,_super);SetMutation.prototype.applyToRemoteDocument=function(maybeDoc,mutationResult){this.verifyKeyMatches(maybeDoc);assert(null==mutationResult.transformResults,"Transform results received by SetMutation.");maybeDoc=Mutation.getPostMutationVersion(maybeDoc);return new Document$jscomp$0(this.key,maybeDoc,this.value,{hasLocalMutations:!1})};SetMutation.prototype.applyToLocalView=function(maybeDoc,
baseDoc,localWriteTime){this.verifyKeyMatches(maybeDoc);if(!this.precondition.isValidFor(maybeDoc))return maybeDoc;maybeDoc=Mutation.getPostMutationVersion(maybeDoc);return new Document$jscomp$0(this.key,maybeDoc,this.value,{hasLocalMutations:!0})};SetMutation.prototype.isEqual=function(other){return other instanceof SetMutation&&this.key.isEqual(other.key)&&this.value.isEqual(other.value)&&this.precondition.isEqual(other.precondition)};return SetMutation}(Mutation),PatchMutation=function(_super){function PatchMutation(key,
data,fieldMask,precondition){var _this=_super.call(this)||this;_this.key=key;_this.data=data;_this.fieldMask=fieldMask;_this.precondition=precondition;_this.type=MutationType.Patch;return _this}tslib_1.__extends(PatchMutation,_super);PatchMutation.prototype.applyToRemoteDocument=function(maybeDoc,mutationResult){this.verifyKeyMatches(maybeDoc);assert(null==mutationResult.transformResults,"Transform results received by PatchMutation.");if(!this.precondition.isValidFor(maybeDoc))return maybeDoc;mutationResult=
Mutation.getPostMutationVersion(maybeDoc);maybeDoc=this.patchDocument(maybeDoc);return new Document$jscomp$0(this.key,mutationResult,maybeDoc,{hasLocalMutations:!1})};PatchMutation.prototype.applyToLocalView=function(maybeDoc,baseDoc,localWriteTime){this.verifyKeyMatches(maybeDoc);if(!this.precondition.isValidFor(maybeDoc))return maybeDoc;baseDoc=Mutation.getPostMutationVersion(maybeDoc);maybeDoc=this.patchDocument(maybeDoc);return new Document$jscomp$0(this.key,baseDoc,maybeDoc,{hasLocalMutations:!0})};
PatchMutation.prototype.isEqual=function(other){return other instanceof PatchMutation&&this.key.isEqual(other.key)&&this.fieldMask.isEqual(other.fieldMask)&&this.precondition.isEqual(other.precondition)};PatchMutation.prototype.patchDocument=function(maybeDoc){return this.patchObject(maybeDoc instanceof Document$jscomp$0?maybeDoc.data:ObjectValue.EMPTY)};PatchMutation.prototype.patchObject=function(data){for(var _i=0,_a=this.fieldMask.fields;_i<_a.length;_i++){var fieldPath=_a[_i],newValue=this.data.field(fieldPath);
data=void 0!==newValue?data.set(fieldPath,newValue):data.delete(fieldPath)}return data};return PatchMutation}(Mutation),TransformMutation=function(_super){function TransformMutation(key,fieldTransforms){var _this=_super.call(this)||this;_this.key=key;_this.fieldTransforms=fieldTransforms;_this.type=MutationType.Transform;_this.precondition=Precondition.exists(!0);return _this}tslib_1.__extends(TransformMutation,_super);TransformMutation.prototype.applyToRemoteDocument=function(maybeDoc,mutationResult){this.verifyKeyMatches(maybeDoc);
assert(null!=mutationResult.transformResults,"Transform results missing for TransformMutation.");if(!this.precondition.isValidFor(maybeDoc))return maybeDoc;var doc=this.requireDocument(maybeDoc);maybeDoc=this.serverTransformResults(maybeDoc,mutationResult.transformResults);maybeDoc=this.transformObject(doc.data,maybeDoc);return new Document$jscomp$0(this.key,doc.version,maybeDoc,{hasLocalMutations:!1})};TransformMutation.prototype.applyToLocalView=function(maybeDoc,baseDoc,localWriteTime){this.verifyKeyMatches(maybeDoc);
if(!this.precondition.isValidFor(maybeDoc))return maybeDoc;maybeDoc=this.requireDocument(maybeDoc);baseDoc=this.localTransformResults(localWriteTime,baseDoc);baseDoc=this.transformObject(maybeDoc.data,baseDoc);return new Document$jscomp$0(this.key,maybeDoc.version,baseDoc,{hasLocalMutations:!0})};TransformMutation.prototype.isEqual=function(other){return other instanceof TransformMutation&&this.key.isEqual(other.key)&&arrayEquals(this.fieldTransforms,other.fieldTransforms)&&this.precondition.isEqual(other.precondition)};
TransformMutation.prototype.requireDocument=function(maybeDoc){assert(maybeDoc instanceof Document$jscomp$0,"Unknown MaybeDocument type "+maybeDoc);assert(maybeDoc.key.isEqual(this.key),"Can only transform a document with the same key");return maybeDoc};TransformMutation.prototype.serverTransformResults=function(baseDoc,serverTransformResults){var transformResults=[];assert(this.fieldTransforms.length===serverTransformResults.length,"server transform result count ("+serverTransformResults.length+
") "+("should match field transform count ("+this.fieldTransforms.length+")"));for(var i=0;i<serverTransformResults.length;i++){var fieldTransform=this.fieldTransforms[i],transform=fieldTransform.transform,previousValue=null;baseDoc instanceof Document$jscomp$0&&(previousValue=baseDoc.field(fieldTransform.field)||null);transformResults.push(transform.applyToRemoteDocument(previousValue,serverTransformResults[i]))}return transformResults};TransformMutation.prototype.localTransformResults=function(localWriteTime,
baseDoc){for(var transformResults=[],_i=0,_a=this.fieldTransforms;_i<_a.length;_i++){var fieldTransform=_a[_i],transform=fieldTransform.transform,previousValue=null;baseDoc instanceof Document$jscomp$0&&(previousValue=baseDoc.field(fieldTransform.field)||null);transformResults.push(transform.applyToLocalView(previousValue,localWriteTime))}return transformResults};TransformMutation.prototype.transformObject=function(data,transformResults){assert(transformResults.length===this.fieldTransforms.length,
"TransformResults length mismatch.");for(var i=0;i<this.fieldTransforms.length;i++)data=data.set(this.fieldTransforms[i].field,transformResults[i]);return data};return TransformMutation}(Mutation),DeleteMutation=function(_super){function DeleteMutation(key,precondition){var _this=_super.call(this)||this;_this.key=key;_this.precondition=precondition;_this.type=MutationType.Delete;return _this}tslib_1.__extends(DeleteMutation,_super);DeleteMutation.prototype.applyToRemoteDocument=function(maybeDoc,
mutationResult){this.verifyKeyMatches(maybeDoc);assert(null==mutationResult.transformResults,"Transform results received by DeleteMutation.");return new NoDocument(this.key,SnapshotVersion.MIN)};DeleteMutation.prototype.applyToLocalView=function(maybeDoc,baseDoc,localWriteTime){this.verifyKeyMatches(maybeDoc);if(!this.precondition.isValidFor(maybeDoc))return maybeDoc;maybeDoc&&assert(maybeDoc.key.isEqual(this.key),"Can only apply mutation to document with same key");return new NoDocument(this.key,
SnapshotVersion.forDeletedDoc())};DeleteMutation.prototype.isEqual=function(other){return other instanceof DeleteMutation&&this.key.isEqual(other.key)&&this.precondition.isEqual(other.precondition)};return DeleteMutation}(Mutation),ExistenceFilter=function(){function ExistenceFilter(count){this.count=count}ExistenceFilter.prototype.isEqual=function(other){return other&&other.count===this.count};return ExistenceFilter}(),RpcCode;(function(RpcCode){RpcCode[RpcCode.OK=0]="OK";RpcCode[RpcCode.CANCELLED=
1]="CANCELLED";RpcCode[RpcCode.UNKNOWN=2]="UNKNOWN";RpcCode[RpcCode.INVALID_ARGUMENT=3]="INVALID_ARGUMENT";RpcCode[RpcCode.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED";RpcCode[RpcCode.NOT_FOUND=5]="NOT_FOUND";RpcCode[RpcCode.ALREADY_EXISTS=6]="ALREADY_EXISTS";RpcCode[RpcCode.PERMISSION_DENIED=7]="PERMISSION_DENIED";RpcCode[RpcCode.UNAUTHENTICATED=16]="UNAUTHENTICATED";RpcCode[RpcCode.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED";RpcCode[RpcCode.FAILED_PRECONDITION=9]="FAILED_PRECONDITION";RpcCode[RpcCode.ABORTED=
10]="ABORTED";RpcCode[RpcCode.OUT_OF_RANGE=11]="OUT_OF_RANGE";RpcCode[RpcCode.UNIMPLEMENTED=12]="UNIMPLEMENTED";RpcCode[RpcCode.INTERNAL=13]="INTERNAL";RpcCode[RpcCode.UNAVAILABLE=14]="UNAVAILABLE";RpcCode[RpcCode.DATA_LOSS=15]="DATA_LOSS"})(RpcCode||(RpcCode={}));var SortedSet=function(){function SortedSet(comparator){this.comparator=comparator;this.data=new SortedMap$jscomp$0(this.comparator)}SortedSet.fromMapKeys=function(map){var keys=new SortedSet(map.comparator);map.forEach(function(key){keys=
keys.add(key)});return keys};SortedSet.prototype.has=function(elem){return null!==this.data.get(elem)};SortedSet.prototype.first=function(){return this.data.minKey()};SortedSet.prototype.last=function(){return this.data.maxKey()};Object.defineProperty(SortedSet.prototype,"size",{get:function(){return this.data.size},enumerable:!0,configurable:!0});SortedSet.prototype.indexOf=function(elem){return this.data.indexOf(elem)};SortedSet.prototype.forEach=function(cb){this.data.inorderTraversal(function(k,
v){cb(k);return!1})};SortedSet.prototype.forEachInRange=function(range,cb){for(var iter=this.data.getIteratorFrom(range[0]);iter.hasNext();){var elem=iter.getNext();if(0<=this.comparator(elem.key,range[1]))break;cb(elem.key)}};SortedSet.prototype.forEachWhile=function(cb,start){for(start=void 0!==start?this.data.getIteratorFrom(start):this.data.getIterator();start.hasNext();){var elem=start.getNext();if(!cb(elem.key))break}};SortedSet.prototype.firstAfterOrEqual=function(elem){elem=this.data.getIteratorFrom(elem);
return elem.hasNext()?elem.getNext().key:null};SortedSet.prototype.add=function(elem){return this.copy(this.data.remove(elem).insert(elem,!0))};SortedSet.prototype.delete=function(elem){return this.has(elem)?this.copy(this.data.remove(elem)):this};SortedSet.prototype.isEmpty=function(){return this.data.isEmpty()};SortedSet.prototype.unionWith=function(other){var result=this;other.forEach(function(elem){result=result.add(elem)});return result};SortedSet.prototype.isEqual=function(other){if(!(other instanceof
SortedSet)||this.size!==other.size)return!1;var thisIt=this.data.getIterator();for(other=other.data.getIterator();thisIt.hasNext();){var thisElem=thisIt.getNext().key,otherElem=other.getNext().key;if(0!==this.comparator(thisElem,otherElem))return!1}return!0};SortedSet.prototype.toString=function(){var result=[];this.forEach(function(elem){return result.push(elem)});return"SortedSet("+result.toString()+")"};SortedSet.prototype.copy=function(data){var result=new SortedSet(this.comparator);result.data=
data;return result};return SortedSet}(),EMPTY_MAYBE_DOCUMENT_MAP=new SortedMap$jscomp$0(DocumentKey.comparator),EMPTY_DOCUMENT_MAP=new SortedMap$jscomp$0(DocumentKey.comparator),EMPTY_DOCUMENT_VERSION_MAP=new SortedMap$jscomp$0(DocumentKey.comparator),EMPTY_DOCUMENT_KEY_SET=new SortedSet(DocumentKey.comparator),RemoteEvent=function(){return function(snapshotVersion,targetChanges,targetMismatches,documentUpdates,resolvedLimboDocuments){this.snapshotVersion=snapshotVersion;this.targetChanges=targetChanges;
this.targetMismatches=targetMismatches;this.documentUpdates=documentUpdates;this.resolvedLimboDocuments=resolvedLimboDocuments}}(),TargetChange=function(){return function(resumeToken,current,addedDocuments,modifiedDocuments,removedDocuments){this.resumeToken=resumeToken;this.current=current;this.addedDocuments=addedDocuments;this.modifiedDocuments=modifiedDocuments;this.removedDocuments=removedDocuments}}(),ChangeType;(function(ChangeType){ChangeType[ChangeType.Added=0]="Added";ChangeType[ChangeType.Removed=
1]="Removed";ChangeType[ChangeType.Modified=2]="Modified";ChangeType[ChangeType.Metadata=3]="Metadata"})(ChangeType||(ChangeType={}));var SyncState;(function(SyncState){SyncState[SyncState.Local=0]="Local";SyncState[SyncState.Synced=1]="Synced"})(SyncState||(SyncState={}));var DocumentChangeSet=function(){function DocumentChangeSet(){this.changeMap=new SortedMap$jscomp$0(DocumentKey.comparator)}DocumentChangeSet.prototype.track=function(change){var key=change.doc.key,oldChange=this.changeMap.get(key);
oldChange?change.type!==ChangeType.Added&&oldChange.type===ChangeType.Metadata?this.changeMap=this.changeMap.insert(key,change):change.type===ChangeType.Metadata&&oldChange.type!==ChangeType.Removed?this.changeMap=this.changeMap.insert(key,{type:oldChange.type,doc:change.doc}):change.type===ChangeType.Modified&&oldChange.type===ChangeType.Modified?this.changeMap=this.changeMap.insert(key,{type:ChangeType.Modified,doc:change.doc}):change.type===ChangeType.Modified&&oldChange.type===ChangeType.Added?
this.changeMap=this.changeMap.insert(key,{type:ChangeType.Added,doc:change.doc}):change.type===ChangeType.Removed&&oldChange.type===ChangeType.Added?this.changeMap=this.changeMap.remove(key):change.type===ChangeType.Removed&&oldChange.type===ChangeType.Modified?this.changeMap=this.changeMap.insert(key,{type:ChangeType.Removed,doc:oldChange.doc}):change.type===ChangeType.Added&&oldChange.type===ChangeType.Removed?this.changeMap=this.changeMap.insert(key,{type:ChangeType.Modified,doc:change.doc}):fail("unsupported combination of changes: "+
JSON.stringify(change)+" after "+JSON.stringify(oldChange)):this.changeMap=this.changeMap.insert(key,change)};DocumentChangeSet.prototype.getChanges=function(){var changes=[];this.changeMap.inorderTraversal(function(key,change){changes.push(change)});return changes};return DocumentChangeSet}(),ViewSnapshot=function(){function ViewSnapshot(query,docs,oldDocs,docChanges,fromCache,hasPendingWrites,syncStateChanged,excludesMetadataChanges){this.query=query;this.docs=docs;this.oldDocs=oldDocs;this.docChanges=
docChanges;this.fromCache=fromCache;this.hasPendingWrites=hasPendingWrites;this.syncStateChanged=syncStateChanged;this.excludesMetadataChanges=excludesMetadataChanges}ViewSnapshot.prototype.isEqual=function(other){if(this.fromCache!==other.fromCache||this.hasPendingWrites!==other.hasPendingWrites||this.syncStateChanged!==other.syncStateChanged||!this.query.isEqual(other.query)||!this.docs.isEqual(other.docs)||!this.oldDocs.isEqual(other.oldDocs))return!1;var changes=this.docChanges;other=other.docChanges;
if(changes.length!==other.length)return!1;for(var i=0;i<changes.length;i++)if(changes[i].type!==other[i].type||!changes[i].doc.isEqual(other[i].doc))return!1;return!0};return ViewSnapshot}(),DocumentWatchChange=function(){return function(updatedTargetIds,removedTargetIds,key,newDoc){this.updatedTargetIds=updatedTargetIds;this.removedTargetIds=removedTargetIds;this.key=key;this.newDoc=newDoc}}(),ExistenceFilterChange=function(){return function(targetId,existenceFilter){this.targetId=targetId;this.existenceFilter=
existenceFilter}}(),WatchTargetChangeState;(function(WatchTargetChangeState){WatchTargetChangeState[WatchTargetChangeState.NoChange=0]="NoChange";WatchTargetChangeState[WatchTargetChangeState.Added=1]="Added";WatchTargetChangeState[WatchTargetChangeState.Removed=2]="Removed";WatchTargetChangeState[WatchTargetChangeState.Current=3]="Current";WatchTargetChangeState[WatchTargetChangeState.Reset=4]="Reset"})(WatchTargetChangeState||(WatchTargetChangeState={}));var WatchTargetChange=function(){return function(state,
targetIds,resumeToken,cause){void 0===resumeToken&&(resumeToken=emptyByteString());void 0===cause&&(cause=null);this.state=state;this.targetIds=targetIds;this.resumeToken=resumeToken;this.cause=cause}}(),TargetState=function(){function TargetState(){this.pendingResponses=0;this.documentChanges=new SortedMap$jscomp$0(DocumentKey.comparator);this._resumeToken=emptyByteString();this._current=!1;this._hasPendingChanges=!0}Object.defineProperty(TargetState.prototype,"current",{get:function(){return this._current},
enumerable:!0,configurable:!0});Object.defineProperty(TargetState.prototype,"resumeToken",{get:function(){return this._resumeToken},enumerable:!0,configurable:!0});Object.defineProperty(TargetState.prototype,"isPending",{get:function(){return 0!==this.pendingResponses},enumerable:!0,configurable:!0});Object.defineProperty(TargetState.prototype,"hasPendingChanges",{get:function(){return this._hasPendingChanges},enumerable:!0,configurable:!0});TargetState.prototype.updateResumeToken=function(resumeToken){0<
resumeToken.length&&(this._hasPendingChanges=!0,this._resumeToken=resumeToken)};TargetState.prototype.toTargetChange=function(){var addedDocuments=EMPTY_DOCUMENT_KEY_SET,modifiedDocuments=EMPTY_DOCUMENT_KEY_SET,removedDocuments=EMPTY_DOCUMENT_KEY_SET;this.documentChanges.forEach(function(key,changeType){switch(changeType){case ChangeType.Added:addedDocuments=addedDocuments.add(key);break;case ChangeType.Modified:modifiedDocuments=modifiedDocuments.add(key);break;case ChangeType.Removed:removedDocuments=
removedDocuments.add(key);break;default:fail("Encountered invalid change type: "+changeType)}});return new TargetChange(this._resumeToken,this._current,addedDocuments,modifiedDocuments,removedDocuments)};TargetState.prototype.clearPendingChanges=function(){this._hasPendingChanges=!1;this.documentChanges=new SortedMap$jscomp$0(DocumentKey.comparator)};TargetState.prototype.addDocumentChange=function(key,changeType){this._hasPendingChanges=!0;this.documentChanges=this.documentChanges.insert(key,changeType)};
TargetState.prototype.removeDocumentChange=function(key){this._hasPendingChanges=!0;this.documentChanges=this.documentChanges.remove(key)};TargetState.prototype.recordPendingTargetRequest=function(){this.pendingResponses+=1};TargetState.prototype.recordTargetResponse=function(){--this.pendingResponses};TargetState.prototype.markCurrent=function(){this._current=this._hasPendingChanges=!0};return TargetState}(),WatchChangeAggregator=function(){function WatchChangeAggregator(metadataProvider){this.metadataProvider=
metadataProvider;this.targetStates={};this.pendingDocumentUpdates=EMPTY_MAYBE_DOCUMENT_MAP;this.pendingDocumentTargetMapping=new SortedMap$jscomp$0(DocumentKey.comparator);this.pendingTargetResets=new SortedSet(primitiveComparator)}WatchChangeAggregator.prototype.handleDocumentChange=function(docChange){for(var _i=0,_a=docChange.updatedTargetIds;_i<_a.length;_i++){var targetId=_a[_i];docChange.newDoc instanceof Document$jscomp$0?this.addDocumentToTarget(targetId,docChange.newDoc):docChange.newDoc instanceof
NoDocument&&this.removeDocumentFromTarget(targetId,docChange.key,docChange.newDoc)}_i=0;for(_a=docChange.removedTargetIds;_i<_a.length;_i++)targetId=_a[_i],this.removeDocumentFromTarget(targetId,docChange.key,docChange.newDoc)};WatchChangeAggregator.prototype.handleTargetChange=function(targetChange){var _this=this;this.forEachTarget(targetChange,function(targetId){var targetState=_this.ensureTargetState(targetId);switch(targetChange.state){case WatchTargetChangeState.NoChange:_this.isActiveTarget(targetId)&&
targetState.updateResumeToken(targetChange.resumeToken);break;case WatchTargetChangeState.Added:targetState.recordTargetResponse();targetState.isPending||targetState.clearPendingChanges();targetState.updateResumeToken(targetChange.resumeToken);break;case WatchTargetChangeState.Removed:targetState.recordTargetResponse();targetState.isPending||_this.removeTarget(targetId);assert(!targetChange.cause,"WatchChangeAggregator does not handle errored targets");break;case WatchTargetChangeState.Current:_this.isActiveTarget(targetId)&&
(targetState.markCurrent(),targetState.updateResumeToken(targetChange.resumeToken));break;case WatchTargetChangeState.Reset:_this.isActiveTarget(targetId)&&(_this.resetTarget(targetId),targetState.updateResumeToken(targetChange.resumeToken));break;default:fail("Unknown target watch change state: "+targetChange.state)}})};WatchChangeAggregator.prototype.forEachTarget=function(targetChange,fn){0<targetChange.targetIds.length?targetChange.targetIds.forEach(fn):forEachNumber(this.targetStates,fn)};WatchChangeAggregator.prototype.handleExistenceFilter=
function(watchChange){var targetId=watchChange.targetId;watchChange=watchChange.existenceFilter.count;var queryData=this.queryDataForActiveTarget(targetId);queryData&&(queryData=queryData.query,queryData.isDocumentQuery()?0===watchChange?(watchChange=new DocumentKey(queryData.path),this.removeDocumentFromTarget(targetId,watchChange,new NoDocument(watchChange,SnapshotVersion.forDeletedDoc()))):assert(1===watchChange,"Single document existence filter with count: "+watchChange):this.getCurrentDocumentCountForTarget(targetId)!==
watchChange&&(this.resetTarget(targetId),this.pendingTargetResets=this.pendingTargetResets.add(targetId)))};WatchChangeAggregator.prototype.createRemoteEvent=function(snapshotVersion){var _this=this,targetChanges={};forEachNumber(this.targetStates,function(targetId,targetState){var queryData=_this.queryDataForActiveTarget(targetId);queryData&&(targetState.current&&queryData.query.isDocumentQuery()&&(queryData=new DocumentKey(queryData.query.path),null!==_this.pendingDocumentUpdates.get(queryData)||
_this.targetContainsDocument(targetId,queryData)||_this.removeDocumentFromTarget(targetId,queryData,new NoDocument(queryData,snapshotVersion))),targetState.hasPendingChanges&&(targetChanges[targetId]=targetState.toTargetChange(),targetState.clearPendingChanges()))});var resolvedLimboDocuments=EMPTY_DOCUMENT_KEY_SET;this.pendingDocumentTargetMapping.forEach(function(key,targets){var isOnlyLimboTarget=!0;targets.forEachWhile(function(targetId){return(targetId=_this.queryDataForActiveTarget(targetId))&&
targetId.purpose!==QueryPurpose.LimboResolution?isOnlyLimboTarget=!1:!0});isOnlyLimboTarget&&(resolvedLimboDocuments=resolvedLimboDocuments.add(key))});var remoteEvent=new RemoteEvent(snapshotVersion,targetChanges,this.pendingTargetResets,this.pendingDocumentUpdates,resolvedLimboDocuments);this.pendingDocumentUpdates=EMPTY_MAYBE_DOCUMENT_MAP;this.pendingDocumentTargetMapping=new SortedMap$jscomp$0(DocumentKey.comparator);this.pendingTargetResets=new SortedSet(primitiveComparator);return remoteEvent};
WatchChangeAggregator.prototype.addDocumentToTarget=function(targetId,document){if(this.isActiveTarget(targetId)){var changeType=this.targetContainsDocument(targetId,document.key)?ChangeType.Modified:ChangeType.Added;this.ensureTargetState(targetId).addDocumentChange(document.key,changeType);this.pendingDocumentUpdates=this.pendingDocumentUpdates.insert(document.key,document);this.pendingDocumentTargetMapping=this.pendingDocumentTargetMapping.insert(document.key,this.ensureDocumentTargetMapping(document.key).add(targetId))}};
WatchChangeAggregator.prototype.removeDocumentFromTarget=function(targetId,key,updatedDocument){if(this.isActiveTarget(targetId)){var targetState=this.ensureTargetState(targetId);this.targetContainsDocument(targetId,key)?targetState.addDocumentChange(key,ChangeType.Removed):targetState.removeDocumentChange(key);this.pendingDocumentTargetMapping=this.pendingDocumentTargetMapping.insert(key,this.ensureDocumentTargetMapping(key).delete(targetId));updatedDocument&&(this.pendingDocumentUpdates=this.pendingDocumentUpdates.insert(key,
updatedDocument))}};WatchChangeAggregator.prototype.removeTarget=function(targetId){delete this.targetStates[targetId]};WatchChangeAggregator.prototype.getCurrentDocumentCountForTarget=function(targetId){var targetChange=this.ensureTargetState(targetId).toTargetChange();return this.metadataProvider.getRemoteKeysForTarget(targetId).size+targetChange.addedDocuments.size-targetChange.removedDocuments.size};WatchChangeAggregator.prototype.recordPendingTargetRequest=function(targetId){this.ensureTargetState(targetId).recordPendingTargetRequest()};
WatchChangeAggregator.prototype.ensureTargetState=function(targetId){this.targetStates[targetId]||(this.targetStates[targetId]=new TargetState);return this.targetStates[targetId]};WatchChangeAggregator.prototype.ensureDocumentTargetMapping=function(key){var targetMapping=this.pendingDocumentTargetMapping.get(key);targetMapping||(targetMapping=new SortedSet(primitiveComparator),this.pendingDocumentTargetMapping=this.pendingDocumentTargetMapping.insert(key,targetMapping));return targetMapping};WatchChangeAggregator.prototype.isActiveTarget=
function(targetId){return null!==this.queryDataForActiveTarget(targetId)};WatchChangeAggregator.prototype.queryDataForActiveTarget=function(targetId){var targetState=this.targetStates[targetId];return targetState&&targetState.isPending?null:this.metadataProvider.getQueryDataForTarget(targetId)};WatchChangeAggregator.prototype.resetTarget=function(targetId){var _this=this;assert(!this.targetStates[targetId].isPending,"Should only reset active targets");this.targetStates[targetId]=new TargetState;this.metadataProvider.getRemoteKeysForTarget(targetId).forEach(function(key){_this.removeDocumentFromTarget(targetId,
key)})};WatchChangeAggregator.prototype.targetContainsDocument=function(targetId,key){return this.metadataProvider.getRemoteKeysForTarget(targetId).has(key)};return WatchChangeAggregator}(),ServerTimestampTransform=function(){function ServerTimestampTransform(){}ServerTimestampTransform.prototype.applyToLocalView=function(previousValue,localWriteTime){return new ServerTimestampValue(localWriteTime,previousValue)};ServerTimestampTransform.prototype.applyToRemoteDocument=function(previousValue,transformResult){return transformResult};
ServerTimestampTransform.prototype.isEqual=function(other){return other instanceof ServerTimestampTransform};ServerTimestampTransform.instance=new ServerTimestampTransform;return ServerTimestampTransform}(),ArrayUnionTransformOperation=function(){function ArrayUnionTransformOperation(elements){this.elements=elements}ArrayUnionTransformOperation.prototype.applyToLocalView=function(previousValue,localWriteTime){return this.apply(previousValue)};ArrayUnionTransformOperation.prototype.applyToRemoteDocument=
function(previousValue,transformResult){return this.apply(previousValue)};ArrayUnionTransformOperation.prototype.apply=function(previousValue){var result=previousValue instanceof ArrayValue?previousValue.internalValue.slice():[];previousValue=function(toUnion){result.find(function(element){return element.isEqual(toUnion)})||result.push(toUnion)};for(var _i=0,_a=this.elements;_i<_a.length;_i++)previousValue(_a[_i]);return new ArrayValue(result)};ArrayUnionTransformOperation.prototype.isEqual=function(other){return other instanceof
ArrayUnionTransformOperation&&arrayEquals(other.elements,this.elements)};return ArrayUnionTransformOperation}(),ArrayRemoveTransformOperation=function(){function ArrayRemoveTransformOperation(elements){this.elements=elements}ArrayRemoveTransformOperation.prototype.applyToLocalView=function(previousValue,localWriteTime){return this.apply(previousValue)};ArrayRemoveTransformOperation.prototype.applyToRemoteDocument=function(previousValue,transformResult){return this.apply(previousValue)};ArrayRemoveTransformOperation.prototype.apply=
function(previousValue){var result=previousValue instanceof ArrayValue?previousValue.internalValue.slice():[];previousValue=function(toRemove){result=result.filter(function(element){return!element.isEqual(toRemove)})};for(var _i=0,_a=this.elements;_i<_a.length;_i++)previousValue(_a[_i]);return new ArrayValue(result)};ArrayRemoveTransformOperation.prototype.isEqual=function(other){return other instanceof ArrayRemoveTransformOperation&&arrayEquals(other.elements,this.elements)};return ArrayRemoveTransformOperation}(),
DIRECTIONS=function(){var dirs={};dirs[Direction.ASCENDING.name]="ASCENDING";dirs[Direction.DESCENDING.name]="DESCENDING";return dirs}(),OPERATORS=function(){var ops={};ops[RelationOp.LESS_THAN.name]="LESS_THAN";ops[RelationOp.LESS_THAN_OR_EQUAL.name]="LESS_THAN_OR_EQUAL";ops[RelationOp.GREATER_THAN.name]="GREATER_THAN";ops[RelationOp.GREATER_THAN_OR_EQUAL.name]="GREATER_THAN_OR_EQUAL";ops[RelationOp.EQUAL.name]="EQUAL";ops[RelationOp.ARRAY_CONTAINS.name]="ARRAY_CONTAINS";return ops}(),ISO_REG_EXP=
new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/),JsonProtoSerializer=function(){function JsonProtoSerializer(databaseId,options){this.databaseId=databaseId;this.options=options}JsonProtoSerializer.prototype.emptyByteString=function(){return this.options.useProto3Json?"":new Uint8Array(0)};JsonProtoSerializer.prototype.unsafeCastProtoByteString=function(byteString){return byteString};JsonProtoSerializer.prototype.fromRpcStatus=function(status){var code=void 0===status.code?Code.UNKNOWN:
mapCodeFromRpcCode(status.code);return new FirestoreError(code,status.message||"")};JsonProtoSerializer.prototype.toInt32Value=function(val){if(!isNullOrUndefined(val))return{value:val}};JsonProtoSerializer.prototype.fromInt32Value=function(val){val="object"===typeof val?val.value:val;return isNullOrUndefined(val)?null:val};JsonProtoSerializer.prototype.toTimestamp=function(timestamp){return{seconds:timestamp.seconds,nanos:timestamp.nanoseconds}};JsonProtoSerializer.prototype.fromTimestamp=function(date){if("string"===
typeof date)return this.fromIso8601String(date);assert(!!date,"Cannot deserialize null or undefined timestamp.");var seconds=parseInt64(date.seconds||"0");return new Timestamp(seconds,date.nanos||0)};JsonProtoSerializer.prototype.fromIso8601String=function(utc){var nanos=0,fraction=ISO_REG_EXP.exec(utc);assert(!!fraction,"invalid timestamp: "+utc);fraction[1]&&(nanos=fraction[1],nanos=(nanos+"000000000").substr(0,9),nanos=Number(nanos));utc=Math.floor((new Date(utc)).getTime()/1E3);return new Timestamp(utc,
nanos)};JsonProtoSerializer.prototype.toBytes=function(bytes){return this.options.useProto3Json?bytes.toBase64():this.unsafeCastProtoByteString(bytes.toUint8Array())};JsonProtoSerializer.prototype.fromBlob=function(blob){if("string"===typeof blob)return assert(this.options.useProto3Json,"Expected bytes to be passed in as Uint8Array, but got a string instead."),Blob$jscomp$0.fromBase64String(blob);assert(!this.options.useProto3Json,"Expected bytes to be passed in as string, but got something else instead.");
return Blob$jscomp$0.fromUint8Array(blob)};JsonProtoSerializer.prototype.toVersion=function(version){return this.toTimestamp(version.toTimestamp())};JsonProtoSerializer.prototype.fromVersion=function(version){assert(!!version,"Trying to deserialize version that isn't set");return SnapshotVersion.fromTimestamp(this.fromTimestamp(version))};JsonProtoSerializer.prototype.toResourceName=function(databaseId,path){return this.fullyQualifiedPrefixPath(databaseId).child("documents").child(path).canonicalString()};
JsonProtoSerializer.prototype.fromResourceName=function(name){name=ResourcePath.fromString(name);assert(this.isValidResourceName(name),"Tried to deserialize invalid key "+name.toString());return name};JsonProtoSerializer.prototype.toName=function(key){return this.toResourceName(this.databaseId,key.path)};JsonProtoSerializer.prototype.fromName=function(name){name=this.fromResourceName(name);assert(name.get(1)===this.databaseId.projectId,"Tried to deserialize key from different project: "+name.get(1)+
" vs "+this.databaseId.projectId);assert(!name.get(3)&&!this.databaseId.database||name.get(3)===this.databaseId.database,"Tried to deserialize key from different database: "+name.get(3)+" vs "+this.databaseId.database);return new DocumentKey(this.extractLocalPathFromResourceName(name))};JsonProtoSerializer.prototype.toQueryPath=function(path){return 0===path.length?this.encodedDatabaseId:this.toResourceName(this.databaseId,path)};JsonProtoSerializer.prototype.fromQueryPath=function(name){name=this.fromResourceName(name);
return 4===name.length?ResourcePath.EMPTY_PATH:this.extractLocalPathFromResourceName(name)};Object.defineProperty(JsonProtoSerializer.prototype,"encodedDatabaseId",{get:function(){return(new ResourcePath(["projects",this.databaseId.projectId,"databases",this.databaseId.database])).canonicalString()},enumerable:!0,configurable:!0});JsonProtoSerializer.prototype.fullyQualifiedPrefixPath=function(databaseId){return new ResourcePath(["projects",databaseId.projectId,"databases",databaseId.database])};
JsonProtoSerializer.prototype.extractLocalPathFromResourceName=function(resourceName){assert(4<resourceName.length&&"documents"===resourceName.get(4),"tried to deserialize invalid key "+resourceName.toString());return resourceName.popFirst(5)};JsonProtoSerializer.prototype.isValidResourceName=function(path){return 4<=path.length&&"projects"===path.get(0)&&"databases"===path.get(2)};JsonProtoSerializer.prototype.toValue=function(val){if(val instanceof NullValue)return{nullValue:"NULL_VALUE"};if(val instanceof
BooleanValue)return{booleanValue:val.value()};if(val instanceof IntegerValue)return{integerValue:""+val.value()};if(val instanceof DoubleValue){var doubleValue=val.value();if(this.options.useProto3Json){if(isNaN(doubleValue))return{doubleValue:"NaN"};if(Infinity===doubleValue)return{doubleValue:"Infinity"};if(-Infinity===doubleValue)return{doubleValue:"-Infinity"}}return{doubleValue:val.value()}}return val instanceof StringValue?{stringValue:val.value()}:val instanceof ObjectValue?{mapValue:this.toMapValue(val)}:
val instanceof ArrayValue?{arrayValue:this.toArrayValue(val)}:val instanceof TimestampValue?{timestampValue:this.toTimestamp(val.internalValue)}:val instanceof GeoPointValue?{geoPointValue:{latitude:val.value().latitude,longitude:val.value().longitude}}:val instanceof BlobValue?{bytesValue:this.toBytes(val.value())}:val instanceof RefValue?{referenceValue:this.toResourceName(val.databaseId,val.key.path)}:fail("Unknown FieldValue "+JSON.stringify(val))};JsonProtoSerializer.prototype.fromValue=function(obj){var _this=
this,type=obj.value_type;if(hasTag(obj,type,"nullValue"))return NullValue.INSTANCE;if(hasTag(obj,type,"booleanValue"))return BooleanValue.of(obj.booleanValue);if(hasTag(obj,type,"integerValue"))return new IntegerValue(parseInt64(obj.integerValue));if(hasTag(obj,type,"doubleValue")){if(this.options.useProto3Json){if("NaN"===obj.doubleValue)return DoubleValue.NAN;if("Infinity"===obj.doubleValue)return DoubleValue.POSITIVE_INFINITY;if("-Infinity"===obj.doubleValue)return DoubleValue.NEGATIVE_INFINITY}return new DoubleValue(obj.doubleValue)}return hasTag(obj,
type,"stringValue")?new StringValue(obj.stringValue):hasTag(obj,type,"mapValue")?this.fromFields(obj.mapValue.fields||{}):hasTag(obj,type,"arrayValue")?(assertPresent(obj.arrayValue,"arrayValue"),new ArrayValue((obj.arrayValue.values||[]).map(function(v){return _this.fromValue(v)}))):hasTag(obj,type,"timestampValue")?(assertPresent(obj.timestampValue,"timestampValue"),new TimestampValue(this.fromTimestamp(obj.timestampValue))):hasTag(obj,type,"geoPointValue")?(assertPresent(obj.geoPointValue,"geoPointValue"),
new GeoPointValue(new GeoPoint(obj.geoPointValue.latitude||0,obj.geoPointValue.longitude||0))):hasTag(obj,type,"bytesValue")?(assertPresent(obj.bytesValue,"bytesValue"),obj=this.fromBlob(obj.bytesValue),new BlobValue(obj)):hasTag(obj,type,"referenceValue")?(assertPresent(obj.referenceValue,"referenceValue"),type=this.fromResourceName(obj.referenceValue),obj=new DatabaseId(type.get(1),type.get(3)),type=new DocumentKey(this.extractLocalPathFromResourceName(type)),new RefValue(obj,type)):fail("Unknown Value proto "+
JSON.stringify(obj))};JsonProtoSerializer.prototype.toMutationDocument=function(key,fields){return{name:this.toName(key),fields:this.toFields(fields)}};JsonProtoSerializer.prototype.toDocument=function(document){assert(!document.hasLocalMutations,"Can't serialize documents with mutations.");return{name:this.toName(document.key),fields:this.toFields(document.data),updateTime:this.toTimestamp(document.version.toTimestamp())}};JsonProtoSerializer.prototype.fromDocument=function(document){return new Document$jscomp$0(this.fromName(document.name),
this.fromVersion(document.updateTime),this.fromFields(document.fields||{}),{hasLocalMutations:!1})};JsonProtoSerializer.prototype.toFields=function(fields){var _this=this,result={};fields.forEach(function(key,value){result[key]=_this.toValue(value)});return result};JsonProtoSerializer.prototype.fromFields=function(object){var _this=this,result=ObjectValue.EMPTY;forEach(object,function(key,value){result=result.set(new FieldPath([key]),_this.fromValue(value))});return result};JsonProtoSerializer.prototype.toMapValue=
function(map){return{fields:this.toFields(map)}};JsonProtoSerializer.prototype.toArrayValue=function(array){var _this=this,result=[];array.forEach(function(value){result.push(_this.toValue(value))});return{values:result}};JsonProtoSerializer.prototype.fromFound=function(doc){assert(!!doc.found,"Tried to deserialize a found document from a missing document.");assertPresent(doc.found.name,"doc.found.name");assertPresent(doc.found.updateTime,"doc.found.updateTime");var key=this.fromName(doc.found.name),
version=this.fromVersion(doc.found.updateTime);doc=this.fromFields(doc.found.fields||{});return new Document$jscomp$0(key,version,doc,{hasLocalMutations:!1})};JsonProtoSerializer.prototype.fromMissing=function(result){assert(!!result.missing,"Tried to deserialize a missing document from a found document.");assert(!!result.readTime,"Tried to deserialize a missing document without a read time.");var key=this.fromName(result.missing);result=this.fromVersion(result.readTime);return new NoDocument(key,
result)};JsonProtoSerializer.prototype.fromMaybeDocument=function(result){var type=result.result;return hasTag(result,type,"found")?this.fromFound(result):hasTag(result,type,"missing")?this.fromMissing(result):fail("invalid batch get response: "+JSON.stringify(result))};JsonProtoSerializer.prototype.toWatchTargetChangeState=function(state){switch(state){case WatchTargetChangeState.Added:return"ADD";case WatchTargetChangeState.Current:return"CURRENT";case WatchTargetChangeState.NoChange:return"NO_CHANGE";
case WatchTargetChangeState.Removed:return"REMOVE";case WatchTargetChangeState.Reset:return"RESET";default:return fail("Unknown WatchTargetChangeState: "+state)}};JsonProtoSerializer.prototype.toTestWatchChange=function(watchChange){if(watchChange instanceof ExistenceFilterChange)return{filter:{count:watchChange.existenceFilter.count,targetId:watchChange.targetId}};if(watchChange instanceof DocumentWatchChange){if(watchChange.newDoc instanceof Document$jscomp$0){var doc=watchChange.newDoc;return{documentChange:{document:{name:this.toName(doc.key),
fields:this.toFields(doc.data),updateTime:this.toVersion(doc.version)},targetIds:watchChange.updatedTargetIds,removedTargetIds:watchChange.removedTargetIds}}}if(watchChange.newDoc instanceof NoDocument)return doc=watchChange.newDoc,{documentDelete:{document:this.toName(doc.key),readTime:this.toVersion(doc.version),removedTargetIds:watchChange.removedTargetIds}};if(null===watchChange.newDoc)return{documentRemove:{document:this.toName(watchChange.key),removedTargetIds:watchChange.removedTargetIds}}}return watchChange instanceof
WatchTargetChange?(doc=void 0,watchChange.cause&&(doc={code:mapRpcCodeFromCode(watchChange.cause.code),message:watchChange.cause.message}),{targetChange:{targetChangeType:this.toWatchTargetChangeState(watchChange.state),targetIds:watchChange.targetIds,resumeToken:this.unsafeCastProtoByteString(watchChange.resumeToken),cause:doc}}):fail("Unrecognized watch change: "+JSON.stringify(watchChange))};JsonProtoSerializer.prototype.fromWatchChange=function(change){var type=change.response_type;if(hasTag(change,
type,"targetChange")){assertPresent(change.targetChange,"targetChange");type=this.fromWatchTargetChangeState(change.targetChange.targetChangeType||"NO_CHANGE");var targetIds=change.targetChange.targetIds||[],resumeToken=change.targetChange.resumeToken||this.emptyByteString();change=(change=change.targetChange.cause)&&this.fromRpcStatus(change);type=new WatchTargetChange(type,targetIds,resumeToken,change||null)}else if(hasTag(change,type,"documentChange"))assertPresent(change.documentChange,"documentChange"),
assertPresent(change.documentChange.document,"documentChange.name"),assertPresent(change.documentChange.document.name,"documentChange.document.name"),assertPresent(change.documentChange.document.updateTime,"documentChange.document.updateTime"),targetIds=change.documentChange,type=this.fromName(targetIds.document.name),resumeToken=this.fromVersion(targetIds.document.updateTime),change=this.fromFields(targetIds.document.fields||{}),type=new Document$jscomp$0(type,resumeToken,change,{hasLocalMutations:!1}),
resumeToken=targetIds.removedTargetIds||[],type=new DocumentWatchChange(targetIds.targetIds||[],resumeToken,type.key,type);else if(hasTag(change,type,"documentDelete"))assertPresent(change.documentDelete,"documentDelete"),assertPresent(change.documentDelete.document,"documentDelete.document"),targetIds=change.documentDelete,type=this.fromName(targetIds.document),resumeToken=targetIds.readTime?this.fromVersion(targetIds.readTime):SnapshotVersion.forDeletedDoc(),type=new NoDocument(type,resumeToken),
resumeToken=targetIds.removedTargetIds||[],type=new DocumentWatchChange([],resumeToken,type.key,type);else if(hasTag(change,type,"documentRemove"))assertPresent(change.documentRemove,"documentRemove"),assertPresent(change.documentRemove.document,"documentRemove"),targetIds=change.documentRemove,type=this.fromName(targetIds.document),resumeToken=targetIds.removedTargetIds||[],type=new DocumentWatchChange([],resumeToken,type,null);else if(hasTag(change,type,"filter"))assertPresent(change.filter,"filter"),
assertPresent(change.filter.targetId,"filter.targetId"),type=change.filter,targetIds=new ExistenceFilter(type.count||0),type=new ExistenceFilterChange(type.targetId,targetIds);else return fail("Unknown change type "+JSON.stringify(change));return type};JsonProtoSerializer.prototype.fromWatchTargetChangeState=function(state){return"NO_CHANGE"===state?WatchTargetChangeState.NoChange:"ADD"===state?WatchTargetChangeState.Added:"REMOVE"===state?WatchTargetChangeState.Removed:"CURRENT"===state?WatchTargetChangeState.Current:
"RESET"===state?WatchTargetChangeState.Reset:fail("Got unexpected TargetChange.state: "+state)};JsonProtoSerializer.prototype.versionFromListenResponse=function(change){if(!hasTag(change,change.response_type,"targetChange"))return SnapshotVersion.MIN;change=change.targetChange;return change.targetIds&&change.targetIds.length||!change.readTime?SnapshotVersion.MIN:this.fromVersion(change.readTime)};JsonProtoSerializer.prototype.toMutation=function(mutation){var _this=this;if(mutation instanceof SetMutation)var result=
{update:this.toMutationDocument(mutation.key,mutation.value)};else if(mutation instanceof DeleteMutation)result={delete:this.toName(mutation.key)};else if(mutation instanceof PatchMutation)result={update:this.toMutationDocument(mutation.key,mutation.data),updateMask:this.toDocumentMask(mutation.fieldMask)};else if(mutation instanceof TransformMutation)result={transform:{document:this.toName(mutation.key),fieldTransforms:mutation.fieldTransforms.map(function(transform){return _this.toFieldTransform(transform)})}};
else return fail("Unknown mutation type "+mutation.type);mutation.precondition.isNone||(result.currentDocument=this.toPrecondition(mutation.precondition));return result};JsonProtoSerializer.prototype.fromMutation=function(proto){var _this=this,precondition=proto.currentDocument?this.fromPrecondition(proto.currentDocument):Precondition.NONE;if(proto.update){assertPresent(proto.update.name,"name");var key=this.fromName(proto.update.name),value=this.fromFields(proto.update.fields||{});return proto.updateMask?
(proto=this.fromDocumentMask(proto.updateMask),new PatchMutation(key,value,proto,precondition)):new SetMutation(key,value,precondition)}return proto.delete?(key=this.fromName(proto.delete),new DeleteMutation(key,precondition)):proto.transform?(key=this.fromName(proto.transform.document),value=proto.transform.fieldTransforms.map(function(transform){return _this.fromFieldTransform(transform)}),assert(!0===precondition.exists,'Transforms only support precondition "exists \x3d\x3d true"'),new TransformMutation(key,
value)):fail("unknown mutation proto: "+JSON.stringify(proto))};JsonProtoSerializer.prototype.toPrecondition=function(precondition){assert(!precondition.isNone,"Can't serialize an empty precondition");return void 0!==precondition.updateTime?{updateTime:this.toVersion(precondition.updateTime)}:void 0!==precondition.exists?{exists:precondition.exists}:fail("Unknown precondition")};JsonProtoSerializer.prototype.fromPrecondition=function(precondition){return void 0!==precondition.updateTime?Precondition.updateTime(this.fromVersion(precondition.updateTime)):
void 0!==precondition.exists?Precondition.exists(precondition.exists):Precondition.NONE};JsonProtoSerializer.prototype.fromWriteResult=function(proto){var _this=this,version=proto.updateTime?this.fromVersion(proto.updateTime):null,transformResults=null;proto.transformResults&&0<proto.transformResults.length&&(transformResults=proto.transformResults.map(function(result){return _this.fromValue(result)}));return new MutationResult(version,transformResults)};JsonProtoSerializer.prototype.fromWriteResults=
function(protos){var _this=this;return(protos||[]).map(function(proto){return _this.fromWriteResult(proto)})};JsonProtoSerializer.prototype.toFieldTransform=function(fieldTransform){var _this=this,transform=fieldTransform.transform;if(transform instanceof ServerTimestampTransform)return{fieldPath:fieldTransform.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(transform instanceof ArrayUnionTransformOperation)return{fieldPath:fieldTransform.field.canonicalString(),appendMissingElements:{values:transform.elements.map(function(v){return _this.toValue(v)})}};
if(transform instanceof ArrayRemoveTransformOperation)return{fieldPath:fieldTransform.field.canonicalString(),removeAllFromArray:{values:transform.elements.map(function(v){return _this.toValue(v)})}};fail("Unknown transform: "+fieldTransform.transform)};JsonProtoSerializer.prototype.fromFieldTransform=function(proto){var _this=this,type=proto.transform_type,transform=null;hasTag(proto,type,"setToServerValue")?(assert("REQUEST_TIME"===proto.setToServerValue,"Unknown server value transform proto: "+
JSON.stringify(proto)),transform=ServerTimestampTransform.instance):hasTag(proto,type,"appendMissingElements")?(transform=proto.appendMissingElements.values||[],transform=new ArrayUnionTransformOperation(transform.map(function(v){return _this.fromValue(v)}))):hasTag(proto,type,"removeAllFromArray")?(transform=proto.removeAllFromArray.values||[],transform=new ArrayRemoveTransformOperation(transform.map(function(v){return _this.fromValue(v)}))):fail("Unknown transform proto: "+JSON.stringify(proto));
proto=FieldPath.fromServerFormat(proto.fieldPath);return new FieldTransform(proto,transform)};JsonProtoSerializer.prototype.toDocumentsTarget=function(query){return{documents:[this.toQueryPath(query.path)]}};JsonProtoSerializer.prototype.fromDocumentsTarget=function(documentsTarget){var count=documentsTarget.documents.length;assert(1===count,"DocumentsTarget contained other than 1 document: "+count);return Query$jscomp$0.atPath(this.fromQueryPath(documentsTarget.documents[0]))};JsonProtoSerializer.prototype.toQueryTarget=
function(query){var result={structuredQuery:{}};if(query.path.isEmpty())result.parent=this.toQueryPath(ResourcePath.EMPTY_PATH);else{var path=query.path;assert(0!==path.length%2,"Document queries with filters are not supported.");result.parent=this.toQueryPath(path.popLast());result.structuredQuery.from=[{collectionId:path.lastSegment()}]}if(path=this.toFilter(query.filters))result.structuredQuery.where=path;if(path=this.toOrder(query.orderBy))result.structuredQuery.orderBy=path;path=this.toInt32Value(query.limit);
void 0!==path&&(result.structuredQuery.limit=path);query.startAt&&(result.structuredQuery.startAt=this.toCursor(query.startAt));query.endAt&&(result.structuredQuery.endAt=this.toCursor(query.endAt));return result};JsonProtoSerializer.prototype.fromQueryTarget=function(target){var path=this.fromQueryPath(target.parent);target=target.structuredQuery;var fromCount=target.from?target.from.length:0;0<fromCount&&(assert(1===fromCount,"StructuredQuery.from with more than one collection is not supported."),
path=path.child(target.from[0].collectionId));fromCount=[];target.where&&(fromCount=this.fromFilter(target.where));var orderBy=[];target.orderBy&&(orderBy=this.fromOrder(target.orderBy));var limit=null;target.limit&&(limit=this.fromInt32Value(target.limit));var startAt=null;target.startAt&&(startAt=this.fromCursor(target.startAt));var endAt=null;target.endAt&&(endAt=this.fromCursor(target.endAt));return new Query$jscomp$0(path,orderBy,fromCount,limit,startAt,endAt)};JsonProtoSerializer.prototype.toListenRequestLabels=
function(queryData){queryData=this.toLabel(queryData.purpose);return null==queryData?null:{"goog-listen-tags":queryData}};JsonProtoSerializer.prototype.toLabel=function(purpose){switch(purpose){case QueryPurpose.Listen:return null;case QueryPurpose.ExistenceFilterMismatch:return"existence-filter-mismatch";case QueryPurpose.LimboResolution:return"limbo-document";default:return fail("Unrecognized query purpose: "+purpose)}};JsonProtoSerializer.prototype.toTarget=function(queryData){var result=queryData.query;
result=result.isDocumentQuery()?{documents:this.toDocumentsTarget(result)}:{query:this.toQueryTarget(result)};result.targetId=queryData.targetId;0<queryData.resumeToken.length&&(result.resumeToken=this.unsafeCastProtoByteString(queryData.resumeToken));return result};JsonProtoSerializer.prototype.toFilter=function(filters){var _this=this;if(0!==filters.length)return filters=filters.map(function(filter){return filter instanceof RelationFilter?_this.toRelationFilter(filter):_this.toUnaryFilter(filter)}),
1===filters.length?filters[0]:{compositeFilter:{op:"AND",filters:filters}}};JsonProtoSerializer.prototype.fromFilter=function(filter){var _this=this;return filter?void 0!==filter.unaryFilter?[this.fromUnaryFilter(filter)]:void 0!==filter.fieldFilter?[this.fromRelationFilter(filter)]:void 0!==filter.compositeFilter?filter.compositeFilter.filters.map(function(f){return _this.fromFilter(f)}).reduce(function(accum,current){return accum.concat(current)}):fail("Unknown filter: "+JSON.stringify(filter)):
[]};JsonProtoSerializer.prototype.toOrder=function(orderBys){var _this=this;if(0!==orderBys.length)return orderBys.map(function(order){return _this.toPropertyOrder(order)})};JsonProtoSerializer.prototype.fromOrder=function(orderBys){var _this=this;return orderBys.map(function(order){return _this.fromPropertyOrder(order)})};JsonProtoSerializer.prototype.toCursor=function(cursor){var _this=this;return{before:cursor.before,values:cursor.position.map(function(component){return _this.toValue(component)})}};
JsonProtoSerializer.prototype.fromCursor=function(cursor){var _this=this,before=!!cursor.before;cursor=cursor.values.map(function(component){return _this.fromValue(component)});return new Bound(cursor,before)};JsonProtoSerializer.prototype.toDirection=function(dir){return DIRECTIONS[dir.name]};JsonProtoSerializer.prototype.fromDirection=function(dir){switch(dir){case "ASCENDING":return Direction.ASCENDING;case "DESCENDING":return Direction.DESCENDING}};JsonProtoSerializer.prototype.toOperatorName=
function(op){return OPERATORS[op.name]};JsonProtoSerializer.prototype.fromOperatorName=function(op){switch(op){case "EQUAL":return RelationOp.EQUAL;case "GREATER_THAN":return RelationOp.GREATER_THAN;case "GREATER_THAN_OR_EQUAL":return RelationOp.GREATER_THAN_OR_EQUAL;case "LESS_THAN":return RelationOp.LESS_THAN;case "LESS_THAN_OR_EQUAL":return RelationOp.LESS_THAN_OR_EQUAL;case "ARRAY_CONTAINS":return RelationOp.ARRAY_CONTAINS;case "OPERATOR_UNSPECIFIED":return fail("Unspecified relation");default:return fail("Unknown relation")}};
JsonProtoSerializer.prototype.toFieldPathReference=function(path){return{fieldPath:path.canonicalString()}};JsonProtoSerializer.prototype.fromFieldPathReference=function(fieldReference){return FieldPath.fromServerFormat(fieldReference.fieldPath)};JsonProtoSerializer.prototype.toPropertyOrder=function(orderBy){return{field:this.toFieldPathReference(orderBy.field),direction:this.toDirection(orderBy.dir)}};JsonProtoSerializer.prototype.fromPropertyOrder=function(orderBy){return new OrderBy(this.fromFieldPathReference(orderBy.field),
this.fromDirection(orderBy.direction))};JsonProtoSerializer.prototype.toRelationFilter=function(filter){return filter instanceof RelationFilter?{fieldFilter:{field:this.toFieldPathReference(filter.field),op:this.toOperatorName(filter.op),value:this.toValue(filter.value)}}:fail("Unrecognized filter: "+JSON.stringify(filter))};JsonProtoSerializer.prototype.fromRelationFilter=function(filter){return new RelationFilter(this.fromFieldPathReference(filter.fieldFilter.field),this.fromOperatorName(filter.fieldFilter.op),
this.fromValue(filter.fieldFilter.value))};JsonProtoSerializer.prototype.toUnaryFilter=function(filter){return filter instanceof NanFilter?{unaryFilter:{field:this.toFieldPathReference(filter.field),op:"IS_NAN"}}:filter instanceof NullFilter?{unaryFilter:{field:this.toFieldPathReference(filter.field),op:"IS_NULL"}}:fail("Unrecognized filter: "+JSON.stringify(filter))};JsonProtoSerializer.prototype.fromUnaryFilter=function(filter){switch(filter.unaryFilter.op){case "IS_NAN":return filter=this.fromFieldPathReference(filter.unaryFilter.field),
new NanFilter(filter);case "IS_NULL":return filter=this.fromFieldPathReference(filter.unaryFilter.field),new NullFilter(filter);case "OPERATOR_UNSPECIFIED":return fail("Unspecified filter");default:return fail("Unknown filter")}};JsonProtoSerializer.prototype.toDocumentMask=function(fieldMask){return{fieldPaths:fieldMask.fields.map(function(field){return field.canonicalString()})}};JsonProtoSerializer.prototype.fromDocumentMask=function(proto){proto=(proto.fieldPaths||[]).map(function(path){return FieldPath.fromServerFormat(path)});
return new FieldMask(proto)};return JsonProtoSerializer}(),captureStackTrace=Error.captureStackTrace,FirebaseError=function(){return function(code,message){this.code=code;this.message=message;if(captureStackTrace)captureStackTrace(this,ErrorFactory$jscomp$0.prototype.create);else try{throw Error.apply(this,arguments);}catch(err){this.name="FirebaseError",Object.defineProperty(this,"stack",{get:function(){return err.stack}})}}}();FirebaseError.prototype=Object.create(Error.prototype);FirebaseError.prototype.constructor=
FirebaseError;FirebaseError.prototype.name="FirebaseError";var ErrorFactory$jscomp$0=function(){function ErrorFactory(service,serviceName,errors){this.service=service;this.serviceName=serviceName;this.errors=errors;this.pattern=/\{\$([^}]+)}/g}ErrorFactory.prototype.create=function(code,data){void 0===data&&(data={});var template=this.errors[code];code=this.service+"/"+code;template=void 0===template?"Error":template.replace(this.pattern,function(match,key){match=data[key];return void 0!==match?match.toString():
"\x3c"+key+"?\x3e"});template=this.serviceName+": "+template+" ("+code+").";template=new FirebaseError(code,template);for(var prop in data)data.hasOwnProperty(prop)&&"_"!==prop.slice(-1)&&(template[prop]=data[prop]);return template};return ErrorFactory}();(function(_super){function Sha1(){var _this=_super.call(this)||this;_this.chain_=[];_this.buf_=[];_this.W_=[];_this.pad_=[];_this.inbuf_=0;_this.total_=0;_this.blockSize=64;_this.pad_[0]=128;for(var i=1;i<_this.blockSize;++i)_this.pad_[i]=0;_this.reset();
return _this}tslib_1.__extends(Sha1,_super);Sha1.prototype.reset=function(){this.chain_[0]=1732584193;this.chain_[1]=4023233417;this.chain_[2]=2562383102;this.chain_[3]=271733878;this.chain_[4]=3285377520;this.total_=this.inbuf_=0};Sha1.prototype.compress_=function(buf,opt_offset){opt_offset||(opt_offset=0);var W=this.W_;if("string"===typeof buf)for(var i=0;16>i;i++)W[i]=buf.charCodeAt(opt_offset)<<24|buf.charCodeAt(opt_offset+1)<<16|buf.charCodeAt(opt_offset+2)<<8|buf.charCodeAt(opt_offset+3),opt_offset+=
4;else for(i=0;16>i;i++)W[i]=buf[opt_offset]<<24|buf[opt_offset+1]<<16|buf[opt_offset+2]<<8|buf[opt_offset+3],opt_offset+=4;for(i=16;80>i;i++){var t=W[i-3]^W[i-8]^W[i-14]^W[i-16];W[i]=(t<<1|t>>>31)&4294967295}buf=this.chain_[0];opt_offset=this.chain_[1];var c=this.chain_[2],d=this.chain_[3],e=this.chain_[4];for(i=0;80>i;i++){if(40>i)if(20>i){t=d^opt_offset&(c^d);var k=1518500249}else t=opt_offset^c^d,k=1859775393;else 60>i?(t=opt_offset&c|d&(opt_offset|c),k=2400959708):(t=opt_offset^c^d,k=3395469782);
t=(buf<<5|buf>>>27)+t+e+k+W[i]&4294967295;e=d;d=c;c=(opt_offset<<30|opt_offset>>>2)&4294967295;opt_offset=buf;buf=t}this.chain_[0]=this.chain_[0]+buf&4294967295;this.chain_[1]=this.chain_[1]+opt_offset&4294967295;this.chain_[2]=this.chain_[2]+c&4294967295;this.chain_[3]=this.chain_[3]+d&4294967295;this.chain_[4]=this.chain_[4]+e&4294967295};Sha1.prototype.update=function(bytes,opt_length){if(null!=bytes){void 0===opt_length&&(opt_length=bytes.length);for(var lengthMinusBlock=opt_length-this.blockSize,
n=0,buf=this.buf_,inbuf=this.inbuf_;n<opt_length;){if(0==inbuf)for(;n<=lengthMinusBlock;)this.compress_(bytes,n),n+=this.blockSize;if("string"===typeof bytes)for(;n<opt_length;){if(buf[inbuf]=bytes.charCodeAt(n),++inbuf,++n,inbuf==this.blockSize){this.compress_(buf);inbuf=0;break}}else for(;n<opt_length;)if(buf[inbuf]=bytes[n],++inbuf,++n,inbuf==this.blockSize){this.compress_(buf);inbuf=0;break}}this.inbuf_=inbuf;this.total_+=opt_length}};Sha1.prototype.digest=function(){var digest=[],totalBits=8*
this.total_;56>this.inbuf_?this.update(this.pad_,56-this.inbuf_):this.update(this.pad_,this.blockSize-(this.inbuf_-56));for(var i=this.blockSize-1;56<=i;i--)this.buf_[i]=totalBits&255,totalBits/=256;this.compress_(this.buf_);for(i=totalBits=0;5>i;i++)for(var j=24;0<=j;j-=8)digest[totalBits]=this.chain_[i]>>j&255,++totalBits;return digest};return Sha1})(function(){return function(){this.blockSize=-1}}());var StreamBridge=function(){function StreamBridge(args){this.sendFn=args.sendFn;this.closeFn=args.closeFn}
StreamBridge.prototype.onOpen=function(callback){assert(!this.wrappedOnOpen,"Called onOpen on stream twice!");this.wrappedOnOpen=callback};StreamBridge.prototype.onClose=function(callback){assert(!this.wrappedOnClose,"Called onClose on stream twice!");this.wrappedOnClose=callback};StreamBridge.prototype.onMessage=function(callback){assert(!this.wrappedOnMessage,"Called onMessage on stream twice!");this.wrappedOnMessage=callback};StreamBridge.prototype.close=function(){this.closeFn()};StreamBridge.prototype.send=
function(msg){this.sendFn(msg)};StreamBridge.prototype.callOnOpen=function(){assert(void 0!==this.wrappedOnOpen,"Cannot call onOpen because no callback was set");this.wrappedOnOpen()};StreamBridge.prototype.callOnClose=function(err){assert(void 0!==this.wrappedOnClose,"Cannot call onClose because no callback was set");this.wrappedOnClose(err)};StreamBridge.prototype.callOnMessage=function(msg){assert(void 0!==this.wrappedOnMessage,"Cannot call onMessage because no callback was set");this.wrappedOnMessage(msg)};
return StreamBridge}(),RPC_NAME_REST_MAPPING={BatchGetDocuments:"batchGet",Commit:"commit"},X_GOOG_API_CLIENT_VALUE="gl-js/ fire/"+SDK_VERSION,WebChannelConnection=function(){function WebChannelConnection(info){this.databaseId=info.databaseId;this.pool=new webchannelWrapper.XhrIoPool;this.baseUrl=(info.ssl?"https":"http")+"://"+info.host}WebChannelConnection.prototype.modifyHeadersForRequest=function(headers,token){if(token)for(var header in token.authHeaders)token.authHeaders.hasOwnProperty(header)&&
(headers[header]=token.authHeaders[header]);headers["X-Goog-Api-Client"]=X_GOOG_API_CLIENT_VALUE};WebChannelConnection.prototype.invokeRPC=function(rpcName,request,token){var _this=this,url=this.makeUrl(rpcName);return new Promise(function(resolve,reject){_this.pool.getObject(function(xhr){xhr.listenOnce(webchannelWrapper.EventType.COMPLETE,function(){try{switch(xhr.getLastErrorCode()){case webchannelWrapper.ErrorCode.NO_ERROR:var json=xhr.getResponseJson();debug("Connection","XHR received:",JSON.stringify(json));
resolve(json);break;case webchannelWrapper.ErrorCode.TIMEOUT:debug("Connection",'RPC "'+rpcName+'" timed out');reject(new FirestoreError(Code.DEADLINE_EXCEEDED,"Request time out"));break;case webchannelWrapper.ErrorCode.HTTP_ERROR:var status_1=xhr.getStatus();debug("Connection",'RPC "'+rpcName+'" failed with status:',status_1,"response text:",xhr.getResponseText());0<status_1?reject(new FirestoreError(mapCodeFromHttpStatus(status_1),"Server responded with status "+xhr.getStatusText())):(debug("Connection",
'RPC "'+rpcName+'" failed'),reject(new FirestoreError(Code.UNAVAILABLE,"Connection failed.")));break;default:fail('RPC "'+rpcName+'" failed with unanticipated webchannel error '+xhr.getLastErrorCode()+": "+xhr.getLastError()+", giving up.")}}finally{debug("Connection",'RPC "'+rpcName+'" completed.'),_this.pool.releaseObject(xhr)}});var requestString=JSON.stringify(request);debug("Connection","XHR sending: ",url+" "+requestString);var headers={"Content-Type":"text/plain"};_this.modifyHeadersForRequest(headers,
token);xhr.send(url,"POST",requestString,headers,15)})})};WebChannelConnection.prototype.invokeStreamingRPC=function(rpcName,request,token){return this.invokeRPC(rpcName,request,token)};WebChannelConnection.prototype.openStream=function(rpcName,token){var urlParts=[this.baseUrl,"/","google.firestore.v1beta1.Firestore","/",rpcName,"/channel"];rpcName=webchannelWrapper.createWebChannelTransport();var request={backgroundChannelTest:!0,httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:"projects/"+
this.databaseId.projectId+"/databases/"+this.databaseId.database},sendRawJson:!0,supportsCrossDomainXhr:!0};this.modifyHeadersForRequest(request.initMessageHeaders,token);if("object"!==typeof navigator||"ReactNative"!==navigator.product)request.httpHeadersOverwriteParam="$httpHeaders";token=urlParts.join("");debug("Connection","Creating WebChannel: "+token+" "+request);var channel=rpcName.createWebChannel(token,request),opened=!1,closed=!1,streamBridge=new StreamBridge({sendFn:function(msg){closed?
debug("Connection","Not sending because WebChannel is closed:",msg):(opened||(debug("Connection","Opening WebChannel transport."),channel.open(),opened=!0),debug("Connection","WebChannel sending:",msg),channel.send(msg))},closeFn:function(){return channel.close()}});token=function(type,fn){channel.listen(type,function(param){try{fn(param)}catch(e){setTimeout(function(){throw e;},0)}})};token(webchannelWrapper.WebChannel.EventType.OPEN,function(){closed||debug("Connection","WebChannel transport opened.")});
token(webchannelWrapper.WebChannel.EventType.CLOSE,function(){closed||(closed=!0,debug("Connection","WebChannel transport closed"),streamBridge.callOnClose())});token(webchannelWrapper.WebChannel.EventType.ERROR,function(err){closed||(closed=!0,debug("Connection","WebChannel transport errored:",err),streamBridge.callOnClose(new FirestoreError(Code.UNAVAILABLE,"The operation could not be completed")))});token(webchannelWrapper.WebChannel.EventType.MESSAGE,function(msg){if(!closed){var msgData=msg.data[0];
assert(!!msgData,"Got a webchannel message without data.");if(msg=msgData.error||msgData[0]&&msgData[0].error){debug("Connection","WebChannel received error:",msg);msgData=msg.status;var code=RpcCode[msgData];code=void 0===code?void 0:mapCodeFromRpcCode(code);var message=msg.message;void 0===code&&(code=Code.INTERNAL,message="Unknown error status: "+msgData+" with message "+msg.message);closed=!0;streamBridge.callOnClose(new FirestoreError(code,message));channel.close()}else debug("Connection","WebChannel received:",
msgData),streamBridge.callOnMessage(msgData)}});setTimeout(function(){streamBridge.callOnOpen()},0);return streamBridge};WebChannelConnection.prototype.makeUrl=function(rpcName){var urlRpcName=RPC_NAME_REST_MAPPING[rpcName];assert(void 0!==urlRpcName,"Unknown REST mapping for: "+rpcName);rpcName=[this.baseUrl,"/","v1beta1"];rpcName.push("/projects/");rpcName.push(this.databaseId.projectId);rpcName.push("/databases/");rpcName.push(this.databaseId.database);rpcName.push("/documents");rpcName.push(":");
rpcName.push(urlRpcName);return rpcName.join("")};return WebChannelConnection}(),BrowserPlatform=function(){function BrowserPlatform(){this.emptyByteString="";this.base64Available="undefined"!==typeof atob}BrowserPlatform.prototype.loadConnection=function(databaseInfo){return Promise.resolve(new WebChannelConnection(databaseInfo))};BrowserPlatform.prototype.newSerializer=function(databaseId){return new JsonProtoSerializer(databaseId,{useProto3Json:!0})};BrowserPlatform.prototype.formatJSON=function(value){return JSON.stringify(value)};
BrowserPlatform.prototype.atob=function(encoded){return atob(encoded)};BrowserPlatform.prototype.btoa=function(raw){return btoa(raw)};return BrowserPlatform}();PlatformSupport.setPlatform(new BrowserPlatform);var FieldPath$1=function(){function FieldPath$$1(){for(var fieldNames=[],_i=0;_i<arguments.length;_i++)fieldNames[_i]=arguments[_i];if(!(fieldNames instanceof Array)||1>fieldNames.length)throw new FirestoreError(Code.INVALID_ARGUMENT,"Function FieldPath() requires its fieldNames argument to be an array with at least "+
(formatPlural(1,"element")+"."));for(_i=0;_i<fieldNames.length;++_i)if(validateArgType("FieldPath","string",_i,fieldNames[_i]),0===fieldNames[_i].length)throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new FieldPath(fieldNames)}FieldPath$$1.documentId=function(){return FieldPath$$1._DOCUMENT_ID};FieldPath$$1.prototype.isEqual=function(other){if(!(other instanceof FieldPath$$1))throw invalidClassError("isEqual",
"FieldPath",1,other);return this._internalPath.isEqual(other._internalPath)};FieldPath$$1._DOCUMENT_ID=new FieldPath$$1(FieldPath.keyField().canonicalString());return FieldPath$$1}(),RESERVED=/[~\*/\[\]]/,OnlineState;(function(OnlineState){OnlineState[OnlineState.Unknown=0]="Unknown";OnlineState[OnlineState.Online=1]="Online";OnlineState[OnlineState.Offline=2]="Offline"})(OnlineState||(OnlineState={}));var DocumentSet=function(){function DocumentSet(comp){this.comparator=comp?function(d1,d2){return comp(d1,
d2)||DocumentKey.comparator(d1.key,d2.key)}:function(d1,d2){return DocumentKey.comparator(d1.key,d2.key)};this.keyedMap=EMPTY_DOCUMENT_MAP;this.sortedSet=new SortedMap$jscomp$0(this.comparator)}DocumentSet.emptySet=function(oldSet){return new DocumentSet(oldSet.comparator)};DocumentSet.prototype.has=function(key){return null!=this.keyedMap.get(key)};DocumentSet.prototype.get=function(key){return this.keyedMap.get(key)};DocumentSet.prototype.first=function(){return this.sortedSet.minKey()};DocumentSet.prototype.last=
function(){return this.sortedSet.maxKey()};DocumentSet.prototype.isEmpty=function(){return this.sortedSet.isEmpty()};DocumentSet.prototype.indexOf=function(key){return(key=this.keyedMap.get(key))?this.sortedSet.indexOf(key):-1};Object.defineProperty(DocumentSet.prototype,"size",{get:function(){return this.sortedSet.size},enumerable:!0,configurable:!0});DocumentSet.prototype.forEach=function(cb){this.sortedSet.inorderTraversal(function(k,v){cb(k);return!1})};DocumentSet.prototype.add=function(doc){var set=
this.delete(doc.key);return set.copy(set.keyedMap.insert(doc.key,doc),set.sortedSet.insert(doc,null))};DocumentSet.prototype.delete=function(key){var doc=this.get(key);return doc?this.copy(this.keyedMap.remove(key),this.sortedSet.remove(doc)):this};DocumentSet.prototype.isEqual=function(other){if(!(other instanceof DocumentSet)||this.size!==other.size)return!1;var thisIt=this.sortedSet.getIterator();for(other=other.sortedSet.getIterator();thisIt.hasNext();){var thisDoc=thisIt.getNext().key,otherDoc=
other.getNext().key;if(!thisDoc.isEqual(otherDoc))return!1}return!0};DocumentSet.prototype.toString=function(){var docStrings=[];this.forEach(function(doc){docStrings.push(doc.toString())});return 0===docStrings.length?"DocumentSet ()":"DocumentSet (\n  "+docStrings.join("  \n")+"\n)"};DocumentSet.prototype.copy=function(keyedMap,sortedSet){var newSet=new DocumentSet;newSet.comparator=this.comparator;newSet.keyedMap=keyedMap;newSet.sortedSet=sortedSet;return newSet};return DocumentSet}(),ObjectMap=
function(){function ObjectMap(mapKeyFn){this.mapKeyFn=mapKeyFn;this.inner={}}ObjectMap.prototype.get=function(key){var id=this.mapKeyFn(key);id=this.inner[id];if(void 0!==id)for(var _i=0;_i<id.length;_i++){var _a=id[_i],value=_a[1];if(_a[0].isEqual(key))return value}};ObjectMap.prototype.has=function(key){return void 0!==this.get(key)};ObjectMap.prototype.set=function(key,value){var id=this.mapKeyFn(key),matches=this.inner[id];if(void 0===matches)this.inner[id]=[[key,value]];else{for(id=0;id<matches.length;id++)if(matches[id][0].isEqual(key)){matches[id]=
[key,value];return}matches.push([key,value])}};ObjectMap.prototype.delete=function(key){var id=this.mapKeyFn(key),matches=this.inner[id];if(void 0===matches)return!1;for(var i=0;i<matches.length;i++)if(matches[i][0].isEqual(key))return 1===matches.length?delete this.inner[id]:matches.splice(i,1),!0;return!1};ObjectMap.prototype.forEach=function(fn){forEach(this.inner,function(_,entries){for(_=0;_<entries.length;_++){var _a=entries[_];fn(_a[0],_a[1])}})};ObjectMap.prototype.isEmpty=function(){return isEmpty(this.inner)};
return ObjectMap}(),QueryListenersInfo=function(){return function(){this.listeners=[]}}(),EventManager=function(){function EventManager(syncEngine){this.syncEngine=syncEngine;this.queries=new ObjectMap(function(q){return q.canonicalId()});this.onlineState=OnlineState.Unknown;this.syncEngine.subscribe(this.onChange.bind(this),this.onError.bind(this))}EventManager.prototype.listen=function(listener){var query=listener.query,firstListen=!1,queryInfo=this.queries.get(query);queryInfo||(firstListen=!0,
queryInfo=new QueryListenersInfo,this.queries.set(query,queryInfo));queryInfo.listeners.push(listener);listener.applyOnlineStateChange(this.onlineState);if(queryInfo.viewSnap)listener.onViewSnapshot(queryInfo.viewSnap);return firstListen?this.syncEngine.listen(query).then(function(targetId){return queryInfo.targetId=targetId}):Promise.resolve(queryInfo.targetId)};EventManager.prototype.unlisten=function(listener){return tslib_1.__awaiter(this,void 0,void 0,function(){var query,lastListen,queryInfo,
i;return tslib_1.__generator(this,function(_a){query=listener.query;lastListen=!1;if(queryInfo=this.queries.get(query))i=queryInfo.listeners.indexOf(listener),0<=i&&(queryInfo.listeners.splice(i,1),lastListen=0===queryInfo.listeners.length);return lastListen?(this.queries.delete(query),[2,this.syncEngine.unlisten(query)]):[2]})})};EventManager.prototype.onChange=function(viewSnaps){for(var _i=0;_i<viewSnaps.length;_i++){var viewSnap=viewSnaps[_i],queryInfo=this.queries.get(viewSnap.query);if(queryInfo){for(var _a=
0,_b=queryInfo.listeners;_a<_b.length;_a++)_b[_a].onViewSnapshot(viewSnap);queryInfo.viewSnap=viewSnap}}};EventManager.prototype.onError=function(query,error){var queryInfo=this.queries.get(query);if(queryInfo){var _i=0;for(queryInfo=queryInfo.listeners;_i<queryInfo.length;_i++)queryInfo[_i].onError(error)}this.queries.delete(query)};EventManager.prototype.applyOnlineStateChange=function(onlineState){this.onlineState=onlineState;this.queries.forEach(function(_,queryInfo){_=0;for(queryInfo=queryInfo.listeners;_<
queryInfo.length;_++)queryInfo[_].applyOnlineStateChange(onlineState)})};return EventManager}(),QueryListener=function(){function QueryListener(query,queryObserver,options){this.query=query;this.queryObserver=queryObserver;this.raisedInitialEvent=!1;this.onlineState=OnlineState.Unknown;this.options=options||{}}QueryListener.prototype.onViewSnapshot=function(snap){assert(0<snap.docChanges.length||snap.syncStateChanged,"We got a new snapshot with no changes?");if(!this.options.includeMetadataChanges){for(var docChanges=
[],_i=0,_a=snap.docChanges;_i<_a.length;_i++){var docChange=_a[_i];docChange.type!==ChangeType.Metadata&&docChanges.push(docChange)}snap=new ViewSnapshot(snap.query,snap.docs,snap.oldDocs,docChanges,snap.fromCache,snap.hasPendingWrites,snap.syncStateChanged,!0)}this.raisedInitialEvent?this.shouldRaiseEvent(snap)&&this.queryObserver.next(snap):this.shouldRaiseInitialEvent(snap,this.onlineState)&&this.raiseInitialEvent(snap);this.snap=snap};QueryListener.prototype.onError=function(error){this.queryObserver.error(error)};
QueryListener.prototype.applyOnlineStateChange=function(onlineState){this.onlineState=onlineState;this.snap&&!this.raisedInitialEvent&&this.shouldRaiseInitialEvent(this.snap,onlineState)&&this.raiseInitialEvent(this.snap)};QueryListener.prototype.shouldRaiseInitialEvent=function(snap,onlineState){assert(!this.raisedInitialEvent,"Determining whether to raise first event but already had first event");if(!snap.fromCache)return!0;var maybeOnline=onlineState!==OnlineState.Offline;return this.options.waitForSyncWhenOnline&&
maybeOnline?(assert(snap.fromCache,"Waiting for sync, but snapshot is not from cache"),!1):!snap.docs.isEmpty()||onlineState===OnlineState.Offline};QueryListener.prototype.shouldRaiseEvent=function(snap){if(0<snap.docChanges.length)return!0;var hasPendingWritesChanged=this.snap&&this.snap.hasPendingWrites!==snap.hasPendingWrites;return snap.syncStateChanged||hasPendingWritesChanged?!0===this.options.includeMetadataChanges:!1};QueryListener.prototype.raiseInitialEvent=function(snap){assert(!this.raisedInitialEvent,
"Trying to raise initial events for second time");snap=new ViewSnapshot(snap.query,snap.docs,DocumentSet.emptySet(snap.docs),QueryListener.getInitialViewChanges(snap),snap.fromCache,snap.hasPendingWrites,!0,!1);this.raisedInitialEvent=!0;this.queryObserver.next(snap)};QueryListener.getInitialViewChanges=function(snap){var result=[];snap.docs.forEach(function(doc){result.push({type:ChangeType.Added,doc:doc})});return result};return QueryListener}(),PersistencePromise=function(){function PersistencePromise(callback){var _this=
this;this.catchCallback=this.nextCallback=null;this.error=this.result=void 0;this.callbackAttached=this.isDone=!1;callback(function(value){_this.isDone=!0;_this.result=value;_this.nextCallback&&_this.nextCallback(value)},function(error){_this.isDone=!0;_this.error=error;_this.catchCallback&&_this.catchCallback(error)})}PersistencePromise.prototype.catch=function(fn){return this.next(void 0,fn)};PersistencePromise.prototype.next=function(nextFn,catchFn){var _this=this;this.callbackAttached&&fail("Called next() or catch() twice for PersistencePromise");
this.callbackAttached=!0;return this.isDone?this.error?this.wrapFailure(catchFn,this.error):this.wrapSuccess(nextFn,this.result):new PersistencePromise(function(resolve,reject){_this.nextCallback=function(value){_this.wrapSuccess(nextFn,value).next(resolve,reject)};_this.catchCallback=function(error){_this.wrapFailure(catchFn,error).next(resolve,reject)}})};PersistencePromise.prototype.toPromise=function(){var _this=this;return new Promise(function(resolve,reject){_this.next(resolve,reject)})};PersistencePromise.prototype.wrapUserFunction=
function(fn){try{var result=fn();return result instanceof PersistencePromise?result:PersistencePromise.resolve(result)}catch(e){return PersistencePromise.reject(e)}};PersistencePromise.prototype.wrapSuccess=function(nextFn,value){return nextFn?this.wrapUserFunction(function(){return nextFn(value)}):PersistencePromise.resolve(value)};PersistencePromise.prototype.wrapFailure=function(catchFn,error){return catchFn?this.wrapUserFunction(function(){return catchFn(error)}):PersistencePromise.reject(error)};
PersistencePromise.resolve=function(result){return new PersistencePromise(function(resolve,reject){resolve(result)})};PersistencePromise.reject=function(error){return new PersistencePromise(function(resolve,reject){reject(error)})};PersistencePromise.waitFor=function(all){var expectedCount=all.length;if(0===expectedCount)return PersistencePromise.resolve();var resolvedCount=0;return new PersistencePromise(function(resolve,reject){for(var _i=0;_i<all.length;_i++)all[_i].next(function(){++resolvedCount;
resolvedCount===expectedCount&&resolve()},function(err){return reject(err)})})};PersistencePromise.map=function(all){for(var results=[],promises=[],_loop_1=function(i){promises[i]=all[i].next(function(result){results[i]=result})},i$jscomp$0=0;i$jscomp$0<all.length;++i$jscomp$0)_loop_1(i$jscomp$0);return PersistencePromise.waitFor(promises).next(function(){return results})};return PersistencePromise}(),EagerGarbageCollector=function(){function EagerGarbageCollector(){this.isEager=!0;this.sources=[];
this.potentialGarbage=EMPTY_DOCUMENT_KEY_SET}EagerGarbageCollector.prototype.addGarbageSource=function(garbageSource){this.sources.push(garbageSource);garbageSource.setGarbageCollector(this)};EagerGarbageCollector.prototype.removeGarbageSource=function(garbageSource){this.sources.splice(this.sources.indexOf(garbageSource),1);garbageSource.setGarbageCollector(null)};EagerGarbageCollector.prototype.addPotentialGarbageKey=function(key){this.potentialGarbage=this.potentialGarbage.add(key)};EagerGarbageCollector.prototype.collectGarbage=
function(txn){var _this=this,promises=[],garbageKeys=EMPTY_DOCUMENT_KEY_SET;this.potentialGarbage.forEach(function(key){var hasRefsPromise=_this.documentHasAnyReferences(txn,key);promises.push(hasRefsPromise.next(function(hasRefs){hasRefs||(garbageKeys=garbageKeys.add(key));return PersistencePromise.resolve()}))});this.potentialGarbage=EMPTY_DOCUMENT_KEY_SET;return PersistencePromise.waitFor(promises).next(function(){return garbageKeys})};EagerGarbageCollector.prototype.documentHasAnyReferences=function(txn,
key){var initial=PersistencePromise.resolve(!1);return this.sources.map(function(source){return function(){return source.containsKey(txn,key)}}).reduce(function(promise,nextPromise){return promise.next(function(result){return result?PersistencePromise.resolve(!0):nextPromise()})},initial)};return EagerGarbageCollector}(),LocalViewChanges=function(){function LocalViewChanges(targetId,addedKeys,removedKeys){this.targetId=targetId;this.addedKeys=addedKeys;this.removedKeys=removedKeys}LocalViewChanges.fromSnapshot=
function(targetId,viewSnapshot){var addedKeys=EMPTY_DOCUMENT_KEY_SET,removedKeys=EMPTY_DOCUMENT_KEY_SET,_i=0;for(viewSnapshot=viewSnapshot.docChanges;_i<viewSnapshot.length;_i++){var docChange=viewSnapshot[_i];switch(docChange.type){case ChangeType.Added:addedKeys=addedKeys.add(docChange.doc.key);break;case ChangeType.Removed:removedKeys=removedKeys.add(docChange.doc.key)}}return new LocalViewChanges(targetId,addedKeys,removedKeys)};return LocalViewChanges}(),ReferenceSet=function(){function ReferenceSet(){this.refsByKey=
new SortedSet(DocReference.compareByKey);this.refsByTarget=new SortedSet(DocReference.compareByTargetId);this.garbageCollector=null}ReferenceSet.prototype.isEmpty=function(){return this.refsByKey.isEmpty()};ReferenceSet.prototype.addReference=function(key,id){key=new DocReference(key,id);this.refsByKey=this.refsByKey.add(key);this.refsByTarget=this.refsByTarget.add(key)};ReferenceSet.prototype.addReferences=function(keys,id){var _this=this;keys.forEach(function(key){return _this.addReference(key,
id)})};ReferenceSet.prototype.removeReference=function(key,id){this.removeRef(new DocReference(key,id))};ReferenceSet.prototype.removeReferences=function(keys,id){var _this=this;keys.forEach(function(key){return _this.removeReference(key,id)})};ReferenceSet.prototype.removeReferencesForId=function(id){var _this=this,emptyKey=DocumentKey.EMPTY,startRef=new DocReference(emptyKey,id);id=new DocReference(emptyKey,id+1);this.refsByTarget.forEachInRange([startRef,id],function(ref){_this.removeRef(ref)})};
ReferenceSet.prototype.removeAllReferences=function(){var _this=this;this.refsByKey.forEach(function(ref){return _this.removeRef(ref)})};ReferenceSet.prototype.removeRef=function(ref){this.refsByKey=this.refsByKey.delete(ref);this.refsByTarget=this.refsByTarget.delete(ref);null!==this.garbageCollector&&this.garbageCollector.addPotentialGarbageKey(ref.key)};ReferenceSet.prototype.referencesForId=function(id){var emptyKey=DocumentKey.EMPTY,startRef=new DocReference(emptyKey,id);id=new DocReference(emptyKey,
id+1);var keys=EMPTY_DOCUMENT_KEY_SET;this.refsByTarget.forEachInRange([startRef,id],function(ref){keys=keys.add(ref.key)});return keys};ReferenceSet.prototype.setGarbageCollector=function(garbageCollector){this.garbageCollector=garbageCollector};ReferenceSet.prototype.containsKey=function(txn,key){txn=new DocReference(key,0);txn=this.refsByKey.firstAfterOrEqual(txn);return PersistencePromise.resolve(null!==txn&&key.isEqual(txn.key))};return ReferenceSet}(),DocReference=function(){function DocReference(key,
targetOrBatchId){this.key=key;this.targetOrBatchId=targetOrBatchId}DocReference.compareByKey=function(left,right){return DocumentKey.comparator(left.key,right.key)||primitiveComparator(left.targetOrBatchId,right.targetOrBatchId)};DocReference.compareByTargetId=function(left,right){return primitiveComparator(left.targetOrBatchId,right.targetOrBatchId)||DocumentKey.comparator(left.key,right.key)};return DocReference}(),GeneratorIds;(function(GeneratorIds){GeneratorIds[GeneratorIds.LocalStore=0]="LocalStore";
GeneratorIds[GeneratorIds.SyncEngine=1]="SyncEngine"})(GeneratorIds||(GeneratorIds={}));var TargetIdGenerator=function(){function TargetIdGenerator(generatorId,initAfter){void 0===initAfter&&(initAfter=0);this.generatorId=generatorId;var afterWithoutGenerator=initAfter>>1<<1;this.previousId=initAfter-afterWithoutGenerator>=generatorId?afterWithoutGenerator|this.generatorId:(afterWithoutGenerator|this.generatorId)-2}TargetIdGenerator.prototype.next=function(){return this.previousId+=2};TargetIdGenerator.forLocalStore=
function(initAfter){void 0===initAfter&&(initAfter=0);return new TargetIdGenerator(GeneratorIds.LocalStore,initAfter)};TargetIdGenerator.forSyncEngine=function(){return new TargetIdGenerator(GeneratorIds.SyncEngine)};return TargetIdGenerator}(),AddedLimboDocument=function(){return function(key){this.key=key}}(),RemovedLimboDocument=function(){return function(key){this.key=key}}(),View$jscomp$0=function(){function View(query,_syncedDocuments){this.query=query;this._syncedDocuments=_syncedDocuments;
this.syncState=null;this.current=!1;this.mutatedKeys=this.limboDocuments=EMPTY_DOCUMENT_KEY_SET;this.documentSet=new DocumentSet(query.docComparator.bind(query))}Object.defineProperty(View.prototype,"syncedDocuments",{get:function(){return this._syncedDocuments},enumerable:!0,configurable:!0});View.prototype.computeDocChanges=function(docChanges,previousChanges){var _this=this,changeSet=previousChanges?previousChanges.changeSet:new DocumentChangeSet,oldDocumentSet=previousChanges?previousChanges.documentSet:
this.documentSet,newMutatedKeys=previousChanges?previousChanges.mutatedKeys:this.mutatedKeys,newDocumentSet=oldDocumentSet,needsRefill=!1,lastDocInLimit=this.query.hasLimit()&&oldDocumentSet.size===this.query.limit?oldDocumentSet.last():null;docChanges.inorderTraversal(function(key,newMaybeDoc){var oldDoc=oldDocumentSet.get(key);if(newMaybeDoc=newMaybeDoc instanceof Document$jscomp$0?newMaybeDoc:null)assert(key.isEqual(newMaybeDoc.key),"Mismatching keys found in document changes: "+key+" !\x3d "+
newMaybeDoc.key),newMaybeDoc=_this.query.matches(newMaybeDoc)?newMaybeDoc:null;newMaybeDoc?(newDocumentSet=newDocumentSet.add(newMaybeDoc),newMutatedKeys=newMaybeDoc.hasLocalMutations?newMutatedKeys.add(key):newMutatedKeys.delete(key)):(newDocumentSet=newDocumentSet.delete(key),newMutatedKeys=newMutatedKeys.delete(key));oldDoc&&newMaybeDoc?(key=oldDoc.data.isEqual(newMaybeDoc.data),key&&oldDoc.hasLocalMutations===newMaybeDoc.hasLocalMutations||(key?changeSet.track({type:ChangeType.Metadata,doc:newMaybeDoc}):
changeSet.track({type:ChangeType.Modified,doc:newMaybeDoc}),lastDocInLimit&&0<_this.query.docComparator(newMaybeDoc,lastDocInLimit)&&(needsRefill=!0))):!oldDoc&&newMaybeDoc?changeSet.track({type:ChangeType.Added,doc:newMaybeDoc}):oldDoc&&!newMaybeDoc&&(changeSet.track({type:ChangeType.Removed,doc:oldDoc}),lastDocInLimit&&(needsRefill=!0))});if(this.query.hasLimit())for(;newDocumentSet.size>this.query.limit;)docChanges=newDocumentSet.last(),newDocumentSet=newDocumentSet.delete(docChanges.key),changeSet.track({type:ChangeType.Removed,
doc:docChanges});assert(!needsRefill||!previousChanges,"View was refilled using docs that themselves needed refilling.");return{documentSet:newDocumentSet,changeSet:changeSet,needsRefill:needsRefill,mutatedKeys:newMutatedKeys}};View.prototype.applyChanges=function(docChanges,targetChange){var _this=this;assert(!docChanges.needsRefill,"Cannot apply changes that need a refill");var oldDocs=this.documentSet;this.documentSet=docChanges.documentSet;this.mutatedKeys=docChanges.mutatedKeys;var changes=docChanges.changeSet.getChanges();
changes.sort(function(c1,c2){return compareChangeType(c1.type,c2.type)||_this.query.docComparator(c1.doc,c2.doc)});this.applyTargetChange(targetChange);targetChange=this.updateLimboDocuments();var newSyncState=0===this.limboDocuments.size&&this.current?SyncState.Synced:SyncState.Local,syncStateChanged=newSyncState!==this.syncState;this.syncState=newSyncState;return 0!==changes.length||syncStateChanged?{snapshot:new ViewSnapshot(this.query,docChanges.documentSet,oldDocs,changes,newSyncState===SyncState.Local,
!docChanges.mutatedKeys.isEmpty(),syncStateChanged,!1),limboChanges:targetChange}:{limboChanges:targetChange}};View.prototype.applyOnlineStateChange=function(onlineState){return this.current&&onlineState===OnlineState.Offline?(this.current=!1,this.applyChanges({documentSet:this.documentSet,changeSet:new DocumentChangeSet,mutatedKeys:this.mutatedKeys,needsRefill:!1})):{limboChanges:[]}};View.prototype.shouldBeInLimbo=function(key){return this._syncedDocuments.has(key)||!this.documentSet.has(key)||
this.documentSet.get(key).hasLocalMutations?!1:!0};View.prototype.applyTargetChange=function(targetChange){var _this=this;targetChange&&(targetChange.addedDocuments.forEach(function(key){return _this._syncedDocuments=_this._syncedDocuments.add(key)}),targetChange.modifiedDocuments.forEach(function(key){return assert(_this._syncedDocuments.has(key),"Modified document "+key+" not found in view.")}),targetChange.removedDocuments.forEach(function(key){return _this._syncedDocuments=_this._syncedDocuments.delete(key)}),
this.current=targetChange.current)};View.prototype.updateLimboDocuments=function(){var _this=this;if(!this.current)return[];var oldLimboDocuments=this.limboDocuments;this.limboDocuments=EMPTY_DOCUMENT_KEY_SET;this.documentSet.forEach(function(doc){_this.shouldBeInLimbo(doc.key)&&(_this.limboDocuments=_this.limboDocuments.add(doc.key))});var changes=[];oldLimboDocuments.forEach(function(key){_this.limboDocuments.has(key)||changes.push(new RemovedLimboDocument(key))});this.limboDocuments.forEach(function(key){oldLimboDocuments.has(key)||
changes.push(new AddedLimboDocument(key))});return changes};return View}(),QueryView=function(){return function(query,targetId,view){this.query=query;this.targetId=targetId;this.view=view}}(),LimboResolution=function(){return function(key){this.key=key}}(),SyncEngine=function(){function SyncEngine(localStore,remoteStore,currentUser){this.localStore=localStore;this.remoteStore=remoteStore;this.currentUser=currentUser;this.errorHandler=this.viewHandler=null;this.queryViewsByQuery=new ObjectMap(function(q){return q.canonicalId()});
this.queryViewsByTarget={};this.limboTargetsByKey=new SortedMap$jscomp$0(DocumentKey.comparator);this.limboResolutionsByTarget={};this.limboDocumentRefs=new ReferenceSet;this.limboCollector=new EagerGarbageCollector;this.mutationUserCallbacks={};this.targetIdGenerator=TargetIdGenerator.forSyncEngine();this.limboCollector.addGarbageSource(this.limboDocumentRefs)}SyncEngine.prototype.subscribe=function(viewHandler,errorHandler){assert(null!==viewHandler&&null!==errorHandler,"View and error handlers cannot be null");
assert(null===this.viewHandler&&null===this.errorHandler,"SyncEngine already has a subscriber.");this.viewHandler=viewHandler;this.errorHandler=errorHandler};SyncEngine.prototype.listen=function(query){var _this=this;this.assertSubscribed("listen()");assert(!this.queryViewsByQuery.has(query),"We already listen to the query: "+query);return this.localStore.allocateQuery(query).then(function(queryData){return _this.localStore.executeQuery(query).then(function(docs){return _this.localStore.remoteDocumentKeys(queryData.targetId).then(function(remoteKeys){remoteKeys=
new View$jscomp$0(query,remoteKeys);var viewDocChanges=remoteKeys.computeDocChanges(docs);viewDocChanges=remoteKeys.applyChanges(viewDocChanges);assert(0===viewDocChanges.limboChanges.length,"View returned limbo docs before target ack from the server.");assert(!!viewDocChanges.snapshot,"applyChanges for new view should always return a snapshot");remoteKeys=new QueryView(query,queryData.targetId,remoteKeys);_this.queryViewsByQuery.set(query,remoteKeys);_this.queryViewsByTarget[queryData.targetId]=
remoteKeys;_this.viewHandler([viewDocChanges.snapshot]);_this.remoteStore.listen(queryData)})}).then(function(){return queryData.targetId})})};SyncEngine.prototype.unlisten=function(query){var _this=this;this.assertSubscribed("unlisten()");var queryView=this.queryViewsByQuery.get(query);assert(!!queryView,"Trying to unlisten on query not found:"+query);return this.localStore.releaseQuery(query).then(function(){_this.remoteStore.unlisten(queryView.targetId);return _this.removeAndCleanupQuery(queryView).then(function(){return _this.localStore.collectGarbage()})})};
SyncEngine.prototype.write=function(batch,userCallback){var _this=this;this.assertSubscribed("write()");return this.localStore.localWrite(batch).then(function(result){_this.addMutationCallback(result.batchId,userCallback);return _this.emitNewSnapsAndNotifyLocalStore(result.changes)}).then(function(){return _this.remoteStore.fillWritePipeline()})};SyncEngine.prototype.wrapUpdateFunctionError=function(error$$1){return error$$1};SyncEngine.prototype.runTransaction=function(updateFunction,retries){var _this=
this;void 0===retries&&(retries=5);assert(0<=retries,"Got negative number of retries for transaction.");var transaction=this.remoteStore.createTransaction();return function(){try{var userPromise=updateFunction(transaction);return!isNullOrUndefined(userPromise)&&userPromise.catch&&userPromise.then?userPromise.catch(function(e){return Promise.reject(_this.wrapUpdateFunctionError(e))}):Promise.reject(Error("Transaction callback must return a Promise"))}catch(e){return Promise.reject(_this.wrapUpdateFunctionError(e))}}().then(function(result){return transaction.commit().then(function(){return result}).catch(function(error$$1){return 0===
retries?Promise.reject(error$$1):_this.runTransaction(updateFunction,retries-1)})})};SyncEngine.prototype.applyRemoteEvent=function(remoteEvent){var _this=this;this.assertSubscribed("applyRemoteEvent()");forEach(remoteEvent.targetChanges,function(targetId,targetChange){if(targetId=_this.limboResolutionsByTarget[targetId])assert(1>=targetChange.addedDocuments.size+targetChange.modifiedDocuments.size+targetChange.removedDocuments.size,"Limbo resolution for single document contains multiple changes."),
0<targetChange.addedDocuments.size?targetId.receivedDocument=!0:0<targetChange.modifiedDocuments.size?assert(targetId.receivedDocument,"Received change for limbo target document without add."):0<targetChange.removedDocuments.size&&(assert(targetId.receivedDocument,"Received remove for limbo target document without add."),targetId.receivedDocument=!1)});return this.localStore.applyRemoteEvent(remoteEvent).then(function(changes){return _this.emitNewSnapsAndNotifyLocalStore(changes,remoteEvent)})};SyncEngine.prototype.applyOnlineStateChange=
function(onlineState){var newViewSnapshots=[];this.queryViewsByQuery.forEach(function(query,queryView){query=queryView.view.applyOnlineStateChange(onlineState);assert(0===query.limboChanges.length,"OnlineState should not affect limbo documents.");query.snapshot&&newViewSnapshots.push(query.snapshot)});this.viewHandler(newViewSnapshots)};SyncEngine.prototype.rejectListen=function(targetId,err){var _this=this;this.assertSubscribed("rejectListens()");var limboResolution=this.limboResolutionsByTarget[targetId];
if(limboResolution=limboResolution&&limboResolution.key)return this.limboTargetsByKey=this.limboTargetsByKey.remove(limboResolution),delete this.limboResolutionsByTarget[targetId],targetId=new SortedMap$jscomp$0(DocumentKey.comparator),targetId=targetId.insert(limboResolution,new NoDocument(limboResolution,SnapshotVersion.forDeletedDoc())),limboResolution=EMPTY_DOCUMENT_KEY_SET.add(limboResolution),targetId=new RemoteEvent(SnapshotVersion.MIN,{},new SortedSet(primitiveComparator),targetId,limboResolution),
this.applyRemoteEvent(targetId);var queryView_1=this.queryViewsByTarget[targetId];assert(!!queryView_1,"Unknown targetId: "+targetId);return this.localStore.releaseQuery(queryView_1.query).then(function(){return _this.removeAndCleanupQuery(queryView_1).then(function(){_this.errorHandler(queryView_1.query,err)})})};SyncEngine.prototype.applySuccessfulWrite=function(mutationBatchResult){var _this=this;this.assertSubscribed("applySuccessfulWrite()");this.processUserCallback(mutationBatchResult.batch.batchId,
null);return this.localStore.acknowledgeBatch(mutationBatchResult).then(function(changes){return _this.emitNewSnapsAndNotifyLocalStore(changes)})};SyncEngine.prototype.rejectFailedWrite=function(batchId,error$$1){var _this=this;this.assertSubscribed("rejectFailedWrite()");this.processUserCallback(batchId,error$$1);return this.localStore.rejectBatch(batchId).then(function(changes){return _this.emitNewSnapsAndNotifyLocalStore(changes)})};SyncEngine.prototype.addMutationCallback=function(batchId,callback){var newCallbacks=
this.mutationUserCallbacks[this.currentUser.toKey()];newCallbacks||(newCallbacks=new SortedMap$jscomp$0(primitiveComparator));newCallbacks=newCallbacks.insert(batchId,callback);this.mutationUserCallbacks[this.currentUser.toKey()]=newCallbacks};SyncEngine.prototype.processUserCallback=function(batchId,error$$1){var newCallbacks=this.mutationUserCallbacks[this.currentUser.toKey()];if(newCallbacks){var callback=newCallbacks.get(batchId);callback&&(assert(batchId===newCallbacks.minKey(),"Mutation callbacks processed out-of-order?"),
error$$1?callback.reject(error$$1):callback.resolve(),newCallbacks=newCallbacks.remove(batchId));this.mutationUserCallbacks[this.currentUser.toKey()]=newCallbacks}};SyncEngine.prototype.removeAndCleanupQuery=function(queryView){this.queryViewsByQuery.delete(queryView.query);delete this.queryViewsByTarget[queryView.targetId];this.limboDocumentRefs.removeReferencesForId(queryView.targetId);return this.gcLimboDocuments()};SyncEngine.prototype.updateTrackedLimbos=function(targetId,limboChanges){for(var _i=
0;_i<limboChanges.length;_i++){var limboChange=limboChanges[_i];limboChange instanceof AddedLimboDocument?(this.limboDocumentRefs.addReference(limboChange.key,targetId),this.trackLimboChange(limboChange)):limboChange instanceof RemovedLimboDocument?(debug("SyncEngine","Document no longer in limbo: "+limboChange.key),this.limboDocumentRefs.removeReference(limboChange.key,targetId)):fail("Unknown limbo change: "+JSON.stringify(limboChange))}return this.gcLimboDocuments()};SyncEngine.prototype.trackLimboChange=
function(limboChange){limboChange=limboChange.key;if(!this.limboTargetsByKey.get(limboChange)){debug("SyncEngine","New document in limbo: "+limboChange);var limboTargetId=this.targetIdGenerator.next(),query=Query$jscomp$0.atPath(limboChange.path);this.limboResolutionsByTarget[limboTargetId]=new LimboResolution(limboChange);this.remoteStore.listen(new QueryData(query,limboTargetId,QueryPurpose.LimboResolution));this.limboTargetsByKey=this.limboTargetsByKey.insert(limboChange,limboTargetId)}};SyncEngine.prototype.gcLimboDocuments=
function(){var _this=this;return this.limboCollector.collectGarbage(null).next(function(keys){keys.forEach(function(key){var limboTargetId=_this.limboTargetsByKey.get(key);null!==limboTargetId&&(_this.remoteStore.unlisten(limboTargetId),_this.limboTargetsByKey=_this.limboTargetsByKey.remove(key),delete _this.limboResolutionsByTarget[limboTargetId])})}).toPromise()};SyncEngine.prototype.currentLimboDocs=function(){return this.limboTargetsByKey};SyncEngine.prototype.emitNewSnapsAndNotifyLocalStore=
function(changes,remoteEvent){var _this=this,newSnaps=[],docChangesInAllViews=[],queriesProcessed=[];this.queryViewsByQuery.forEach(function(_,queryView){queriesProcessed.push(Promise.resolve().then(function(){var viewDocChanges=queryView.view.computeDocChanges(changes);return viewDocChanges.needsRefill?_this.localStore.executeQuery(queryView.query).then(function(docs){return queryView.view.computeDocChanges(docs,viewDocChanges)}):viewDocChanges}).then(function(viewDocChanges){var viewChange=queryView.view.applyChanges(viewDocChanges,
remoteEvent&&remoteEvent.targetChanges[queryView.targetId]);return _this.updateTrackedLimbos(queryView.targetId,viewChange.limboChanges).then(function(){if(viewChange.snapshot){newSnaps.push(viewChange.snapshot);var docChanges=LocalViewChanges.fromSnapshot(queryView.targetId,viewChange.snapshot);docChangesInAllViews.push(docChanges)}})}))});return Promise.all(queriesProcessed).then(function(){_this.viewHandler(newSnaps);_this.localStore.notifyLocalViewChanges(docChangesInAllViews);return _this.localStore.collectGarbage()})};
SyncEngine.prototype.assertSubscribed=function(fnName){assert(null!==this.viewHandler&&null!==this.errorHandler,"Trying to call "+fnName+" before calling subscribe().")};SyncEngine.prototype.handleUserChange=function(user){var _this=this;this.currentUser=user;return this.localStore.handleUserChange(user).then(function(changes){return _this.emitNewSnapsAndNotifyLocalStore(changes)}).then(function(){return _this.remoteStore.handleUserChange(user)})};SyncEngine.prototype.getRemoteKeysForTarget=function(targetId){var limboResolution=
this.limboResolutionsByTarget[targetId];return limboResolution&&limboResolution.receivedDocument?EMPTY_DOCUMENT_KEY_SET.add(limboResolution.key):this.queryViewsByTarget[targetId]?this.queryViewsByTarget[targetId].view.syncedDocuments:EMPTY_DOCUMENT_KEY_SET};return SyncEngine}(),MutationBatch=function(){function MutationBatch(batchId,localWriteTime,mutations){this.batchId=batchId;this.localWriteTime=localWriteTime;this.mutations=mutations}MutationBatch.prototype.applyToRemoteDocument=function(docKey,
maybeDoc,batchResult){maybeDoc&&assert(maybeDoc.key.isEqual(docKey),"applyToRemoteDocument: key "+docKey+" should match maybeDoc key\n        "+maybeDoc.key);batchResult=batchResult.mutationResults;assert(batchResult.length===this.mutations.length,"Mismatch between mutations length\n      ("+this.mutations.length+") and mutation results length\n      ("+batchResult.length+").");for(var i=0;i<this.mutations.length;i++){var mutation=this.mutations[i];mutation.key.isEqual(docKey)&&(maybeDoc=mutation.applyToRemoteDocument(maybeDoc,
batchResult[i]))}return maybeDoc};MutationBatch.prototype.applyToLocalView=function(docKey,maybeDoc){maybeDoc&&assert(maybeDoc.key.isEqual(docKey),"applyToLocalDocument: key "+docKey+" should match maybeDoc key\n        "+maybeDoc.key);for(var baseDoc=maybeDoc,i=0;i<this.mutations.length;i++){var mutation=this.mutations[i];mutation.key.isEqual(docKey)&&(maybeDoc=mutation.applyToLocalView(maybeDoc,baseDoc,this.localWriteTime))}return maybeDoc};MutationBatch.prototype.keys=function(){for(var keySet=
EMPTY_DOCUMENT_KEY_SET,_i=0,_a=this.mutations;_i<_a.length;_i++)keySet=keySet.add(_a[_i].key);return keySet};MutationBatch.prototype.isEqual=function(other){return this.batchId===other.batchId&&arrayEquals(this.mutations,other.mutations)};MutationBatch.prototype.isTombstone=function(){return 0===this.mutations.length};MutationBatch.prototype.toTombstone=function(){return new MutationBatch(this.batchId,this.localWriteTime,[])};return MutationBatch}(),MutationBatchResult=function(){function MutationBatchResult(batch,
commitVersion,mutationResults,streamToken,docVersions){this.batch=batch;this.commitVersion=commitVersion;this.mutationResults=mutationResults;this.streamToken=streamToken;this.docVersions=docVersions}MutationBatchResult.from=function(batch,commitVersion,results,streamToken){assert(batch.mutations.length===results.length,"Mutations sent "+batch.mutations.length+" must equal results received "+results.length);for(var versionMap=EMPTY_DOCUMENT_VERSION_MAP,mutations=batch.mutations,i=0;i<mutations.length;i++){var version=
results[i].version;null===version&&(version=commitVersion);versionMap=versionMap.insert(mutations[i].key,version)}return new MutationBatchResult(batch,commitVersion,results,streamToken,versionMap)};return MutationBatchResult}(),DbTimestamp=function(){return function(seconds,nanoseconds){this.seconds=seconds;this.nanoseconds=nanoseconds}}(),DbOwner=function(){function DbOwner(ownerId,leaseTimestampMs){this.ownerId=ownerId;this.leaseTimestampMs=leaseTimestampMs}DbOwner.store="owner";return DbOwner}(),
DbMutationQueue=function(){function DbMutationQueue(userId,lastAcknowledgedBatchId,lastStreamToken){this.userId=userId;this.lastAcknowledgedBatchId=lastAcknowledgedBatchId;this.lastStreamToken=lastStreamToken}DbMutationQueue.store="mutationQueues";DbMutationQueue.keyPath="userId";return DbMutationQueue}(),DbMutationBatch=function(){function DbMutationBatch(userId,batchId,localWriteTimeMs,mutations){this.userId=userId;this.batchId=batchId;this.localWriteTimeMs=localWriteTimeMs;this.mutations=mutations}
DbMutationBatch.store="mutations";DbMutationBatch.keyPath=["userId","batchId"];return DbMutationBatch}(),DbDocumentMutation=function(){function DbDocumentMutation(){}DbDocumentMutation.prefixForUser=function(userId){return[userId]};DbDocumentMutation.prefixForPath=function(userId,path){return[userId,encode(path)]};DbDocumentMutation.key=function(userId,path,batchId){return[userId,encode(path),batchId]};DbDocumentMutation.store="documentMutations";DbDocumentMutation.PLACEHOLDER=new DbDocumentMutation;
return DbDocumentMutation}(),DbNoDocument=function(){return function(path,readTime){this.path=path;this.readTime=readTime}}(),DbRemoteDocument=function(){function DbRemoteDocument(noDocument,document){this.noDocument=noDocument;this.document=document}DbRemoteDocument.store="remoteDocuments";return DbRemoteDocument}(),DbTarget=function(){function DbTarget(targetId,canonicalId,readTime,resumeToken,lastListenSequenceNumber,query){this.targetId=targetId;this.canonicalId=canonicalId;this.readTime=readTime;
this.resumeToken=resumeToken;this.lastListenSequenceNumber=lastListenSequenceNumber;this.query=query}DbTarget.store="targets";DbTarget.keyPath="targetId";DbTarget.queryTargetsIndexName="queryTargetsIndex";DbTarget.queryTargetsKeyPath=["canonicalId","targetId"];return DbTarget}(),DbTargetDocument=function(){function DbTargetDocument(targetId,path){this.targetId=targetId;this.path=path}DbTargetDocument.store="targetDocuments";DbTargetDocument.keyPath=["targetId","path"];DbTargetDocument.documentTargetsIndex=
"documentTargetsIndex";DbTargetDocument.documentTargetsKeyPath=["path","targetId"];return DbTargetDocument}(),DbTargetGlobal=function(){function DbTargetGlobal(highestTargetId,highestListenSequenceNumber,lastRemoteSnapshotVersion,targetCount){this.highestTargetId=highestTargetId;this.highestListenSequenceNumber=highestListenSequenceNumber;this.lastRemoteSnapshotVersion=lastRemoteSnapshotVersion;this.targetCount=targetCount}DbTargetGlobal.key="targetGlobalKey";DbTargetGlobal.store="targetGlobal";return DbTargetGlobal}(),
ALL_STORES=[DbMutationQueue.store,DbMutationBatch.store,DbDocumentMutation.store,DbRemoteDocument.store,DbTarget.store,DbOwner.store,DbTargetGlobal.store,DbTargetDocument.store],IndexedDbMutationQueue=function(){function IndexedDbMutationQueue(userId,serializer){this.userId=userId;this.serializer=serializer;this.garbageCollector=null}IndexedDbMutationQueue.forUser=function(user,serializer){assert(""!==user.uid,"UserID must not be an empty string.");user=user.isAuthenticated()?user.uid:"";return new IndexedDbMutationQueue(user,
serializer)};IndexedDbMutationQueue.prototype.start=function(transaction){var _this=this;return IndexedDbMutationQueue.loadNextBatchIdFromDb(transaction).next(function(nextBatchId){_this.nextBatchId=nextBatchId;return IndexedDbPersistence.getStore(transaction,DbMutationQueue.store).get(_this.userId)}).next(function(metadata){metadata||(metadata=new DbMutationQueue(_this.userId,-1,""));_this.metadata=metadata;return _this.metadata.lastAcknowledgedBatchId>=_this.nextBatchId?_this.checkEmpty(transaction).next(function(empty){assert(empty,
"Reset nextBatchID is only possible when the queue is empty");_this.metadata.lastAcknowledgedBatchId=-1;return IndexedDbPersistence.getStore(transaction,DbMutationQueue.store).put(_this.metadata)}):PersistencePromise.resolve()})};IndexedDbMutationQueue.loadNextBatchIdFromDb=function(txn){var maxBatchId=-1;return mutationsStore(txn).iterate({reverse:!0},function(key,batch,control){var userId=key[0];key[1]>maxBatchId&&(maxBatchId=batch.batchId);""===userId?control.done():(key=userId.length-1,userId=
0===userId.length?"":"\x00"===userId.charAt(key)?userId.substring(0,key):userId.substring(0,key)+String.fromCharCode(userId.charCodeAt(key)-1),control.skip([userId]))}).next(function(){return maxBatchId+1})};IndexedDbMutationQueue.prototype.checkEmpty=function(transaction){var empty=!0,range=IDBKeyRange.bound(this.keyForBatchId(Number.NEGATIVE_INFINITY),this.keyForBatchId(Number.POSITIVE_INFINITY));return mutationsStore(transaction).iterate({range:range},function(key,value,control){empty=!1;control.done()}).next(function(){return empty})};
IndexedDbMutationQueue.prototype.getNextBatchId=function(transaction){return PersistencePromise.resolve(this.nextBatchId)};IndexedDbMutationQueue.prototype.getHighestAcknowledgedBatchId=function(transaction){return PersistencePromise.resolve(this.metadata.lastAcknowledgedBatchId)};IndexedDbMutationQueue.prototype.acknowledgeBatch=function(transaction,batch,streamToken){batch=batch.batchId;assert(batch>this.metadata.lastAcknowledgedBatchId,"Mutation batchIDs must be acknowledged in order");this.metadata.lastAcknowledgedBatchId=
batch;this.metadata.lastStreamToken=convertStreamToken(streamToken);return IndexedDbPersistence.getStore(transaction,DbMutationQueue.store).put(this.metadata)};IndexedDbMutationQueue.prototype.getLastStreamToken=function(transaction){return PersistencePromise.resolve(this.metadata.lastStreamToken)};IndexedDbMutationQueue.prototype.setLastStreamToken=function(transaction,streamToken){this.metadata.lastStreamToken=convertStreamToken(streamToken);return IndexedDbPersistence.getStore(transaction,DbMutationQueue.store).put(this.metadata)};
IndexedDbMutationQueue.prototype.addMutationBatch=function(transaction,localWriteTime,mutations){var _this=this,batchId=this.nextBatchId;this.nextBatchId++;var batch=new MutationBatch(batchId,localWriteTime,mutations);localWriteTime=this.serializer.toDbMutationBatch(this.userId,batch);return mutationsStore(transaction).put(localWriteTime).next(function(){for(var promises=[],_i=0;_i<mutations.length;_i++){var indexKey=DbDocumentMutation.key(_this.userId,mutations[_i].key.path,batchId);promises.push(documentMutationsStore(transaction).put(indexKey,
DbDocumentMutation.PLACEHOLDER))}return PersistencePromise.waitFor(promises)}).next(function(){return batch})};IndexedDbMutationQueue.prototype.lookupMutationBatch=function(transaction,batchId){var _this=this;return mutationsStore(transaction).get(this.keyForBatchId(batchId)).next(function(dbBatch){return dbBatch?_this.serializer.fromDbMutationBatch(dbBatch):null})};IndexedDbMutationQueue.prototype.getNextMutationBatchAfterBatchId=function(transaction,batchId){var _this=this,nextBatchId=Math.max(batchId,
this.metadata.lastAcknowledgedBatchId)+1;batchId=IDBKeyRange.lowerBound(this.keyForBatchId(nextBatchId));var foundBatch=null;return mutationsStore(transaction).iterate({range:batchId},function(key,dbBatch,control){dbBatch.userId===_this.userId&&(assert(dbBatch.batchId>=nextBatchId,"Should have found mutation after "+nextBatchId),foundBatch=_this.serializer.fromDbMutationBatch(dbBatch));control.done()}).next(function(){return foundBatch})};IndexedDbMutationQueue.prototype.getAllMutationBatches=function(transaction){var _this=
this,range=IDBKeyRange.bound(this.keyForBatchId(-1),this.keyForBatchId(Number.POSITIVE_INFINITY));return mutationsStore(transaction).loadAll(range).next(function(dbBatches){return dbBatches.map(function(dbBatch){return _this.serializer.fromDbMutationBatch(dbBatch)})})};IndexedDbMutationQueue.prototype.getAllMutationBatchesThroughBatchId=function(transaction,batchId){var _this=this;batchId=IDBKeyRange.bound(this.keyForBatchId(-1),this.keyForBatchId(batchId));return mutationsStore(transaction).loadAll(batchId).next(function(dbBatches){return dbBatches.map(function(dbBatch){return _this.serializer.fromDbMutationBatch(dbBatch)})})};
IndexedDbMutationQueue.prototype.getAllMutationBatchesAffectingDocumentKey=function(transaction,documentKey){var _this=this,indexPrefix=DbDocumentMutation.prefixForPath(this.userId,documentKey.path);indexPrefix=IDBKeyRange.lowerBound(indexPrefix);var results=[];return documentMutationsStore(transaction).iterate({range:indexPrefix},function(indexKey,_,control){_=indexKey[0];var batchID=indexKey[2],path=decode$1(indexKey[1]);if(_===_this.userId&&documentKey.path.isEqual(path)){var mutationKey=_this.keyForBatchId(batchID);
return mutationsStore(transaction).get(mutationKey).next(function(dbBatch){null===dbBatch&&fail("Dangling document-mutation reference found: "+indexKey+" which points to "+mutationKey);results.push(_this.serializer.fromDbMutationBatch(dbBatch))})}control.done()}).next(function(){return results})};IndexedDbMutationQueue.prototype.getAllMutationBatchesAffectingDocumentKeys=function(transaction,documentKeys){var _this=this,uniqueBatchIDs=new SortedSet(primitiveComparator),promises=[];documentKeys.forEach(function(documentKey){var indexStart=
DbDocumentMutation.prefixForPath(_this.userId,documentKey.path);indexStart=IDBKeyRange.lowerBound(indexStart);indexStart=documentMutationsStore(transaction).iterate({range:indexStart},function(indexKey,_,control){_=indexKey[0];var batchID=indexKey[2];indexKey=decode$1(indexKey[1]);_===_this.userId&&documentKey.path.isEqual(indexKey)?uniqueBatchIDs=uniqueBatchIDs.add(batchID):control.done()});promises.push(indexStart)});return PersistencePromise.waitFor(promises).next(function(){return _this.lookupMutationBatches(transaction,
uniqueBatchIDs)})};IndexedDbMutationQueue.prototype.getAllMutationBatchesAffectingQuery=function(transaction,query){var _this=this;assert(!query.isDocumentQuery(),"Document queries shouldn't go down this path");var queryPath=query.path,immediateChildrenLength=queryPath.length+1;query=DbDocumentMutation.prefixForPath(this.userId,queryPath);query=IDBKeyRange.lowerBound(query);var uniqueBatchIDs=new SortedSet(primitiveComparator);return documentMutationsStore(transaction).iterate({range:query},function(indexKey,
_,control){_=indexKey[0];var batchID=indexKey[2];indexKey=decode$1(indexKey[1]);_===_this.userId&&queryPath.isPrefixOf(indexKey)?indexKey.length===immediateChildrenLength&&(uniqueBatchIDs=uniqueBatchIDs.add(batchID)):control.done()}).next(function(){return _this.lookupMutationBatches(transaction,uniqueBatchIDs)})};IndexedDbMutationQueue.prototype.lookupMutationBatches=function(transaction,batchIDs){var _this=this,results=[],promises=[];batchIDs.forEach(function(batchID){var mutationKey=_this.keyForBatchId(batchID);
promises.push(mutationsStore(transaction).get(mutationKey).next(function(mutation){null===mutation&&fail("Dangling document-mutation reference found, which points to "+mutationKey);results.push(_this.serializer.fromDbMutationBatch(mutation))}))});return PersistencePromise.waitFor(promises).next(function(){return results})};IndexedDbMutationQueue.prototype.removeMutationBatches=function(transaction,batches){var txn=mutationsStore(transaction),indexTxn=documentMutationsStore(transaction),promises=[];
transaction=function(batch){var range=IDBKeyRange.only(this_1.keyForBatchId(batch.batchId)),numDeleted=0;range=txn.iterate({range:range},function(key,value,control){numDeleted++;return control.delete()});promises.push(range.next(function(){assert(1===numDeleted,"Dangling document-mutation reference found: Missing batch "+batch.batchId)}));range=0;for(var _a=batch.mutations;range<_a.length;range++){var mutation=_a[range],indexKey=DbDocumentMutation.key(this_1.userId,mutation.key.path,batch.batchId);
promises.push(indexTxn.delete(indexKey));null!==this_1.garbageCollector&&this_1.garbageCollector.addPotentialGarbageKey(mutation.key)}};for(var this_1=this,_i=0;_i<batches.length;_i++)transaction(batches[_i]);return PersistencePromise.waitFor(promises)};IndexedDbMutationQueue.prototype.performConsistencyCheck=function(txn){var _this=this;return this.checkEmpty(txn).next(function(empty){if(!empty)return PersistencePromise.resolve();empty=IDBKeyRange.lowerBound(DbDocumentMutation.prefixForUser(_this.userId));
var danglingMutationReferences=[];return documentMutationsStore(txn).iterate({range:empty},function(key,_,control){key[0]!==_this.userId?control.done():(key=decode$1(key[1]),danglingMutationReferences.push(key))}).next(function(){assert(0===danglingMutationReferences.length,"Document leak -- detected dangling mutation references when queue is empty. Dangling keys: "+danglingMutationReferences.map(function(p){return p.canonicalString()}))})})};IndexedDbMutationQueue.prototype.setGarbageCollector=function(gc){this.garbageCollector=
gc};IndexedDbMutationQueue.prototype.containsKey=function(txn,key$jscomp$0){var _this=this;key$jscomp$0=DbDocumentMutation.prefixForPath(this.userId,key$jscomp$0.path);var encodedPath=key$jscomp$0[1];key$jscomp$0=IDBKeyRange.lowerBound(key$jscomp$0);var containsKey=!1;return documentMutationsStore(txn).iterate({range:key$jscomp$0,keysOnly:!0},function(key,value,control){value=key[1];key[0]===_this.userId&&value===encodedPath&&(containsKey=!0);control.done()}).next(function(){return containsKey})};
IndexedDbMutationQueue.prototype.keyForBatchId=function(batchId){return[this.userId,batchId]};return IndexedDbMutationQueue}(),IndexedDbQueryCache=function(){function IndexedDbQueryCache(serializer){this.serializer=serializer;this.lastRemoteSnapshotVersion=SnapshotVersion.MIN;this.garbageCollector=this.metadata=null}IndexedDbQueryCache.prototype.start=function(transaction){var _this=this;return IndexedDbPersistence.getStore(transaction,DbTargetGlobal.store).get(DbTargetGlobal.key).next(function(metadata){assert(null!==
metadata,"Missing metadata row that should be added by schema migration.");_this.metadata=metadata;metadata=metadata.lastRemoteSnapshotVersion;_this.lastRemoteSnapshotVersion=SnapshotVersion.fromTimestamp(new Timestamp(metadata.seconds,metadata.nanoseconds));return PersistencePromise.resolve()})};IndexedDbQueryCache.prototype.getHighestTargetId=function(){return this.metadata.highestTargetId};IndexedDbQueryCache.prototype.getLastRemoteSnapshotVersion=function(){return this.lastRemoteSnapshotVersion};
IndexedDbQueryCache.prototype.setLastRemoteSnapshotVersion=function(transaction,snapshotVersion){this.lastRemoteSnapshotVersion=snapshotVersion;this.metadata.lastRemoteSnapshotVersion=snapshotVersion.toTimestamp();return IndexedDbPersistence.getStore(transaction,DbTargetGlobal.store).put(DbTargetGlobal.key,this.metadata)};IndexedDbQueryCache.prototype.addQueryData=function(transaction,queryData){var _this=this;return this.saveQueryData(transaction,queryData).next(function(){_this.metadata.targetCount+=
1;_this.updateMetadataFromQueryData(queryData);return _this.saveMetadata(transaction)})};IndexedDbQueryCache.prototype.updateQueryData=function(transaction,queryData){var _this=this;return this.saveQueryData(transaction,queryData).next(function(){return _this.updateMetadataFromQueryData(queryData)?_this.saveMetadata(transaction):PersistencePromise.resolve()})};IndexedDbQueryCache.prototype.removeQueryData=function(transaction,queryData){var _this=this;assert(0<this.metadata.targetCount,"Removing from an empty query cache");
return this.removeMatchingKeysForTargetId(transaction,queryData.targetId).next(function(){return IndexedDbPersistence.getStore(transaction,DbTarget.store).delete(queryData.targetId)}).next(function(){--_this.metadata.targetCount;return _this.saveMetadata(transaction)})};IndexedDbQueryCache.prototype.saveMetadata=function(transaction){return IndexedDbPersistence.getStore(transaction,DbTargetGlobal.store).put(DbTargetGlobal.key,this.metadata)};IndexedDbQueryCache.prototype.saveQueryData=function(transaction,
queryData){return IndexedDbPersistence.getStore(transaction,DbTarget.store).put(this.serializer.toDbTarget(queryData))};IndexedDbQueryCache.prototype.updateMetadataFromQueryData=function(queryData){var needsUpdate=!1;queryData.targetId>this.metadata.highestTargetId&&(this.metadata.highestTargetId=queryData.targetId,needsUpdate=!0);return needsUpdate};Object.defineProperty(IndexedDbQueryCache.prototype,"count",{get:function(){return this.metadata.targetCount},enumerable:!0,configurable:!0});IndexedDbQueryCache.prototype.getQueryData=
function(transaction,query){var _this=this,canonicalId=query.canonicalId();canonicalId=IDBKeyRange.bound([canonicalId,Number.NEGATIVE_INFINITY],[canonicalId,Number.POSITIVE_INFINITY]);var result=null;return IndexedDbPersistence.getStore(transaction,DbTarget.store).iterate({range:canonicalId,index:DbTarget.queryTargetsIndexName},function(key,value,control){key=_this.serializer.fromDbTarget(value);query.isEqual(key.query)&&(result=key,control.done())}).next(function(){return result})};IndexedDbQueryCache.prototype.addMatchingKeys=
function(txn,keys,targetId){var promises=[],store=documentTargetStore(txn);keys.forEach(function(key){key=encode(key.path);promises.push(store.put(new DbTargetDocument(targetId,key)))});return PersistencePromise.waitFor(promises)};IndexedDbQueryCache.prototype.removeMatchingKeys=function(txn,keys,targetId){var _this=this,promises=[],store=documentTargetStore(txn);keys.forEach(function(key){var path=encode(key.path);promises.push(store.delete([targetId,path]));null!==_this.garbageCollector&&_this.garbageCollector.addPotentialGarbageKey(key)});
return PersistencePromise.waitFor(promises)};IndexedDbQueryCache.prototype.removeMatchingKeysForTargetId=function(txn,targetId){var store=documentTargetStore(txn),range=IDBKeyRange.bound([targetId],[targetId+1],!1,!0);return this.notifyGCForRemovedKeys(txn,range).next(function(){return store.delete(range)})};IndexedDbQueryCache.prototype.notifyGCForRemovedKeys=function(txn,range){var _this=this;txn=documentTargetStore(txn);return null!==this.garbageCollector&&this.garbageCollector.isEager?txn.iterate({range:range,
keysOnly:!0},function(key,_,control){key=decode$1(key[1]);key=new DocumentKey(key);assert(null!==_this.garbageCollector,"GarbageCollector for query cache set to null during key removal.");_this.garbageCollector.addPotentialGarbageKey(key)}):PersistencePromise.resolve()};IndexedDbQueryCache.prototype.getMatchingKeysForTargetId=function(txn,targetId){targetId=IDBKeyRange.bound([targetId],[targetId+1],!1,!0);txn=documentTargetStore(txn);var result=EMPTY_DOCUMENT_KEY_SET;return txn.iterate({range:targetId,
keysOnly:!0},function(key,_,control){key=decode$1(key[1]);key=new DocumentKey(key);result=result.add(key)}).next(function(){return result})};IndexedDbQueryCache.prototype.setGarbageCollector=function(gc){this.garbageCollector=gc};IndexedDbQueryCache.prototype.containsKey=function(txn,key$jscomp$0){assert(null!==txn,"Persistence Transaction cannot be null for query cache containsKey");key$jscomp$0=encode(key$jscomp$0.path);key$jscomp$0=IDBKeyRange.bound([key$jscomp$0],[key$jscomp$0+"\x00"],!1,!0);
var count=0;return documentTargetStore(txn).iterate({index:DbTargetDocument.documentTargetsIndex,keysOnly:!0,range:key$jscomp$0},function(key,_,control){count++;control.done()}).next(function(){return 0<count})};return IndexedDbQueryCache}(),IndexedDbRemoteDocumentCache=function(){function IndexedDbRemoteDocumentCache(serializer){this.serializer=serializer}IndexedDbRemoteDocumentCache.prototype.addEntry=function(transaction,maybeDocument){return IndexedDbPersistence.getStore(transaction,DbRemoteDocument.store).put(maybeDocument.key.path.toArray(),
this.serializer.toDbRemoteDocument(maybeDocument))};IndexedDbRemoteDocumentCache.prototype.removeEntry=function(transaction,documentKey){return IndexedDbPersistence.getStore(transaction,DbRemoteDocument.store).delete(documentKey.path.toArray())};IndexedDbRemoteDocumentCache.prototype.getEntry=function(transaction,documentKey){var _this=this;return IndexedDbPersistence.getStore(transaction,DbRemoteDocument.store).get(documentKey.path.toArray()).next(function(dbRemoteDoc){return dbRemoteDoc?_this.serializer.fromDbRemoteDocument(dbRemoteDoc):
null})};IndexedDbRemoteDocumentCache.prototype.getDocumentsMatchingQuery=function(transaction,query){var _this=this,results=EMPTY_DOCUMENT_MAP,startKey=query.path.toArray();startKey=IDBKeyRange.lowerBound(startKey);return IndexedDbPersistence.getStore(transaction,DbRemoteDocument.store).iterate({range:startKey},function(key,dbRemoteDoc,control){key=_this.serializer.fromDbRemoteDocument(dbRemoteDoc);query.path.isPrefixOf(key.key.path)?key instanceof Document$jscomp$0&&query.matches(key)&&(results=
results.insert(key.key,key)):control.done()}).next(function(){return results})};return IndexedDbRemoteDocumentCache}(),LocalSerializer=function(){function LocalSerializer(remoteSerializer){this.remoteSerializer=remoteSerializer}LocalSerializer.prototype.fromDbRemoteDocument=function(remoteDoc){if(remoteDoc.document)return this.remoteSerializer.fromDocument(remoteDoc.document);if(remoteDoc.noDocument){var key=DocumentKey.fromSegments(remoteDoc.noDocument.path);remoteDoc=remoteDoc.noDocument.readTime;
remoteDoc=new Timestamp(remoteDoc.seconds,remoteDoc.nanoseconds);return new NoDocument(key,SnapshotVersion.fromTimestamp(remoteDoc))}return fail("Unexpected DbRemoteDocument")};LocalSerializer.prototype.toDbRemoteDocument=function(maybeDoc){if(maybeDoc instanceof Document$jscomp$0){var doc=this.remoteSerializer.toDocument(maybeDoc);return new DbRemoteDocument(null,doc)}doc=maybeDoc.key.path.toArray();maybeDoc=maybeDoc.version.toTimestamp();maybeDoc=new DbTimestamp(maybeDoc.seconds,maybeDoc.nanoseconds);
return new DbRemoteDocument(new DbNoDocument(doc,maybeDoc),null)};LocalSerializer.prototype.toDbMutationBatch=function(userId,batch){var _this=this,serializedMutations=batch.mutations.map(function(m){return _this.remoteSerializer.toMutation(m)});return new DbMutationBatch(userId,batch.batchId,batch.localWriteTime.toMillis(),serializedMutations)};LocalSerializer.prototype.fromDbMutationBatch=function(dbBatch){var _this=this,mutations=dbBatch.mutations.map(function(m){return _this.remoteSerializer.fromMutation(m)}),
timestamp=Timestamp.fromMillis(dbBatch.localWriteTimeMs);return new MutationBatch(dbBatch.batchId,timestamp,mutations)};LocalSerializer.prototype.fromDbTarget=function(dbTarget){var readTime=new Timestamp(dbTarget.readTime.seconds,dbTarget.readTime.nanoseconds);readTime=SnapshotVersion.fromTimestamp(readTime);var query=void 0!==dbTarget.query.documents?this.remoteSerializer.fromDocumentsTarget(dbTarget.query):this.remoteSerializer.fromQueryTarget(dbTarget.query);return new QueryData(query,dbTarget.targetId,
QueryPurpose.Listen,readTime,dbTarget.resumeToken)};LocalSerializer.prototype.toDbTarget=function(queryData){assert(QueryPurpose.Listen===queryData.purpose,"Only queries with purpose "+QueryPurpose.Listen+" may be stored, got "+queryData.purpose);var timestamp=queryData.snapshotVersion.toTimestamp();timestamp=new DbTimestamp(timestamp.seconds,timestamp.nanoseconds);var queryProto=queryData.query.isDocumentQuery()?this.remoteSerializer.toDocumentsTarget(queryData.query):this.remoteSerializer.toQueryTarget(queryData.query);
if(queryData.resumeToken instanceof Uint8Array){assert("YES"===process.env.USE_MOCK_PERSISTENCE,"Persisting non-string stream tokens is only supported with mock persistence .");var resumeToken=queryData.resumeToken.toString()}else resumeToken=queryData.resumeToken;return new DbTarget(queryData.targetId,queryData.query.canonicalId(),timestamp,resumeToken,0,queryProto)};return LocalSerializer}(),PersistenceTransaction=function(){return function(){}}(),Deferred$1=function(){return function(){var _this=
this;this.promise=new Promise(function(resolve,reject){_this.resolve=resolve;_this.reject=reject})}}(),SimpleDb=function(){function SimpleDb(db){this.db=db}SimpleDb.openOrCreate=function(name,version,runUpgrade){assert(SimpleDb.isAvailable(),"IndexedDB not supported in current environment.");debug("SimpleDb","Opening database:",name);return(new PersistencePromise(function(resolve,reject){var request=window.indexedDB.open(name,version);request.onsuccess=function(event){resolve(new SimpleDb(event.target.result))};
request.onblocked=function(){reject(new FirestoreError(Code.FAILED_PRECONDITION,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))};request.onerror=function(event){reject(event.target.error)};request.onupgradeneeded=function(event){debug("SimpleDb",'Database "'+name+'" requires upgrade from version:',event.oldVersion);var db=event.target.result,txn=new SimpleDbTransaction(request.transaction);runUpgrade(db,txn,event.oldVersion,
3).next(function(){debug("SimpleDb","Database upgrade to version 3 complete")})}})).toPromise()};SimpleDb.delete=function(name){debug("SimpleDb","Removing database:",name);return wrapRequest(window.indexedDB.deleteDatabase(name)).toPromise()};SimpleDb.isAvailable=function(){if("undefined"===typeof window||null==window.indexedDB)return!1;if(void 0===window.navigator)return"YES"===process.env.USE_MOCK_PERSISTENCE;var ua=window.navigator.userAgent;return 0<ua.indexOf("MSIE ")||0<ua.indexOf("Trident/")||
0<ua.indexOf("Edge/")?!1:!0};SimpleDb.getStore=function(txn,store){return txn.store(store)};SimpleDb.prototype.runTransaction=function(mode,objectStores,transactionFn){var transaction=SimpleDbTransaction.open(this.db,mode,objectStores),transactionFnResult=transactionFn(transaction).catch(function(error$$1){transaction.abort(error$$1)}).toPromise();return transaction.completionPromise.then(function(){return transactionFnResult})};SimpleDb.prototype.close=function(){this.db.close()};return SimpleDb}(),
IterationController=function(){function IterationController(dbCursor){this.dbCursor=dbCursor;this.shouldStop=!1;this.nextKey=null}Object.defineProperty(IterationController.prototype,"isDone",{get:function(){return this.shouldStop},enumerable:!0,configurable:!0});Object.defineProperty(IterationController.prototype,"skipToKey",{get:function(){return this.nextKey},enumerable:!0,configurable:!0});Object.defineProperty(IterationController.prototype,"cursor",{set:function(value){this.dbCursor=value},enumerable:!0,
configurable:!0});IterationController.prototype.done=function(){this.shouldStop=!0};IterationController.prototype.skip=function(key){this.nextKey=key};IterationController.prototype.delete=function(){return wrapRequest(this.dbCursor.delete())};return IterationController}(),SimpleDbTransaction=function(){function SimpleDbTransaction(transaction){var _this=this;this.transaction=transaction;this.aborted=!1;this.completionDeferred=new Deferred$1;this.transaction.oncomplete=function(){_this.completionDeferred.resolve()};
this.transaction.onabort=function(){transaction.error?_this.completionDeferred.reject(transaction.error):_this.completionDeferred.resolve()};this.transaction.onerror=function(event){_this.completionDeferred.reject(event.target.error)}}SimpleDbTransaction.open=function(db,mode,objectStoreNames){return new SimpleDbTransaction(db.transaction(objectStoreNames,mode))};Object.defineProperty(SimpleDbTransaction.prototype,"completionPromise",{get:function(){return this.completionDeferred.promise},enumerable:!0,
configurable:!0});SimpleDbTransaction.prototype.abort=function(error$$1){error$$1&&this.completionDeferred.reject(error$$1);this.aborted||(debug("SimpleDb","Aborting transaction: %s",error$$1?error$$1.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())};SimpleDbTransaction.prototype.store=function(storeName){var store=this.transaction.objectStore(storeName);assert(!!store,"Object store not part of transaction: "+storeName);return new SimpleDbStore(store)};return SimpleDbTransaction}(),
SimpleDbStore=function(){function SimpleDbStore(store){this.store=store}SimpleDbStore.prototype.put=function(keyOrValue,value){void 0!==value?(debug("SimpleDb","PUT",this.store.name,keyOrValue,value),keyOrValue=this.store.put(value,keyOrValue)):(debug("SimpleDb","PUT",this.store.name,"\x3cauto-key\x3e",keyOrValue),keyOrValue=this.store.put(keyOrValue));return wrapRequest(keyOrValue)};SimpleDbStore.prototype.get=function(key){var _this=this,request=this.store.get(key);return wrapRequest(request).next(function(result){void 0===
result&&(result=null);debug("SimpleDb","GET",_this.store.name,key,result);return result})};SimpleDbStore.prototype.delete=function(key){debug("SimpleDb","DELETE",this.store.name,key);key=this.store.delete(key);return wrapRequest(key)};SimpleDbStore.prototype.count=function(){debug("SimpleDb","COUNT",this.store.name);var request=this.store.count();return wrapRequest(request)};SimpleDbStore.prototype.loadAll=function(indexOrRange,range){indexOrRange=this.cursor(this.options(indexOrRange,range));var results=
[];return this.iterateCursor(indexOrRange,function(key,value){results.push(value)}).next(function(){return results})};SimpleDbStore.prototype.deleteAll=function(indexOrRange,range){debug("SimpleDb","DELETE ALL",this.store.name);indexOrRange=this.options(indexOrRange,range);indexOrRange.keysOnly=!1;indexOrRange=this.cursor(indexOrRange);return this.iterateCursor(indexOrRange,function(key,value,control){return control.delete()})};SimpleDbStore.prototype.iterate=function(optionsOrCallback,callback){if(callback)var options=
optionsOrCallback;else options={},callback=optionsOrCallback;optionsOrCallback=this.cursor(options);return this.iterateCursor(optionsOrCallback,callback)};SimpleDbStore.prototype.iterateCursor=function(cursorRequest,fn){var results=[];return(new PersistencePromise(function(resolve,reject){cursorRequest.onerror=function(event){reject(event.target.error)};cursorRequest.onsuccess=function(event){if(event=event.target.result){var controller=new IterationController(event),userResult=fn(event.primaryKey,
event.value,controller);userResult instanceof PersistencePromise&&results.push(userResult);controller.isDone?resolve():null===controller.skipToKey?event.continue():event.continue(controller.skipToKey)}else resolve()}})).next(function(){return PersistencePromise.waitFor(results)})};SimpleDbStore.prototype.options=function(indexOrRange,range){var indexName=void 0;void 0!==indexOrRange&&("string"===typeof indexOrRange?indexName=indexOrRange:(assert(void 0===range,"3rd argument must not be defined if 2nd is a range."),
range=indexOrRange));return{index:indexName,range:range}};SimpleDbStore.prototype.cursor=function(options){var direction="next";options.reverse&&(direction="prev");if(options.index){var index=this.store.index(options.index);return options.keysOnly?index.openKeyCursor(options.range,direction):index.openCursor(options.range,direction)}return this.store.openCursor(options.range,direction)};return SimpleDbStore}(),IndexedDbTransaction=function(_super){function IndexedDbTransaction(simpleDbTransaction){var _this=
_super.call(this)||this;_this.simpleDbTransaction=simpleDbTransaction;return _this}tslib_1.__extends(IndexedDbTransaction,_super);return IndexedDbTransaction}(PersistenceTransaction),IndexedDbPersistence=function(){function IndexedDbPersistence(prefix,serializer){this._started=!1;this.ownerId=this.generateOwnerId();this.dbName=prefix+IndexedDbPersistence.MAIN_DATABASE;this.serializer=new LocalSerializer(serializer);this.localStoragePrefix=prefix}IndexedDbPersistence.getStore=function(txn,store){if(txn instanceof
IndexedDbTransaction)return SimpleDb.getStore(txn.simpleDbTransaction,store);fail("IndexedDbPersistence must use instances of IndexedDbTransaction")};IndexedDbPersistence.prototype.start=function(){var _this=this;if(!IndexedDbPersistence.isAvailable())return this.persistenceError=new FirestoreError(Code.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled."),Promise.reject(this.persistenceError);assert(!this.started,
"IndexedDbPersistence double-started!");return SimpleDb.openOrCreate(this.dbName,3,createOrUpgradeDb).then(function(db){_this.simpleDb=db}).then(function(){return _this.tryAcquireOwnerLease()}).then(function(){_this.scheduleOwnerLeaseRefreshes();_this.attachWindowUnloadHook()}).then(function(){_this._started=!0})};IndexedDbPersistence.prototype.shutdown=function(deleteData){var _this=this;assert(this.started,"IndexedDbPersistence shutdown without start!");this._started=!1;this.detachWindowUnloadHook();
this.stopOwnerLeaseRefreshes();return this.releaseOwnerLease().then(function(){_this.simpleDb.close();if(deleteData)return SimpleDb.delete(_this.dbName)})};Object.defineProperty(IndexedDbPersistence.prototype,"started",{get:function(){return this._started},enumerable:!0,configurable:!0});IndexedDbPersistence.prototype.getMutationQueue=function(user){return IndexedDbMutationQueue.forUser(user,this.serializer)};IndexedDbPersistence.prototype.getQueryCache=function(){return new IndexedDbQueryCache(this.serializer)};
IndexedDbPersistence.prototype.getRemoteDocumentCache=function(){return new IndexedDbRemoteDocumentCache(this.serializer)};IndexedDbPersistence.prototype.runTransaction=function(action,operation){var _this=this;if(this.persistenceError)return Promise.reject(this.persistenceError);debug("IndexedDbPersistence","Starting transaction:",action);return this.simpleDb.runTransaction("readwrite",ALL_STORES,function(simpleDbTxn){return _this.ensureOwnerLease(simpleDbTxn).next(function(){return operation(new IndexedDbTransaction(simpleDbTxn))})})};
IndexedDbPersistence.isAvailable=function(){return SimpleDb.isAvailable()};IndexedDbPersistence.buildStoragePrefix=function(databaseInfo){var database=databaseInfo.databaseId.projectId;databaseInfo.databaseId.isDefaultDatabase||(database+="."+databaseInfo.databaseId.database);return"firestore/"+databaseInfo.persistenceKey+"/"+database+"/"};IndexedDbPersistence.prototype.tryAcquireOwnerLease=function(){var _this=this;return this.simpleDb.runTransaction("readwrite",[DbOwner.store],function(txn){var store=
txn.store(DbOwner.store);return store.get("owner").next(function(dbOwner){if(_this.validOwner(dbOwner))return debug("IndexedDbPersistence","Valid owner already. Failing. Current owner:",dbOwner),_this.persistenceError=new FirestoreError(Code.FAILED_PRECONDITION,"There is another tab open with offline persistence enabled. Only one such tab is allowed at a time. The other tab must be closed or persistence must be disabled."),PersistencePromise.reject(_this.persistenceError);var newDbOwner=new DbOwner(_this.ownerId,
Date.now());debug("IndexedDbPersistence","No valid owner. Acquiring owner lease. Current owner:",dbOwner,"New owner:",newDbOwner);return store.put("owner",newDbOwner)})})};IndexedDbPersistence.prototype.releaseOwnerLease=function(){var _this=this;return this.simpleDb.runTransaction("readwrite",[DbOwner.store],function(txn){var store=txn.store(DbOwner.store);return store.get("owner").next(function(dbOwner){return null!==dbOwner&&dbOwner.ownerId===_this.ownerId?(debug("IndexedDbPersistence","Releasing owner lease."),
store.delete("owner")):PersistencePromise.resolve()})})};IndexedDbPersistence.prototype.ensureOwnerLease=function(txn){var _this=this;return txn.store(DbOwner.store).get("owner").next(function(dbOwner){return null===dbOwner||dbOwner.ownerId!==_this.ownerId?(_this.persistenceError=new FirestoreError(Code.FAILED_PRECONDITION,"There is another tab open with offline persistence enabled. Only one such tab is allowed at a time. The other tab must be closed or persistence must be disabled."),PersistencePromise.reject(_this.persistenceError)):
PersistencePromise.resolve()})};IndexedDbPersistence.prototype.validOwner=function(dbOwner){var now=Date.now();return null===dbOwner||dbOwner.leaseTimestampMs<now-5E3?!1:dbOwner.leaseTimestampMs>now?(error$jscomp$0("Persistence owner-lease is in the future. Discarding.",dbOwner),!1):dbOwner.ownerId===this.getZombiedOwnerId()?!1:!0};IndexedDbPersistence.prototype.scheduleOwnerLeaseRefreshes=function(){var _this=this;this.ownerLeaseRefreshHandle=setInterval(function(){_this.simpleDb.runTransaction("readwrite",
ALL_STORES,function(txn){return _this.ensureOwnerLease(txn).next(function(){return txn.store(DbOwner.store).put("owner",new DbOwner(_this.ownerId,Date.now()))})}).catch(function(reason){error$jscomp$0(reason);_this.stopOwnerLeaseRefreshes()})},4E3)};IndexedDbPersistence.prototype.stopOwnerLeaseRefreshes=function(){this.ownerLeaseRefreshHandle&&(clearInterval(this.ownerLeaseRefreshHandle),this.ownerLeaseRefreshHandle=null)};IndexedDbPersistence.prototype.attachWindowUnloadHook=function(){var _this=
this;"object"===typeof window&&"function"===typeof window.addEventListener&&(this.windowUnloadHandler=function(){_this.setZombiedOwnerId(_this.ownerId);_this.shutdown()},window.addEventListener("unload",this.windowUnloadHandler))};IndexedDbPersistence.prototype.detachWindowUnloadHook=function(){this.windowUnloadHandler&&(assert("object"===typeof window&&"function"===typeof window.removeEventListener,"Expected 'window.removeEventListener' to be a function"),window.removeEventListener("unload",this.windowUnloadHandler),
this.windowUnloadHandler=null)};IndexedDbPersistence.prototype.getZombiedOwnerId=function(){try{var zombiedOwnerId=window.localStorage.getItem(this.zombiedOwnerLocalStorageKey());debug("IndexedDbPersistence","Zombied ownerID from LocalStorage:",zombiedOwnerId);return zombiedOwnerId}catch(e){return error$jscomp$0("Failed to get zombie owner id.",e),null}};IndexedDbPersistence.prototype.setZombiedOwnerId=function(zombieOwnerId){try{null===zombieOwnerId?window.localStorage.removeItem(this.zombiedOwnerLocalStorageKey()):
window.localStorage.setItem(this.zombiedOwnerLocalStorageKey(),zombieOwnerId)}catch(e){error$jscomp$0("Failed to set zombie owner id.",e)}};IndexedDbPersistence.prototype.zombiedOwnerLocalStorageKey=function(){return this.localStoragePrefix+"zombiedOwnerId"};IndexedDbPersistence.prototype.generateOwnerId=function(){return AutoId.newId()};IndexedDbPersistence.MAIN_DATABASE="main";return IndexedDbPersistence}(),LocalDocumentsView=function(){function LocalDocumentsView(remoteDocumentCache,mutationQueue){this.remoteDocumentCache=
remoteDocumentCache;this.mutationQueue=mutationQueue}LocalDocumentsView.prototype.getDocument=function(transaction,key){var _this=this;return this.mutationQueue.getAllMutationBatchesAffectingDocumentKey(transaction,key).next(function(batches){return _this.getDocumentInternal(transaction,key,batches)})};LocalDocumentsView.prototype.getDocumentInternal=function(transaction,key,inBatches){return this.remoteDocumentCache.getEntry(transaction,key).next(function(doc){for(var _i=0;_i<inBatches.length;_i++)doc=
inBatches[_i].applyToLocalView(key,doc);return doc})};LocalDocumentsView.prototype.getDocuments=function(transaction,keys){var _this=this;return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(transaction,keys).next(function(batches){var promises=[],results=EMPTY_MAYBE_DOCUMENT_MAP;keys.forEach(function(key){promises.push(_this.getDocumentInternal(transaction,key,batches).next(function(maybeDoc){maybeDoc||(maybeDoc=new NoDocument(key,SnapshotVersion.forDeletedDoc()));results=results.insert(key,
maybeDoc)}))});return PersistencePromise.waitFor(promises).next(function(){return results})})};LocalDocumentsView.prototype.getDocumentsMatchingQuery=function(transaction,query){return DocumentKey.isDocumentKey(query.path)?this.getDocumentsMatchingDocumentQuery(transaction,query.path):this.getDocumentsMatchingCollectionQuery(transaction,query)};LocalDocumentsView.prototype.getDocumentsMatchingDocumentQuery=function(transaction,docPath){return this.getDocument(transaction,new DocumentKey(docPath)).next(function(maybeDoc){var result=
EMPTY_DOCUMENT_MAP;maybeDoc instanceof Document$jscomp$0&&(result=result.insert(maybeDoc.key,maybeDoc));return result})};LocalDocumentsView.prototype.getDocumentsMatchingCollectionQuery=function(transaction,query){var _this=this,results;return this.remoteDocumentCache.getDocumentsMatchingQuery(transaction,query).next(function(queryResults){results=queryResults;return _this.mutationQueue.getAllMutationBatchesAffectingQuery(transaction,query)}).next(function(matchingMutationBatches){for(var _i=0;_i<
matchingMutationBatches.length;_i++)for(var batch=matchingMutationBatches[_i],_a=0,_b=batch.mutations;_a<_b.length;_a++){var mutation=_b[_a],key=mutation.key;if(query.path.isImmediateParentOf(key.path)){var baseDoc=results.get(key);mutation=mutation.applyToLocalView(baseDoc,baseDoc,batch.localWriteTime);!mutation||mutation instanceof NoDocument?results=results.remove(key):mutation instanceof Document$jscomp$0?results=results.insert(key,mutation):fail("Unknown MaybeDocument: "+mutation)}}}).next(function(){results.forEach(function(key,
doc){query.matches(doc)||(results=results.remove(key))});return results})};return LocalDocumentsView}(),RemoteDocumentChangeBuffer=function(){function RemoteDocumentChangeBuffer(remoteDocumentCache){this.remoteDocumentCache=remoteDocumentCache;this.changes=EMPTY_MAYBE_DOCUMENT_MAP}RemoteDocumentChangeBuffer.prototype.addEntry=function(maybeDocument){this.changes=this.assertChanges().insert(maybeDocument.key,maybeDocument)};RemoteDocumentChangeBuffer.prototype.getEntry=function(transaction,documentKey){var bufferedEntry=
this.assertChanges().get(documentKey);return bufferedEntry?PersistencePromise.resolve(bufferedEntry):this.remoteDocumentCache.getEntry(transaction,documentKey)};RemoteDocumentChangeBuffer.prototype.apply=function(transaction){var _this=this,promises=[];this.assertChanges().forEach(function(key,maybeDoc){promises.push(_this.remoteDocumentCache.addEntry(transaction,maybeDoc))});this.changes=null;return PersistencePromise.waitFor(promises)};RemoteDocumentChangeBuffer.prototype.assertChanges=function(){assert(null!==
this.changes,"Changes have already been applied.");return this.changes};return RemoteDocumentChangeBuffer}(),LocalStore=function(){function LocalStore(persistence,initialUser,garbageCollector){this.persistence=persistence;this.garbageCollector=garbageCollector;this.localViewReferences=new ReferenceSet;this.targetIds={};this.targetIdGenerator=TargetIdGenerator.forLocalStore();this.heldBatchResults=[];assert(persistence.started,"LocalStore was passed an unstarted persistence implementation");this.mutationQueue=
persistence.getMutationQueue(initialUser);this.remoteDocuments=persistence.getRemoteDocumentCache();this.queryCache=persistence.getQueryCache();this.localDocuments=new LocalDocumentsView(this.remoteDocuments,this.mutationQueue);this.garbageCollector.addGarbageSource(this.localViewReferences);this.garbageCollector.addGarbageSource(this.queryCache);this.garbageCollector.addGarbageSource(this.mutationQueue)}LocalStore.prototype.start=function(){var _this=this;return this.persistence.runTransaction("Start LocalStore",
function(txn){return _this.startMutationQueue(txn).next(function(){return _this.startQueryCache(txn)})})};LocalStore.prototype.handleUserChange=function(user){var _this=this;return this.persistence.runTransaction("Handle user change",function(txn){var oldBatches;return _this.mutationQueue.getAllMutationBatches(txn).next(function(promisedOldBatches){oldBatches=promisedOldBatches;_this.garbageCollector.removeGarbageSource(_this.mutationQueue);_this.mutationQueue=_this.persistence.getMutationQueue(user);
_this.garbageCollector.addGarbageSource(_this.mutationQueue);return _this.startMutationQueue(txn)}).next(function(){_this.localDocuments=new LocalDocumentsView(_this.remoteDocuments,_this.mutationQueue);return _this.mutationQueue.getAllMutationBatches(txn)}).next(function(newBatches){var changedKeys=EMPTY_DOCUMENT_KEY_SET,_i=0;for(newBatches=[oldBatches,newBatches];_i<newBatches.length;_i++)for(var _b=0,batches_1=newBatches[_i];_b<batches_1.length;_b++)for(var _c=0,_d=batches_1[_b].mutations;_c<_d.length;_c++)changedKeys=
changedKeys.add(_d[_c].key);return _this.localDocuments.getDocuments(txn,changedKeys)})})};LocalStore.prototype.startQueryCache=function(txn){var _this=this;return this.queryCache.start(txn).next(function(){var targetId=_this.queryCache.getHighestTargetId();_this.targetIdGenerator=TargetIdGenerator.forLocalStore(targetId)})};LocalStore.prototype.startMutationQueue=function(txn){var _this=this;return this.mutationQueue.start(txn).next(function(){_this.heldBatchResults=[];return _this.mutationQueue.getHighestAcknowledgedBatchId(txn)}).next(function(highestAck){return-1!==
highestAck?_this.mutationQueue.getAllMutationBatchesThroughBatchId(txn,highestAck):PersistencePromise.resolve([])}).next(function(ackedBatches){return 0<ackedBatches.length?_this.mutationQueue.removeMutationBatches(txn,ackedBatches):PersistencePromise.resolve()})};LocalStore.prototype.localWrite=function(mutations){var _this=this;return this.persistence.runTransaction("Locally write mutations",function(txn){var batch,localWriteTime=Timestamp.now();return _this.mutationQueue.addMutationBatch(txn,localWriteTime,
mutations).next(function(promisedBatch){batch=promisedBatch;promisedBatch=batch.keys();return _this.localDocuments.getDocuments(txn,promisedBatch)}).next(function(changedDocuments){return{batchId:batch.batchId,changes:changedDocuments}})})};LocalStore.prototype.acknowledgeBatch=function(batchResult){var _this=this;return this.persistence.runTransaction("Acknowledge batch",function(txn){var affected;return _this.mutationQueue.acknowledgeBatch(txn,batchResult.batch,batchResult.streamToken).next(function(){if(_this.shouldHoldBatchResult(batchResult.commitVersion))return _this.heldBatchResults.push(batchResult),
affected=EMPTY_DOCUMENT_KEY_SET,PersistencePromise.resolve();var documentBuffer_1=new RemoteDocumentChangeBuffer(_this.remoteDocuments);return _this.releaseBatchResults(txn,[batchResult],documentBuffer_1).next(function(promisedAffectedKeys){affected=promisedAffectedKeys;return documentBuffer_1.apply(txn)})}).next(function(){return _this.mutationQueue.performConsistencyCheck(txn)}).next(function(){return _this.localDocuments.getDocuments(txn,affected)})})};LocalStore.prototype.rejectBatch=function(batchId){var _this=
this;return this.persistence.runTransaction("Reject batch",function(txn){var toReject,affectedKeys;return _this.mutationQueue.lookupMutationBatch(txn,batchId).next(function(promisedToReject){assert(null!=promisedToReject,"Attempt to reject nonexistent batch!");toReject=promisedToReject;return _this.mutationQueue.getHighestAcknowledgedBatchId(txn).next(function(lastAcked){assert(batchId>lastAcked,"Acknowledged batches can't be rejected.");return toReject})}).next(function(){return _this.removeMutationBatch(txn,
toReject)}).next(function(promisedAffectedKeys){affectedKeys=promisedAffectedKeys;return _this.mutationQueue.performConsistencyCheck(txn)}).next(function(){return _this.localDocuments.getDocuments(txn,affectedKeys)})})};LocalStore.prototype.getLastStreamToken=function(){var _this=this;return this.persistence.runTransaction("Get last stream token",function(txn){return _this.mutationQueue.getLastStreamToken(txn)})};LocalStore.prototype.setLastStreamToken=function(streamToken){var _this=this;return this.persistence.runTransaction("Set last stream token",
function(txn){return _this.mutationQueue.setLastStreamToken(txn,streamToken)})};LocalStore.prototype.getLastRemoteSnapshotVersion=function(){return this.queryCache.getLastRemoteSnapshotVersion()};LocalStore.prototype.applyRemoteEvent=function(remoteEvent){var _this=this,documentBuffer=new RemoteDocumentChangeBuffer(this.remoteDocuments);return this.persistence.runTransaction("Apply remote event",function(txn){var promises=[],authoritativeUpdates=EMPTY_DOCUMENT_KEY_SET;forEachNumber(remoteEvent.targetChanges,
function(targetId,change){var queryData=_this.targetIds[targetId];if(queryData){change.addedDocuments.forEach(function(key){authoritativeUpdates=authoritativeUpdates.add(key)});change.modifiedDocuments.forEach(function(key){authoritativeUpdates=authoritativeUpdates.add(key)});promises.push(_this.queryCache.removeMatchingKeys(txn,change.removedDocuments,targetId).next(function(){return _this.queryCache.addMatchingKeys(txn,change.addedDocuments,targetId)}));var resumeToken=change.resumeToken;if(0<resumeToken.length){var oldQueryData=
queryData;queryData=queryData.copy({resumeToken:resumeToken,snapshotVersion:remoteEvent.snapshotVersion});_this.targetIds[targetId]=queryData;LocalStore.shouldPersistQueryData(oldQueryData,queryData,change)&&promises.push(_this.queryCache.updateQueryData(txn,queryData))}}});var changedDocKeys=EMPTY_DOCUMENT_KEY_SET;remoteEvent.documentUpdates.forEach(function(key,doc){changedDocKeys=changedDocKeys.add(key);promises.push(documentBuffer.getEntry(txn,key).next(function(existingDoc){null==existingDoc||
doc.version.isEqual(SnapshotVersion.MIN)||authoritativeUpdates.has(doc.key)||0<=doc.version.compareTo(existingDoc.version)?documentBuffer.addEntry(doc):debug("LocalStore","Ignoring outdated watch update for ",key,". Current version:",existingDoc.version," Watch version:",doc.version);_this.garbageCollector.addPotentialGarbageKey(key)}))});var lastRemoteVersion=_this.queryCache.getLastRemoteSnapshotVersion(),remoteVersion=remoteEvent.snapshotVersion;remoteVersion.isEqual(SnapshotVersion.MIN)||(assert(0<=
remoteVersion.compareTo(lastRemoteVersion),"Watch stream reverted to previous snapshot?? "+remoteVersion+" \x3c "+lastRemoteVersion),promises.push(_this.queryCache.setLastRemoteSnapshotVersion(txn,remoteVersion)));var releasedWriteKeys;return PersistencePromise.waitFor(promises).next(function(){return _this.releaseHeldBatchResults(txn,documentBuffer)}).next(function(promisedReleasedWriteKeys){releasedWriteKeys=promisedReleasedWriteKeys;return documentBuffer.apply(txn)}).next(function(){return _this.localDocuments.getDocuments(txn,
changedDocKeys.unionWith(releasedWriteKeys))})})};LocalStore.shouldPersistQueryData=function(oldQueryData,newQueryData,change){return 0===newQueryData.resumeToken.length?!1:0===oldQueryData.resumeToken.length||newQueryData.snapshotVersion.toMicroseconds()-oldQueryData.snapshotVersion.toMicroseconds()>=this.RESUME_TOKEN_MAX_AGE_MICROS?!0:0<change.addedDocuments.size+change.modifiedDocuments.size+change.removedDocuments.size};LocalStore.prototype.notifyLocalViewChanges=function(viewChanges){for(var _i=
0;_i<viewChanges.length;_i++){var viewChange=viewChanges[_i];this.localViewReferences.addReferences(viewChange.addedKeys,viewChange.targetId);this.localViewReferences.removeReferences(viewChange.removedKeys,viewChange.targetId)}};LocalStore.prototype.nextMutationBatch=function(afterBatchId){var _this=this;return this.persistence.runTransaction("Get next mutation batch",function(txn){void 0===afterBatchId&&(afterBatchId=-1);return _this.mutationQueue.getNextMutationBatchAfterBatchId(txn,afterBatchId)})};
LocalStore.prototype.readDocument=function(key){var _this=this;return this.persistence.runTransaction("read document",function(txn){return _this.localDocuments.getDocument(txn,key)})};LocalStore.prototype.allocateQuery=function(query){var _this=this;return this.persistence.runTransaction("Allocate query",function(txn){var queryData;return _this.queryCache.getQueryData(txn,query).next(function(cached){if(cached)return queryData=cached,PersistencePromise.resolve();cached=_this.targetIdGenerator.next();
queryData=new QueryData(query,cached,QueryPurpose.Listen);return _this.queryCache.addQueryData(txn,queryData)}).next(function(){assert(!_this.targetIds[queryData.targetId],"Tried to allocate an already allocated query: "+query);return _this.targetIds[queryData.targetId]=queryData})})};LocalStore.prototype.releaseQuery=function(query){var _this=this;return this.persistence.runTransaction("Release query",function(txn){return _this.queryCache.getQueryData(txn,query).next(function(queryData){assert(null!=
queryData,"Tried to release nonexistent query: "+query);var targetId=queryData.targetId,cachedQueryData=_this.targetIds[targetId];_this.localViewReferences.removeReferencesForId(targetId);delete _this.targetIds[targetId];return _this.garbageCollector.isEager?_this.queryCache.removeQueryData(txn,queryData):cachedQueryData.snapshotVersion>queryData.snapshotVersion?_this.queryCache.updateQueryData(txn,cachedQueryData):PersistencePromise.resolve()}).next(function(){if(isEmpty(_this.targetIds)){var documentBuffer_2=
new RemoteDocumentChangeBuffer(_this.remoteDocuments);return _this.releaseHeldBatchResults(txn,documentBuffer_2).next(function(){documentBuffer_2.apply(txn)})}return PersistencePromise.resolve()})})};LocalStore.prototype.executeQuery=function(query){var _this=this;return this.persistence.runTransaction("Execute query",function(txn){return _this.localDocuments.getDocumentsMatchingQuery(txn,query)})};LocalStore.prototype.remoteDocumentKeys=function(targetId){var _this=this;return this.persistence.runTransaction("Remote document keys",
function(txn){return _this.queryCache.getMatchingKeysForTargetId(txn,targetId)})};LocalStore.prototype.collectGarbage=function(){var _this=this;return this.persistence.runTransaction("Garbage collection",function(txn){return _this.garbageCollector.collectGarbage(txn).next(function(garbage){var promises=[];garbage.forEach(function(key){promises.push(_this.remoteDocuments.removeEntry(txn,key))});return PersistencePromise.waitFor(promises)})})};LocalStore.prototype.releaseHeldBatchResults=function(txn,
documentBuffer){for(var toRelease=[],_i=0,_a=this.heldBatchResults;_i<_a.length;_i++){var batchResult=_a[_i];if(!this.isRemoteUpToVersion(batchResult.commitVersion))break;toRelease.push(batchResult)}if(0===toRelease.length)return PersistencePromise.resolve(EMPTY_DOCUMENT_KEY_SET);this.heldBatchResults.splice(0,toRelease.length);return this.releaseBatchResults(txn,toRelease,documentBuffer)};LocalStore.prototype.isRemoteUpToVersion=function(version){var lastRemoteVersion=this.queryCache.getLastRemoteSnapshotVersion();
return 0>=version.compareTo(lastRemoteVersion)||isEmpty(this.targetIds)};LocalStore.prototype.shouldHoldBatchResult=function(version){return!this.isRemoteUpToVersion(version)||0<this.heldBatchResults.length};LocalStore.prototype.releaseBatchResults=function(txn,batchResults,documentBuffer){for(var _this=this,promiseChain=PersistencePromise.resolve(),_loop_1=function(batchResult){promiseChain=promiseChain.next(function(){return _this.applyWriteToRemoteDocuments(txn,batchResult,documentBuffer)})},_i=
0;_i<batchResults.length;_i++)_loop_1(batchResults[_i]);return promiseChain.next(function(){return _this.removeMutationBatches(txn,batchResults.map(function(result){return result.batch}))})};LocalStore.prototype.removeMutationBatch=function(txn,batch){return this.removeMutationBatches(txn,[batch])};LocalStore.prototype.removeMutationBatches=function(txn,batches){for(var affectedDocs=EMPTY_DOCUMENT_KEY_SET,_i=0;_i<batches.length;_i++)for(var _a=0,_b=batches[_i].mutations;_a<_b.length;_a++)affectedDocs=
affectedDocs.add(_b[_a].key);return this.mutationQueue.removeMutationBatches(txn,batches).next(function(){return affectedDocs})};LocalStore.prototype.applyWriteToRemoteDocuments=function(txn,batchResult,documentBuffer){var batch=batchResult.batch,docKeys=batch.keys(),promiseChain=PersistencePromise.resolve();docKeys.forEach(function(docKey){promiseChain=promiseChain.next(function(){return documentBuffer.getEntry(txn,docKey)}).next(function(remoteDoc){var doc=remoteDoc,ackVersion=batchResult.docVersions.get(docKey);
assert(null!==ackVersion,"ackVersions should contain every doc in the write.");if(!doc||0>doc.version.compareTo(ackVersion))(doc=batch.applyToRemoteDocument(docKey,doc,batchResult))?documentBuffer.addEntry(doc):assert(!remoteDoc,"Mutation batch "+batch+" applied to document "+remoteDoc+" resulted in null")})});return promiseChain};LocalStore.RESUME_TOKEN_MAX_AGE_MICROS=3E8;return LocalStore}(),MemoryMutationQueue=function(){function MemoryMutationQueue(){this.mutationQueue=[];this.nextBatchId=1;this.highestAcknowledgedBatchId=
-1;this.lastStreamToken=emptyByteString();this.garbageCollector=null;this.batchesByDocumentKey=new SortedSet(DocReference.compareByKey)}MemoryMutationQueue.prototype.start=function(transaction){0===this.mutationQueue.length&&(this.nextBatchId=1,this.highestAcknowledgedBatchId=-1);assert(this.highestAcknowledgedBatchId<this.nextBatchId,"highestAcknowledgedBatchId must be less than the nextBatchId");return PersistencePromise.resolve()};MemoryMutationQueue.prototype.checkEmpty=function(transaction){return PersistencePromise.resolve(0===
this.mutationQueue.length)};MemoryMutationQueue.prototype.getNextBatchId=function(transaction){return PersistencePromise.resolve(this.nextBatchId)};MemoryMutationQueue.prototype.getHighestAcknowledgedBatchId=function(transaction){return PersistencePromise.resolve(this.highestAcknowledgedBatchId)};MemoryMutationQueue.prototype.acknowledgeBatch=function(transaction,batch,streamToken){transaction=batch.batchId;assert(transaction>this.highestAcknowledgedBatchId,"Mutation batchIDs must be acknowledged in order");
batch=this.indexOfExistingBatchId(transaction,"acknowledged");batch=this.mutationQueue[batch];assert(transaction===batch.batchId,"Queue ordering failure: expected batch "+transaction+", got batch "+batch.batchId);assert(!batch.isTombstone(),"Can't acknowledge a previously removed batch");this.highestAcknowledgedBatchId=transaction;this.lastStreamToken=streamToken;return PersistencePromise.resolve()};MemoryMutationQueue.prototype.getLastStreamToken=function(transaction){return PersistencePromise.resolve(this.lastStreamToken)};
MemoryMutationQueue.prototype.setLastStreamToken=function(transaction,streamToken){this.lastStreamToken=streamToken;return PersistencePromise.resolve()};MemoryMutationQueue.prototype.addMutationBatch=function(transaction,localWriteTime,mutations){assert(0!==mutations.length,"Mutation batches should not be empty");transaction=this.nextBatchId;this.nextBatchId++;0<this.mutationQueue.length&&assert(this.mutationQueue[this.mutationQueue.length-1].batchId<transaction,"Mutation batchIDs must be monotonically increasing order");
localWriteTime=new MutationBatch(transaction,localWriteTime,mutations);this.mutationQueue.push(localWriteTime);for(var _i=0;_i<mutations.length;_i++)this.batchesByDocumentKey=this.batchesByDocumentKey.add(new DocReference(mutations[_i].key,transaction));return PersistencePromise.resolve(localWriteTime)};MemoryMutationQueue.prototype.lookupMutationBatch=function(transaction,batchId){return PersistencePromise.resolve(this.findMutationBatch(batchId))};MemoryMutationQueue.prototype.getNextMutationBatchAfterBatchId=
function(transaction,batchId){transaction=this.mutationQueue.length;batchId=this.indexOfBatchId(Math.max(batchId,this.highestAcknowledgedBatchId)+1);for(batchId=0>batchId?0:batchId;batchId<transaction;batchId++){var batch=this.mutationQueue[batchId];if(!batch.isTombstone())return PersistencePromise.resolve(batch)}return PersistencePromise.resolve(null)};MemoryMutationQueue.prototype.getAllMutationBatches=function(transaction){return PersistencePromise.resolve(this.getAllLiveMutationBatchesBeforeIndex(this.mutationQueue.length))};
MemoryMutationQueue.prototype.getAllMutationBatchesThroughBatchId=function(transaction,batchId){transaction=this.mutationQueue.length;batchId=this.indexOfBatchId(batchId);0>batchId?batchId=0:batchId>=transaction?batchId=transaction:batchId++;return PersistencePromise.resolve(this.getAllLiveMutationBatchesBeforeIndex(batchId))};MemoryMutationQueue.prototype.getAllMutationBatchesAffectingDocumentKey=function(transaction,documentKey){var _this=this;transaction=new DocReference(documentKey,0);var end=
new DocReference(documentKey,Number.POSITIVE_INFINITY),result=[];this.batchesByDocumentKey.forEachInRange([transaction,end],function(ref){assert(documentKey.isEqual(ref.key),"Should only iterate over a single key's batches");ref=_this.findMutationBatch(ref.targetOrBatchId);assert(null!==ref,"Batches in the index must exist in the main table");result.push(ref)});return PersistencePromise.resolve(result)};MemoryMutationQueue.prototype.getAllMutationBatchesAffectingDocumentKeys=function(transaction,
documentKeys){var _this=this,uniqueBatchIDs=new SortedSet(primitiveComparator);documentKeys.forEach(function(documentKey){var start=new DocReference(documentKey,0),end=new DocReference(documentKey,Number.POSITIVE_INFINITY);_this.batchesByDocumentKey.forEachInRange([start,end],function(ref){assert(documentKey.isEqual(ref.key),"For each key, should only iterate over a single key's batches");uniqueBatchIDs=uniqueBatchIDs.add(ref.targetOrBatchId)})});return PersistencePromise.resolve(this.findMutationBatches(uniqueBatchIDs))};
MemoryMutationQueue.prototype.getAllMutationBatchesAffectingQuery=function(transaction,query){var prefix=query.path,immediateChildrenPathLength=prefix.length+1;transaction=prefix;DocumentKey.isDocumentKey(transaction)||(transaction=transaction.child(""));transaction=new DocReference(new DocumentKey(transaction),0);var uniqueBatchIDs=new SortedSet(primitiveComparator);this.batchesByDocumentKey.forEachWhile(function(ref){var rowKeyPath=ref.key.path;return prefix.isPrefixOf(rowKeyPath)?(rowKeyPath.length===
immediateChildrenPathLength&&(uniqueBatchIDs=uniqueBatchIDs.add(ref.targetOrBatchId)),!0):!1},transaction);return PersistencePromise.resolve(this.findMutationBatches(uniqueBatchIDs))};MemoryMutationQueue.prototype.findMutationBatches=function(batchIDs){var _this=this,result=[];batchIDs.forEach(function(batchId){batchId=_this.findMutationBatch(batchId);null!==batchId&&result.push(batchId)});return result};MemoryMutationQueue.prototype.removeMutationBatches=function(transaction,batches){var batchCount=
batches.length;assert(0<batchCount,"Should not remove mutations when none exist.");transaction=batches[0].batchId;var queueCount=this.mutationQueue.length,startIndex=this.indexOfExistingBatchId(transaction,"removed");assert(this.mutationQueue[startIndex].batchId===transaction,"Removed batches must exist in the queue");for(var batchIndex=1,queueIndex=startIndex+1;batchIndex<batchCount&&queueIndex<queueCount;)transaction=this.mutationQueue[queueIndex],transaction.isTombstone()||(assert(transaction.batchId===
batches[batchIndex].batchId,"Removed batches must be contiguous in the queue"),batchIndex++),queueIndex++;if(0===startIndex){for(;queueIndex<queueCount&&(transaction=this.mutationQueue[queueIndex],transaction.isTombstone());queueIndex++);this.mutationQueue.splice(startIndex,queueIndex-startIndex)}else for(transaction=startIndex;transaction<queueIndex;transaction++)this.mutationQueue[transaction]=this.mutationQueue[transaction].toTombstone();batchCount=this.batchesByDocumentKey;for(queueCount=0;queueCount<
batches.length;queueCount++)for(transaction=batches[queueCount],startIndex=transaction.batchId,queueIndex=0,transaction=transaction.mutations;queueIndex<transaction.length;queueIndex++)batchIndex=transaction[queueIndex].key,null!==this.garbageCollector&&this.garbageCollector.addPotentialGarbageKey(batchIndex),batchIndex=new DocReference(batchIndex,startIndex),batchCount=batchCount.delete(batchIndex);this.batchesByDocumentKey=batchCount;return PersistencePromise.resolve()};MemoryMutationQueue.prototype.setGarbageCollector=
function(garbageCollector){this.garbageCollector=garbageCollector};MemoryMutationQueue.prototype.containsKey=function(txn,key){txn=new DocReference(key,0);txn=this.batchesByDocumentKey.firstAfterOrEqual(txn);return PersistencePromise.resolve(key.isEqual(txn&&txn.key))};MemoryMutationQueue.prototype.performConsistencyCheck=function(txn){0===this.mutationQueue.length&&assert(this.batchesByDocumentKey.isEmpty(),"Document leak -- detected dangling mutation references when queue is empty.");return PersistencePromise.resolve()};
MemoryMutationQueue.prototype.getAllLiveMutationBatchesBeforeIndex=function(endIndex){for(var result=[],i=0;i<endIndex;i++){var batch=this.mutationQueue[i];batch.isTombstone()||result.push(batch)}return result};MemoryMutationQueue.prototype.indexOfExistingBatchId=function(batchId,action){batchId=this.indexOfBatchId(batchId);assert(0<=batchId&&batchId<this.mutationQueue.length,"Batches must exist to be "+action);return batchId};MemoryMutationQueue.prototype.indexOfBatchId=function(batchId){return 0===
this.mutationQueue.length?0:batchId-this.mutationQueue[0].batchId};MemoryMutationQueue.prototype.findMutationBatch=function(batchId){var index=this.indexOfBatchId(batchId);if(0>index||index>=this.mutationQueue.length)return null;index=this.mutationQueue[index];assert(index.batchId===batchId,"If found batch must match");return index.isTombstone()?null:index};return MemoryMutationQueue}(),MemoryQueryCache=function(){function MemoryQueryCache(){this.queries=new ObjectMap(function(q){return q.canonicalId()});
this.lastRemoteSnapshotVersion=SnapshotVersion.MIN;this.highestTargetId=0;this.references=new ReferenceSet;this.targetCount=0}MemoryQueryCache.prototype.start=function(transaction){return PersistencePromise.resolve()};MemoryQueryCache.prototype.getLastRemoteSnapshotVersion=function(){return this.lastRemoteSnapshotVersion};MemoryQueryCache.prototype.getHighestTargetId=function(){return this.highestTargetId};MemoryQueryCache.prototype.setLastRemoteSnapshotVersion=function(transaction,snapshotVersion){this.lastRemoteSnapshotVersion=
snapshotVersion;return PersistencePromise.resolve()};MemoryQueryCache.prototype.saveQueryData=function(queryData){this.queries.set(queryData.query,queryData);queryData=queryData.targetId;queryData>this.highestTargetId&&(this.highestTargetId=queryData)};MemoryQueryCache.prototype.addQueryData=function(transaction,queryData){assert(!this.queries.has(queryData.query),"Adding a query that already exists");this.saveQueryData(queryData);this.targetCount+=1;return PersistencePromise.resolve()};MemoryQueryCache.prototype.updateQueryData=
function(transaction,queryData){assert(this.queries.has(queryData.query),"Updating a non-existent query");this.saveQueryData(queryData);return PersistencePromise.resolve()};MemoryQueryCache.prototype.removeQueryData=function(transaction,queryData){assert(0<this.targetCount,"Removing a target from an empty cache");assert(this.queries.has(queryData.query),"Removing a non-existent target from the cache");this.queries.delete(queryData.query);this.references.removeReferencesForId(queryData.targetId);--this.targetCount;
return PersistencePromise.resolve()};Object.defineProperty(MemoryQueryCache.prototype,"count",{get:function(){return this.targetCount},enumerable:!0,configurable:!0});MemoryQueryCache.prototype.getQueryData=function(transaction,query){transaction=this.queries.get(query)||null;return PersistencePromise.resolve(transaction)};MemoryQueryCache.prototype.addMatchingKeys=function(txn,keys,targetId){this.references.addReferences(keys,targetId);return PersistencePromise.resolve()};MemoryQueryCache.prototype.removeMatchingKeys=
function(txn,keys,targetId){this.references.removeReferences(keys,targetId);return PersistencePromise.resolve()};MemoryQueryCache.prototype.removeMatchingKeysForTargetId=function(txn,targetId){this.references.removeReferencesForId(targetId);return PersistencePromise.resolve()};MemoryQueryCache.prototype.getMatchingKeysForTargetId=function(txn,targetId){txn=this.references.referencesForId(targetId);return PersistencePromise.resolve(txn)};MemoryQueryCache.prototype.setGarbageCollector=function(gc){this.references.setGarbageCollector(gc)};
MemoryQueryCache.prototype.containsKey=function(txn,key){return this.references.containsKey(txn,key)};return MemoryQueryCache}(),MemoryRemoteDocumentCache=function(){function MemoryRemoteDocumentCache(){this.docs=EMPTY_MAYBE_DOCUMENT_MAP}MemoryRemoteDocumentCache.prototype.addEntry=function(transaction,maybeDocument){this.docs=this.docs.insert(maybeDocument.key,maybeDocument);return PersistencePromise.resolve()};MemoryRemoteDocumentCache.prototype.removeEntry=function(transaction,documentKey){this.docs=
this.docs.remove(documentKey);return PersistencePromise.resolve()};MemoryRemoteDocumentCache.prototype.getEntry=function(transaction,documentKey){return PersistencePromise.resolve(this.docs.get(documentKey))};MemoryRemoteDocumentCache.prototype.getDocumentsMatchingQuery=function(transaction,query){transaction=EMPTY_DOCUMENT_MAP;var prefix=new DocumentKey(query.path.child(""));for(prefix=this.docs.getIteratorFrom(prefix);prefix.hasNext();){var _a=prefix.getNext(),maybeDoc=_a.value;if(!query.path.isPrefixOf(_a.key.path))break;
maybeDoc instanceof Document$jscomp$0&&query.matches(maybeDoc)&&(transaction=transaction.insert(maybeDoc.key,maybeDoc))}return PersistencePromise.resolve(transaction)};return MemoryRemoteDocumentCache}(),MemoryPersistence=function(){function MemoryPersistence(){this.mutationQueues={};this.remoteDocumentCache=new MemoryRemoteDocumentCache;this.queryCache=new MemoryQueryCache;this._started=!1}MemoryPersistence.prototype.start=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,
function(_a){assert(!this._started,"MemoryPersistence double-started!");this._started=!0;return[2]})})};MemoryPersistence.prototype.shutdown=function(deleteData){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){assert(this._started,"MemoryPersistence shutdown without start!");this._started=!1;return[2]})})};Object.defineProperty(MemoryPersistence.prototype,"started",{get:function(){return this._started},enumerable:!0,configurable:!0});MemoryPersistence.prototype.getMutationQueue=
function(user){var queue=this.mutationQueues[user.toKey()];queue||(queue=new MemoryMutationQueue,this.mutationQueues[user.toKey()]=queue);return queue};MemoryPersistence.prototype.getQueryCache=function(){return this.queryCache};MemoryPersistence.prototype.getRemoteDocumentCache=function(){return this.remoteDocumentCache};MemoryPersistence.prototype.runTransaction=function(action,operation){debug("MemoryPersistence","Starting transaction:",action);return operation(new MemoryTransaction).toPromise()};
return MemoryPersistence}(),MemoryTransaction=function(){return function(){}}(),NoOpGarbageCollector=function(){function NoOpGarbageCollector(){this.isEager=!1}NoOpGarbageCollector.prototype.addGarbageSource=function(garbageSource){};NoOpGarbageCollector.prototype.removeGarbageSource=function(garbageSource){};NoOpGarbageCollector.prototype.addPotentialGarbageKey=function(key){};NoOpGarbageCollector.prototype.collectGarbage=function(txn){return PersistencePromise.resolve(EMPTY_DOCUMENT_KEY_SET)};return NoOpGarbageCollector}(),
TimerId;(function(TimerId){TimerId.All="all";TimerId.ListenStreamIdle="listen_stream_idle";TimerId.ListenStreamConnectionBackoff="listen_stream_connection_backoff";TimerId.WriteStreamIdle="write_stream_idle";TimerId.WriteStreamConnectionBackoff="write_stream_connection_backoff";TimerId.OnlineStateTimeout="online_state_timeout"})(TimerId||(TimerId={}));var DelayedOperation=function(){function DelayedOperation(asyncQueue,timerId,targetTimeMs,op,removalCallback){this.asyncQueue=asyncQueue;this.timerId=
timerId;this.targetTimeMs=targetTimeMs;this.op=op;this.removalCallback=removalCallback;this.deferred=new Deferred$1;this.then=this.deferred.promise.then.bind(this.deferred.promise);this.catch=this.deferred.promise.catch.bind(this.deferred.promise);this.deferred.promise.catch(function(err){})}DelayedOperation.createAndSchedule=function(asyncQueue,timerId,delayMs,op,removalCallback){var targetTime=Date.now()+delayMs;asyncQueue=new DelayedOperation(asyncQueue,timerId,targetTime,op,removalCallback);asyncQueue.start(delayMs);
return asyncQueue};DelayedOperation.prototype.start=function(delayMs){var _this=this;this.timerHandle=setTimeout(function(){return _this.handleDelayElapsed()},delayMs)};DelayedOperation.prototype.skipDelay=function(){return this.handleDelayElapsed()};DelayedOperation.prototype.cancel=function(reason){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new FirestoreError(Code.CANCELLED,"Operation cancelled"+(reason?": "+reason:""))))};DelayedOperation.prototype.handleDelayElapsed=function(){var _this=
this;this.asyncQueue.enqueue(function(){return null!==_this.timerHandle?(_this.clearTimeout(),_this.op().then(function(result){return _this.deferred.resolve(result)})):Promise.resolve()})};DelayedOperation.prototype.clearTimeout=function(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)};return DelayedOperation}(),AsyncQueue=function(){function AsyncQueue(){this.tail=Promise.resolve();this.delayedOperations=[];this.operationInProgress=!1}
AsyncQueue.prototype.enqueue=function(op){var _this=this;this.verifyNotFailed();var newTail=this.tail.then(function(){_this.operationInProgress=!0;return op().catch(function(error$$1){_this.failure=error$$1;_this.operationInProgress=!1;var message=error$$1.stack||error$$1.message||"";error$jscomp$0("INTERNAL UNHANDLED ERROR: ",message);0>message.indexOf("Firestore Test Simulated Error")&&setTimeout(function(){throw error$$1;},0);throw error$$1;}).then(function(result){_this.operationInProgress=!1;
return result})});return this.tail=newTail};AsyncQueue.prototype.enqueueAfterDelay=function(timerId,delayMs,op$jscomp$0){var _this=this;this.verifyNotFailed();assert(!this.containsDelayedOperation(timerId),"Attempted to schedule multiple operations with timer id "+timerId+".");timerId=DelayedOperation.createAndSchedule(this,timerId,delayMs,op$jscomp$0,function(op){return _this.removeDelayedOperation(op)});this.delayedOperations.push(timerId);return timerId};AsyncQueue.prototype.verifyNotFailed=function(){this.failure&&
fail("AsyncQueue is already failed: "+(this.failure.stack||this.failure.message))};AsyncQueue.prototype.verifyOperationInProgress=function(){assert(this.operationInProgress,"verifyOpInProgress() called when no op in progress on this queue.")};AsyncQueue.prototype.drain=function(){return this.enqueue(function(){return Promise.resolve()})};AsyncQueue.prototype.containsDelayedOperation=function(timerId){return 0<=this.delayedOperations.findIndex(function(op){return op.timerId===timerId})};AsyncQueue.prototype.runDelayedOperationsEarly=
function(lastTimerId){var _this=this;return this.drain().then(function(){assert(lastTimerId===TimerId.All||_this.containsDelayedOperation(lastTimerId),"Attempted to drain to missing operation "+lastTimerId);_this.delayedOperations.sort(function(a,b){return a.targetTimeMs-b.targetTimeMs});for(var _i=0,_a=_this.delayedOperations;_i<_a.length;_i++){var op=_a[_i];op.skipDelay();if(lastTimerId!==TimerId.All&&op.timerId===lastTimerId)break}return _this.drain()})};AsyncQueue.prototype.removeDelayedOperation=
function(op){op=this.delayedOperations.indexOf(op);assert(0<=op,"Delayed operation not found.");this.delayedOperations.splice(op,1)};return AsyncQueue}(),ExponentialBackoff=function(){function ExponentialBackoff(queue,timerId,initialDelayMs,backoffFactor,maxDelayMs){this.queue=queue;this.timerId=timerId;this.initialDelayMs=initialDelayMs;this.backoffFactor=backoffFactor;this.maxDelayMs=maxDelayMs;this.timerPromise=null;this.reset()}ExponentialBackoff.prototype.reset=function(){this.currentBaseMs=
0};ExponentialBackoff.prototype.resetToMax=function(){this.currentBaseMs=this.maxDelayMs};ExponentialBackoff.prototype.backoffAndRun=function(op){this.cancel();var delayWithJitterMs=this.currentBaseMs+this.jitterDelayMs();0<this.currentBaseMs&&debug("ExponentialBackoff","Backing off for "+delayWithJitterMs+" ms "+("(base delay: "+this.currentBaseMs+" ms)"));this.timerPromise=this.queue.enqueueAfterDelay(this.timerId,delayWithJitterMs,op);this.currentBaseMs*=this.backoffFactor;this.currentBaseMs<this.initialDelayMs&&
(this.currentBaseMs=this.initialDelayMs);this.currentBaseMs>this.maxDelayMs&&(this.currentBaseMs=this.maxDelayMs)};ExponentialBackoff.prototype.cancel=function(){null!==this.timerPromise&&(this.timerPromise.cancel(),this.timerPromise=null)};ExponentialBackoff.prototype.jitterDelayMs=function(){return(Math.random()-.5)*this.currentBaseMs};return ExponentialBackoff}(),PersistentStreamState;(function(PersistentStreamState){PersistentStreamState[PersistentStreamState.Initial=0]="Initial";PersistentStreamState[PersistentStreamState.Starting=
1]="Starting";PersistentStreamState[PersistentStreamState.Open=2]="Open";PersistentStreamState[PersistentStreamState.Error=3]="Error";PersistentStreamState[PersistentStreamState.Backoff=4]="Backoff"})(PersistentStreamState||(PersistentStreamState={}));var PersistentStream=function(){function PersistentStream(queue,connectionTimerId,idleTimerId,connection,credentialsProvider,listener){this.queue=queue;this.idleTimerId=idleTimerId;this.connection=connection;this.credentialsProvider=credentialsProvider;
this.listener=listener;this.state=PersistentStreamState.Initial;this.closeCount=0;this.stream=this.idleTimer=null;this.backoff=new ExponentialBackoff(queue,connectionTimerId,1E3,1.5,6E4)}PersistentStream.prototype.isStarted=function(){return this.state===PersistentStreamState.Starting||this.state===PersistentStreamState.Open||this.state===PersistentStreamState.Backoff};PersistentStream.prototype.isOpen=function(){return this.state===PersistentStreamState.Open};PersistentStream.prototype.start=function(){this.state===
PersistentStreamState.Error?this.performBackoff():(assert(this.state===PersistentStreamState.Initial,"Already started"),this.auth())};PersistentStream.prototype.stop=function(){this.isStarted()&&this.close(PersistentStreamState.Initial)};PersistentStream.prototype.inhibitBackoff=function(){assert(!this.isStarted(),"Can only inhibit backoff in a stopped state");this.state=PersistentStreamState.Initial;this.backoff.reset()};PersistentStream.prototype.markIdle=function(){var _this=this;this.isOpen()&&
null===this.idleTimer&&(this.idleTimer=this.queue.enqueueAfterDelay(this.idleTimerId,6E4,function(){return _this.handleIdleCloseTimer()}))};PersistentStream.prototype.sendRequest=function(msg){this.cancelIdleCheck();this.stream.send(msg)};PersistentStream.prototype.handleIdleCloseTimer=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){return this.isOpen()?[2,this.close(PersistentStreamState.Initial)]:[2]})})};PersistentStream.prototype.cancelIdleCheck=
function(){this.idleTimer&&(this.idleTimer.cancel(),this.idleTimer=null)};PersistentStream.prototype.close=function(finalState,error$$1){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:return assert(this.isStarted(),"Only started streams should be closed."),assert(finalState===PersistentStreamState.Error||isNullOrUndefined(error$$1),"Can't provide an error when not in an error state."),this.cancelIdleCheck(),this.backoff.cancel(),
this.closeCount++,finalState!==PersistentStreamState.Error?this.backoff.reset():error$$1&&error$$1.code===Code.RESOURCE_EXHAUSTED?(error$jscomp$0(error$$1.toString()),error$jscomp$0("Using maximum backoff delay to prevent overloading the backend."),this.backoff.resetToMax()):error$$1&&error$$1.code===Code.UNAUTHENTICATED&&this.credentialsProvider.invalidateToken(),null!==this.stream&&(this.tearDown(),this.stream.close(),this.stream=null),this.state=finalState,[4,this.listener.onClose(error$$1)];case 1:return _a.sent(),
[2]}})})};PersistentStream.prototype.tearDown=function(){};PersistentStream.prototype.auth=function(){var _this=this;assert(this.state===PersistentStreamState.Initial,"Must be in initial state to auth");this.state=PersistentStreamState.Starting;var dispatchIfNotClosed=this.getCloseGuardedDispatcher(this.closeCount),closeCount=this.closeCount;this.credentialsProvider.getToken().then(function(token){_this.closeCount===closeCount&&_this.startStream(token)},function(error$$1){dispatchIfNotClosed(function(){var rpcError=
new FirestoreError(Code.UNKNOWN,"Fetching auth token failed: "+error$$1.message);return _this.handleStreamClose(rpcError)})})};PersistentStream.prototype.startStream=function(token){var _this=this;assert(this.state===PersistentStreamState.Starting,"Trying to start stream in a non-starting state");var dispatchIfNotClosed=this.getCloseGuardedDispatcher(this.closeCount);this.stream=this.startRpc(token);this.stream.onOpen(function(){dispatchIfNotClosed(function(){assert(_this.state===PersistentStreamState.Starting,
"Expected stream to be in state Starting, but was "+_this.state);_this.state=PersistentStreamState.Open;return _this.listener.onOpen()})});this.stream.onClose(function(error$$1){dispatchIfNotClosed(function(){return _this.handleStreamClose(error$$1)})});this.stream.onMessage(function(msg){dispatchIfNotClosed(function(){return _this.onMessage(msg)})})};PersistentStream.prototype.performBackoff=function(){var _this=this;assert(this.state===PersistentStreamState.Error,"Should only perform backoff when in Error state");
this.state=PersistentStreamState.Backoff;this.backoff.backoffAndRun(function(){return tslib_1.__awaiter(_this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){assert(this.state===PersistentStreamState.Backoff,"Backoff elapsed but state is now: "+this.state);this.state=PersistentStreamState.Initial;this.start();assert(this.isStarted(),"PersistentStream should have started");return[2]})})})};PersistentStream.prototype.handleStreamClose=function(error$$1){assert(this.isStarted(),
"Can't handle server close on non-started stream");debug("PersistentStream","close with error: "+error$$1);this.stream=null;return this.close(PersistentStreamState.Error,error$$1)};PersistentStream.prototype.getCloseGuardedDispatcher=function(startCloseCount){var _this=this;return function(fn){_this.queue.enqueue(function(){if(_this.closeCount===startCloseCount)return fn();debug("PersistentStream","stream callback skipped by getCloseGuardedDispatcher.");return Promise.resolve()})}};return PersistentStream}(),
PersistentListenStream=function(_super){function PersistentListenStream(queue,connection,credentials,serializer,listener){queue=_super.call(this,queue,TimerId.ListenStreamConnectionBackoff,TimerId.ListenStreamIdle,connection,credentials,listener)||this;queue.serializer=serializer;return queue}tslib_1.__extends(PersistentListenStream,_super);PersistentListenStream.prototype.startRpc=function(token){return this.connection.openStream("Listen",token)};PersistentListenStream.prototype.onMessage=function(watchChangeProto){this.backoff.reset();
var watchChange=this.serializer.fromWatchChange(watchChangeProto);watchChangeProto=this.serializer.versionFromListenResponse(watchChangeProto);return this.listener.onWatchChange(watchChange,watchChangeProto)};PersistentListenStream.prototype.watch=function(queryData){var request={};request.database=this.serializer.encodedDatabaseId;request.addTarget=this.serializer.toTarget(queryData);if(queryData=this.serializer.toListenRequestLabels(queryData))request.labels=queryData;this.sendRequest(request)};
PersistentListenStream.prototype.unwatch=function(targetId){var request={};request.database=this.serializer.encodedDatabaseId;request.removeTarget=targetId;this.sendRequest(request)};return PersistentListenStream}(PersistentStream),PersistentWriteStream=function(_super){function PersistentWriteStream(queue,connection,credentials,serializer,listener){queue=_super.call(this,queue,TimerId.WriteStreamConnectionBackoff,TimerId.WriteStreamIdle,connection,credentials,listener)||this;queue.serializer=serializer;
queue.handshakeComplete_=!1;return queue}tslib_1.__extends(PersistentWriteStream,_super);Object.defineProperty(PersistentWriteStream.prototype,"handshakeComplete",{get:function(){return this.handshakeComplete_},enumerable:!0,configurable:!0});PersistentWriteStream.prototype.start=function(){this.handshakeComplete_=!1;_super.prototype.start.call(this)};PersistentWriteStream.prototype.tearDown=function(){this.handshakeComplete_&&this.writeMutations([])};PersistentWriteStream.prototype.startRpc=function(token){return this.connection.openStream("Write",
token)};PersistentWriteStream.prototype.onMessage=function(responseProto){assert(!!responseProto.streamToken,"Got a write response without a stream token");this.lastStreamToken=responseProto.streamToken;if(this.handshakeComplete_){this.backoff.reset();var results=this.serializer.fromWriteResults(responseProto.writeResults);responseProto=this.serializer.fromVersion(responseProto.commitTime);return this.listener.onMutationResult(responseProto,results)}assert(!responseProto.writeResults||0===responseProto.writeResults.length,
"Got mutation results for handshake");this.handshakeComplete_=!0;return this.listener.onHandshakeComplete()};PersistentWriteStream.prototype.writeHandshake=function(){assert(this.isOpen(),"Writing handshake requires an opened stream");assert(!this.handshakeComplete_,"Handshake already completed");var request={};request.database=this.serializer.encodedDatabaseId;this.sendRequest(request)};PersistentWriteStream.prototype.writeMutations=function(mutations){var _this=this;assert(this.isOpen(),"Writing mutations requires an opened stream");
assert(this.handshakeComplete_,"Handshake must be complete before writing mutations");assert(0<this.lastStreamToken.length,"Trying to write mutation without a token");mutations={streamToken:this.lastStreamToken,writes:mutations.map(function(mutation){return _this.serializer.toMutation(mutation)})};this.sendRequest(mutations)};return PersistentWriteStream}(PersistentStream),Datastore=function(){function Datastore(queue,connection,credentials,serializer){this.queue=queue;this.connection=connection;
this.credentials=credentials;this.serializer=serializer}Datastore.prototype.newPersistentWriteStream=function(listener){return new PersistentWriteStream(this.queue,this.connection,this.credentials,this.serializer,listener)};Datastore.prototype.newPersistentWatchStream=function(listener){return new PersistentListenStream(this.queue,this.connection,this.credentials,this.serializer,listener)};Datastore.prototype.commit=function(mutations){var _this=this;mutations={database:this.serializer.encodedDatabaseId,
writes:mutations.map(function(m){return _this.serializer.toMutation(m)})};return this.invokeRPC("Commit",mutations).then(function(response){return _this.serializer.fromWriteResults(response.writeResults)})};Datastore.prototype.lookup=function(keys){var _this=this,params={database:this.serializer.encodedDatabaseId,documents:keys.map(function(k){return _this.serializer.toName(k)})};return this.invokeStreamingRPC("BatchGetDocuments",params).then(function(response){var docs=EMPTY_MAYBE_DOCUMENT_MAP;response.forEach(function(proto){proto=
_this.serializer.fromMaybeDocument(proto);docs=docs.insert(proto.key,proto)});var result=[];keys.forEach(function(key){var doc=docs.get(key);assert(!!doc,"Missing entity in write response for "+key);result.push(doc)});return result})};Datastore.prototype.invokeRPC=function(rpcName,request){var _this=this;return this.credentials.getToken().then(function(token){return _this.connection.invokeRPC(rpcName,request,token)}).catch(function(error){error.code===Code.UNAUTHENTICATED&&_this.credentials.invalidateToken();
throw error;})};Datastore.prototype.invokeStreamingRPC=function(rpcName,request){var _this=this;return this.credentials.getToken().then(function(token){return _this.connection.invokeStreamingRPC(rpcName,request,token)}).catch(function(error){error.code===Code.UNAUTHENTICATED&&_this.credentials.invalidateToken();throw error;})};return Datastore}(),Transaction=function(){function Transaction(datastore){this.datastore=datastore;this.readVersions=EMPTY_DOCUMENT_VERSION_MAP;this.mutations=[];this.committed=
!1}Transaction.prototype.recordVersion=function(doc){var docVersion=doc.version;doc instanceof NoDocument&&(docVersion=SnapshotVersion.forDeletedDoc());var existingVersion=this.readVersions.get(doc.key);if(null!==existingVersion){if(!docVersion.isEqual(existingVersion))throw new FirestoreError(Code.ABORTED,"Document version changed between two reads.");}else this.readVersions=this.readVersions.insert(doc.key,docVersion)};Transaction.prototype.lookup=function(keys){var _this=this;return this.committed?
Promise.reject("Transaction has already completed."):0<this.mutations.length?Promise.reject("Transactions lookups are invalid after writes."):this.datastore.lookup(keys).then(function(docs){docs.forEach(function(doc){return _this.recordVersion(doc)});return docs})};Transaction.prototype.write=function(mutations){if(this.committed)throw new FirestoreError(Code.FAILED_PRECONDITION,"Transaction has already completed.");this.mutations=this.mutations.concat(mutations)};Transaction.prototype.precondition=
function(key){return(key=this.readVersions.get(key))?Precondition.updateTime(key):Precondition.NONE};Transaction.prototype.preconditionForUpdate=function(key){if((key=this.readVersions.get(key))&&key.isEqual(SnapshotVersion.forDeletedDoc()))throw new FirestoreError(Code.FAILED_PRECONDITION,"Can't update a document that doesn't exist.");return key?Precondition.updateTime(key):Precondition.exists(!0)};Transaction.prototype.set=function(key,data){this.write(data.toMutations(key,this.precondition(key)))};
Transaction.prototype.update=function(key,data){this.write(data.toMutations(key,this.preconditionForUpdate(key)))};Transaction.prototype.delete=function(key){this.write([new DeleteMutation(key,this.precondition(key))]);this.readVersions=this.readVersions.insert(key,SnapshotVersion.forDeletedDoc())};Transaction.prototype.commit=function(){var _this=this,unwritten=this.readVersions;this.mutations.forEach(function(mutation){unwritten=unwritten.remove(mutation.key)});return unwritten.isEmpty()?this.datastore.commit(this.mutations).then(function(){_this.committed=
!0}):Promise.reject(Error("Every document read in a transaction must also be written."))};return Transaction}(),OnlineStateTracker=function(){function OnlineStateTracker(asyncQueue,onlineStateHandler){this.asyncQueue=asyncQueue;this.onlineStateHandler=onlineStateHandler;this.state=OnlineState.Unknown;this.watchStreamFailures=0;this.onlineStateTimer=null;this.shouldWarnClientIsOffline=!0}OnlineStateTracker.prototype.handleWatchStreamStart=function(){var _this=this;0===this.watchStreamFailures&&(this.setAndBroadcast(OnlineState.Unknown),
assert(null===this.onlineStateTimer,"onlineStateTimer shouldn't be started yet"),this.onlineStateTimer=this.asyncQueue.enqueueAfterDelay(TimerId.OnlineStateTimeout,1E4,function(){_this.onlineStateTimer=null;assert(_this.state===OnlineState.Unknown,"Timer should be canceled if we transitioned to a different state.");_this.logClientOfflineWarningIfNecessary("Backend didn't respond within 10 seconds.");_this.setAndBroadcast(OnlineState.Offline);return Promise.resolve()}))};OnlineStateTracker.prototype.handleWatchStreamFailure=
function(error$$1){this.state===OnlineState.Online?(this.setAndBroadcast(OnlineState.Unknown),assert(0===this.watchStreamFailures,"watchStreamFailures must be 0"),assert(null===this.onlineStateTimer,"onlineStateTimer must be null")):(this.watchStreamFailures++,2<=this.watchStreamFailures&&(this.clearOnlineStateTimer(),this.logClientOfflineWarningIfNecessary("Connection failed 2 times. Most recent error: "+error$$1.toString()),this.setAndBroadcast(OnlineState.Offline)))};OnlineStateTracker.prototype.set=
function(newState){this.clearOnlineStateTimer();this.watchStreamFailures=0;newState===OnlineState.Online&&(this.shouldWarnClientIsOffline=!1);this.setAndBroadcast(newState)};OnlineStateTracker.prototype.setAndBroadcast=function(newState){newState!==this.state&&(this.state=newState,this.onlineStateHandler(newState))};OnlineStateTracker.prototype.logClientOfflineWarningIfNecessary=function(details){details="Could not reach Cloud Firestore backend. "+details+"\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.";
this.shouldWarnClientIsOffline?(error$jscomp$0(details),this.shouldWarnClientIsOffline=!1):debug("OnlineStateTracker",details)};OnlineStateTracker.prototype.clearOnlineStateTimer=function(){null!==this.onlineStateTimer&&(this.onlineStateTimer.cancel(),this.onlineStateTimer=null)};return OnlineStateTracker}(),RemoteStore=function(){function RemoteStore(localStore,datastore,asyncQueue,onlineStateHandler){this.localStore=localStore;this.datastore=datastore;this.writePipeline=[];this.listenTargets={};
this.networkEnabled=!1;this.watchChangeAggregator=null;this.onlineStateTracker=new OnlineStateTracker(asyncQueue,onlineStateHandler);this.watchStream=this.datastore.newPersistentWatchStream({onOpen:this.onWatchStreamOpen.bind(this),onClose:this.onWatchStreamClose.bind(this),onWatchChange:this.onWatchStreamChange.bind(this)});this.writeStream=this.datastore.newPersistentWriteStream({onOpen:this.onWriteStreamOpen.bind(this),onClose:this.onWriteStreamClose.bind(this),onHandshakeComplete:this.onWriteHandshakeComplete.bind(this),
onMutationResult:this.onMutationResult.bind(this)})}RemoteStore.prototype.start=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:return[4,this.enableNetwork()];case 1:return _a.sent(),[2]}})})};RemoteStore.prototype.enableNetwork=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){var _a;return tslib_1.__generator(this,function(_b){switch(_b.label){case 0:if(this.networkEnabled)return[3,3];this.networkEnabled=
!0;_a=this.writeStream;return[4,this.localStore.getLastStreamToken()];case 1:return _a.lastStreamToken=_b.sent(),this.shouldStartWatchStream()?this.startWatchStream():this.onlineStateTracker.set(OnlineState.Unknown),[4,this.fillWritePipeline()];case 2:_b.sent(),_b.label=3;case 3:return[2]}})})};RemoteStore.prototype.disableNetwork=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:return[4,this.disableNetworkInternal()];
case 1:return _a.sent(),this.onlineStateTracker.set(OnlineState.Offline),[2]}})})};RemoteStore.prototype.disableNetworkInternal=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){this.networkEnabled&&(this.networkEnabled=!1,this.writeStream.stop(),this.watchStream.stop(),0<this.writePipeline.length&&(debug("RemoteStore","Stopping write stream with "+this.writePipeline.length+" pending writes"),this.writePipeline=[]),this.cleanUpWatchStreamState());
return[2]})})};RemoteStore.prototype.shutdown=function(){debug("RemoteStore","RemoteStore shutting down.");this.disableNetworkInternal();this.onlineStateTracker.set(OnlineState.Unknown);return Promise.resolve()};RemoteStore.prototype.listen=function(queryData){assert(!contains(this.listenTargets,queryData.targetId),"listen called with duplicate targetId!");this.listenTargets[queryData.targetId]=queryData;this.shouldStartWatchStream()?this.startWatchStream():this.watchStream.isOpen()&&this.sendWatchRequest(queryData)};
RemoteStore.prototype.unlisten=function(targetId){assert(contains(this.listenTargets,targetId),"unlisten called without assigned target ID!");delete this.listenTargets[targetId];this.watchStream.isOpen()&&(this.sendUnwatchRequest(targetId),isEmpty(this.listenTargets)&&this.watchStream.markIdle())};RemoteStore.prototype.getQueryDataForTarget=function(targetId){return this.listenTargets[targetId]||null};RemoteStore.prototype.getRemoteKeysForTarget=function(targetId){return this.syncEngine.getRemoteKeysForTarget(targetId)};
RemoteStore.prototype.sendWatchRequest=function(queryData){this.watchChangeAggregator.recordPendingTargetRequest(queryData.targetId);this.watchStream.watch(queryData)};RemoteStore.prototype.sendUnwatchRequest=function(targetId){this.watchChangeAggregator.recordPendingTargetRequest(targetId);this.watchStream.unwatch(targetId)};RemoteStore.prototype.startWatchStream=function(){assert(this.shouldStartWatchStream(),"startWatchStream() called when shouldStartWatchStream() is false.");this.watchChangeAggregator=
new WatchChangeAggregator(this);this.watchStream.start();this.onlineStateTracker.handleWatchStreamStart()};RemoteStore.prototype.shouldStartWatchStream=function(){return this.canUseNetwork()&&!this.watchStream.isStarted()&&!isEmpty(this.listenTargets)};RemoteStore.prototype.canUseNetwork=function(){return this.networkEnabled};RemoteStore.prototype.cleanUpWatchStreamState=function(){this.watchChangeAggregator=null};RemoteStore.prototype.onWatchStreamOpen=function(){return tslib_1.__awaiter(this,void 0,
void 0,function(){var _this=this;return tslib_1.__generator(this,function(_a){forEachNumber(this.listenTargets,function(targetId,queryData){_this.sendWatchRequest(queryData)});return[2]})})};RemoteStore.prototype.onWatchStreamClose=function(error$$1){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){void 0===error$$1&&assert(!this.shouldStartWatchStream(),"Watch stream was stopped gracefully while still needed.");this.cleanUpWatchStreamState();this.shouldStartWatchStream()?
(this.onlineStateTracker.handleWatchStreamFailure(error$$1),this.startWatchStream()):this.onlineStateTracker.set(OnlineState.Unknown);return[2]})})};RemoteStore.prototype.onWatchStreamChange=function(watchChange,snapshotVersion){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:this.onlineStateTracker.set(OnlineState.Online);if(watchChange instanceof WatchTargetChange&&watchChange.state===WatchTargetChangeState.Removed&&watchChange.cause)return[2,
this.handleTargetError(watchChange)];watchChange instanceof DocumentWatchChange?this.watchChangeAggregator.handleDocumentChange(watchChange):watchChange instanceof ExistenceFilterChange?this.watchChangeAggregator.handleExistenceFilter(watchChange):(assert(watchChange instanceof WatchTargetChange,"Expected watchChange to be an instance of WatchTargetChange"),this.watchChangeAggregator.handleTargetChange(watchChange));return!snapshotVersion.isEqual(SnapshotVersion.MIN)&&0<=snapshotVersion.compareTo(this.localStore.getLastRemoteSnapshotVersion())?
[4,this.raiseWatchSnapshot(snapshotVersion)]:[3,2];case 1:_a.sent(),_a.label=2;case 2:return[2]}})})};RemoteStore.prototype.raiseWatchSnapshot=function(snapshotVersion){var _this=this;assert(!snapshotVersion.isEqual(SnapshotVersion.MIN),"Can't raise event for unknown SnapshotVersion");var remoteEvent=this.watchChangeAggregator.createRemoteEvent(snapshotVersion);forEachNumber(remoteEvent.targetChanges,function(targetId,change){if(0<change.resumeToken.length){var queryData=_this.listenTargets[targetId];
queryData&&(_this.listenTargets[targetId]=queryData.copy({resumeToken:change.resumeToken,snapshotVersion:snapshotVersion}))}});remoteEvent.targetMismatches.forEach(function(targetId){var queryData=_this.listenTargets[targetId];queryData&&(_this.listenTargets[targetId]=queryData.copy({resumeToken:emptyByteString()}),_this.sendUnwatchRequest(targetId),targetId=new QueryData(queryData.query,targetId,QueryPurpose.ExistenceFilterMismatch),_this.sendWatchRequest(targetId))});return this.syncEngine.applyRemoteEvent(remoteEvent)};
RemoteStore.prototype.handleTargetError=function(watchChange){var _this=this;assert(!!watchChange.cause,"Handling target error without a cause");var error$$1=watchChange.cause,promiseChain=Promise.resolve();watchChange.targetIds.forEach(function(targetId){promiseChain=promiseChain.then(function(){return tslib_1.__awaiter(_this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){return contains(this.listenTargets,targetId)?(delete this.listenTargets[targetId],this.watchChangeAggregator.removeTarget(targetId),
[2,this.syncEngine.rejectListen(targetId,error$$1)]):[2]})})})});return promiseChain};RemoteStore.prototype.fillWritePipeline=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){var lastBatchIdRetrieved,batch;return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:if(!this.canAddToWritePipeline())return[3,4];lastBatchIdRetrieved=0<this.writePipeline.length?this.writePipeline[this.writePipeline.length-1].batchId:-1;return[4,this.localStore.nextMutationBatch(lastBatchIdRetrieved)];
case 1:batch=_a.sent();if(null!==batch)return[3,2];0===this.writePipeline.length&&this.writeStream.markIdle();return[3,4];case 2:return this.addToWritePipeline(batch),[4,this.fillWritePipeline()];case 3:_a.sent(),_a.label=4;case 4:return this.shouldStartWriteStream()&&this.startWriteStream(),[2]}})})};RemoteStore.prototype.canAddToWritePipeline=function(){return this.networkEnabled&&10>this.writePipeline.length};RemoteStore.prototype.outstandingWrites=function(){return this.writePipeline.length};
RemoteStore.prototype.addToWritePipeline=function(batch){assert(this.canAddToWritePipeline(),"addToWritePipeline called when pipeline is full");this.writePipeline.push(batch);this.writeStream.isOpen()&&this.writeStream.handshakeComplete&&this.writeStream.writeMutations(batch.mutations)};RemoteStore.prototype.shouldStartWriteStream=function(){return this.canUseNetwork()&&!this.writeStream.isStarted()&&0<this.writePipeline.length};RemoteStore.prototype.startWriteStream=function(){assert(this.shouldStartWriteStream(),
"startWriteStream() called when shouldStartWriteStream() is false.");this.writeStream.start()};RemoteStore.prototype.onWriteStreamOpen=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){this.writeStream.writeHandshake();return[2]})})};RemoteStore.prototype.onWriteHandshakeComplete=function(){var _this=this;return this.localStore.setLastStreamToken(this.writeStream.lastStreamToken).then(function(){for(var _i=0,_a=_this.writePipeline;_i<_a.length;_i++)_this.writeStream.writeMutations(_a[_i].mutations)})};
RemoteStore.prototype.onMutationResult=function(commitVersion,results){var _this=this;assert(0<this.writePipeline.length,"Got result for empty write pipeline");var batch=this.writePipeline.shift();commitVersion=MutationBatchResult.from(batch,commitVersion,results,this.writeStream.lastStreamToken);return this.syncEngine.applySuccessfulWrite(commitVersion).then(function(){return _this.fillWritePipeline()})};RemoteStore.prototype.onWriteStreamClose=function(error$$1){return tslib_1.__awaiter(this,void 0,
void 0,function(){var _this=this,errorHandling;return tslib_1.__generator(this,function(_a){void 0===error$$1&&assert(!this.shouldStartWriteStream(),"Write stream was stopped gracefully while still needed.");return error$$1&&0<this.writePipeline.length?(errorHandling=void 0,errorHandling=this.writeStream.handshakeComplete?this.handleWriteError(error$$1):this.handleHandshakeError(error$$1),[2,errorHandling.then(function(){_this.shouldStartWriteStream()&&_this.startWriteStream()})]):[2]})})};RemoteStore.prototype.handleHandshakeError=
function(error$$1){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){return isPermanentError(error$$1.code)||error$$1.code===Code.ABORTED?(debug("RemoteStore","RemoteStore error before completed handshake; resetting stream token: ",this.writeStream.lastStreamToken),this.writeStream.lastStreamToken=emptyByteString(),[2,this.localStore.setLastStreamToken(emptyByteString())]):[2]})})};RemoteStore.prototype.handleWriteError=function(error$$1){return tslib_1.__awaiter(this,
void 0,void 0,function(){var _this=this,batch;return tslib_1.__generator(this,function(_a){return isPermanentError(error$$1.code)?(batch=this.writePipeline.shift(),this.writeStream.inhibitBackoff(),[2,this.syncEngine.rejectFailedWrite(batch.batchId,error$$1).then(function(){return _this.fillWritePipeline()})]):[2]})})};RemoteStore.prototype.createTransaction=function(){return new Transaction(this.datastore)};RemoteStore.prototype.handleUserChange=function(user){return tslib_1.__awaiter(this,void 0,
void 0,function(){return tslib_1.__generator(this,function(_a){switch(_a.label){case 0:debug("RemoteStore","RemoteStore changing users: uid\x3d",user.uid);if(!this.networkEnabled)return[3,2];this.disableNetworkInternal();this.onlineStateTracker.set(OnlineState.Unknown);return[4,this.enableNetwork()];case 1:_a.sent(),_a.label=2;case 2:return[2]}})})};return RemoteStore}(),FirestoreClient=function(){function FirestoreClient(platform,databaseInfo,credentials,asyncQueue){this.platform=platform;this.databaseInfo=
databaseInfo;this.credentials=credentials;this.asyncQueue=asyncQueue}FirestoreClient.prototype.start=function(usePersistence){var _this=this,initializationDone=new Deferred$1,persistenceResult=new Deferred$1,initialized=!1;this.credentials.setUserChangeListener(function(user){initialized?_this.asyncQueue.enqueue(function(){return _this.handleUserChange(user)}):(initialized=!0,_this.initializePersistence(usePersistence,persistenceResult).then(function(){return _this.initializeRest(user)}).then(initializationDone.resolve,
initializationDone.reject))});this.asyncQueue.enqueue(function(){return initializationDone.promise});return persistenceResult.promise};FirestoreClient.prototype.enableNetwork=function(){var _this=this;return this.asyncQueue.enqueue(function(){return _this.remoteStore.enableNetwork()})};FirestoreClient.prototype.initializePersistence=function(usePersistence,persistenceResult){var _this=this;if(usePersistence)return this.startIndexedDbPersistence().then(persistenceResult.resolve).catch(function(error$$1){persistenceResult.reject(error$$1);
if(!_this.canFallback(error$$1))return Promise.reject(error$$1);console.warn("Error enabling offline storage. Falling back to storage disabled: "+error$$1);return _this.startMemoryPersistence()});persistenceResult.resolve();return this.startMemoryPersistence()};FirestoreClient.prototype.canFallback=function(error$$1){return error$$1 instanceof FirestoreError?error$$1.code===Code.FAILED_PRECONDITION||error$$1.code===Code.UNIMPLEMENTED:"undefined"!==typeof DOMException&&error$$1 instanceof DOMException?
22===error$$1.code||20===error$$1.code:!0};FirestoreClient.prototype.startIndexedDbPersistence=function(){this.garbageCollector=new NoOpGarbageCollector;var storagePrefix=IndexedDbPersistence.buildStoragePrefix(this.databaseInfo),serializer=new JsonProtoSerializer(this.databaseInfo.databaseId,{useProto3Json:!0});this.persistence=new IndexedDbPersistence(storagePrefix,serializer);return this.persistence.start()};FirestoreClient.prototype.startMemoryPersistence=function(){this.garbageCollector=new EagerGarbageCollector;
this.persistence=new MemoryPersistence;return this.persistence.start()};FirestoreClient.prototype.initializeRest=function(user){var _this=this;return this.platform.loadConnection(this.databaseInfo).then(function(connection){_this.localStore=new LocalStore(_this.persistence,user,_this.garbageCollector);var serializer=_this.platform.newSerializer(_this.databaseInfo.databaseId);connection=new Datastore(_this.asyncQueue,connection,_this.credentials,serializer);_this.remoteStore=new RemoteStore(_this.localStore,
connection,_this.asyncQueue,function(onlineState){_this.syncEngine.applyOnlineStateChange(onlineState);_this.eventMgr.applyOnlineStateChange(onlineState)});_this.syncEngine=new SyncEngine(_this.localStore,_this.remoteStore,user);_this.remoteStore.syncEngine=_this.syncEngine;_this.eventMgr=new EventManager(_this.syncEngine);return _this.localStore.start()}).then(function(){return _this.remoteStore.start()})};FirestoreClient.prototype.handleUserChange=function(user){this.asyncQueue.verifyOperationInProgress();
debug("FirestoreClient","User Changed: "+user.uid);return this.syncEngine.handleUserChange(user)};FirestoreClient.prototype.disableNetwork=function(){var _this=this;return this.asyncQueue.enqueue(function(){return _this.remoteStore.disableNetwork()})};FirestoreClient.prototype.shutdown=function(options){var _this=this;return this.asyncQueue.enqueue(function(){_this.credentials.removeUserChangeListener();return _this.remoteStore.shutdown()}).then(function(){return _this.persistence.shutdown(options&&
options.purgePersistenceWithDataLoss)})};FirestoreClient.prototype.listen=function(query,observer,options){var _this=this,listener=new QueryListener(query,observer,options);this.asyncQueue.enqueue(function(){return _this.eventMgr.listen(listener)});return listener};FirestoreClient.prototype.unlisten=function(listener){var _this=this;this.asyncQueue.enqueue(function(){return _this.eventMgr.unlisten(listener)})};FirestoreClient.prototype.getDocumentFromLocalCache=function(docKey){var _this=this;return this.asyncQueue.enqueue(function(){return _this.localStore.readDocument(docKey)}).then(function(maybeDoc){if(maybeDoc instanceof
Document$jscomp$0)return maybeDoc;throw new FirestoreError(Code.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)");})};FirestoreClient.prototype.getDocumentsFromLocalCache=function(query){var _this=this;return this.asyncQueue.enqueue(function(){return _this.localStore.executeQuery(query)}).then(function(docs){var view=new View$jscomp$0(query,EMPTY_DOCUMENT_KEY_SET);
docs=view.computeDocChanges(docs);return view.applyChanges(docs).snapshot})};FirestoreClient.prototype.write=function(mutations){var _this=this,deferred=new Deferred$1;this.asyncQueue.enqueue(function(){return _this.syncEngine.write(mutations,deferred)});return deferred.promise};FirestoreClient.prototype.databaseId=function(){return this.databaseInfo.databaseId};FirestoreClient.prototype.transaction=function(updateFunction){var _this=this;return this.asyncQueue.enqueue(function(){return tslib_1.__awaiter(_this,
void 0,void 0,function(){return tslib_1.__generator(this,function(_a){return[2]})})}).then(function(){return _this.syncEngine.runTransaction(updateFunction)})};return FirestoreClient}(),AsyncObserver=function(){function AsyncObserver(observer){this.observer=observer;this.muted=!1}AsyncObserver.prototype.next=function(value){this.scheduleEvent(this.observer.next,value)};AsyncObserver.prototype.error=function(error){this.scheduleEvent(this.observer.error,error)};AsyncObserver.prototype.mute=function(){this.muted=
!0};AsyncObserver.prototype.scheduleEvent=function(eventHandler,event){var _this=this;this.muted||setTimeout(function(){_this.muted||eventHandler(event)},0)};return AsyncObserver}(),User=function(){function User(uid){this.uid=uid}User.prototype.isAuthenticated=function(){return null!=this.uid};User.prototype.toKey=function(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"};User.prototype.isEqual=function(otherUser){return otherUser.uid===this.uid};User.UNAUTHENTICATED=new User(null);
User.GOOGLE_CREDENTIALS=new User("google-credentials-uid");User.FIRST_PARTY=new User("first-party-uid");return User}(),OAuthToken=function(){return function(value,user){this.user=user;this.type="OAuth";this.authHeaders={Authorization:"Bearer "+value}}}(),EmptyCredentialsProvider=function(){function EmptyCredentialsProvider(){this.userListener=null}EmptyCredentialsProvider.prototype.getToken=function(){return Promise.resolve(null)};EmptyCredentialsProvider.prototype.invalidateToken=function(){};EmptyCredentialsProvider.prototype.setUserChangeListener=
function(listener){assert(!this.userListener,"Can only call setUserChangeListener() once.");this.userListener=listener;listener(User.UNAUTHENTICATED)};EmptyCredentialsProvider.prototype.removeUserChangeListener=function(){assert(null!==this.userListener,"removeUserChangeListener() when no listener registered");this.userListener=null};return EmptyCredentialsProvider}(),FirebaseCredentialsProvider=function(){function FirebaseCredentialsProvider(app){var _this=this;this.app=app;this.tokenListener=null;
this.userCounter=0;this.userListener=null;this.forceRefresh=!1;this.tokenListener=function(){var newUser=_this.getUser();_this.currentUser&&newUser.isEqual(_this.currentUser)||(_this.currentUser=newUser,_this.userCounter++,_this.userListener&&_this.userListener(_this.currentUser))};this.userCounter=0;this.app.INTERNAL.addAuthTokenListener(this.tokenListener)}FirebaseCredentialsProvider.prototype.getToken=function(){var _this=this;assert(null!=this.tokenListener,"getToken cannot be called after listener removed.");
var initialUserCounter=this.userCounter,forceRefresh=this.forceRefresh;this.forceRefresh=!1;return this.app.INTERNAL.getToken(forceRefresh).then(function(tokenData){if(_this.userCounter!==initialUserCounter)throw new FirestoreError(Code.ABORTED,"getToken aborted due to uid change.");return tokenData?(assert("string"===typeof tokenData.accessToken,"Invalid tokenData returned from getToken():"+tokenData),new OAuthToken(tokenData.accessToken,_this.currentUser)):null})};FirebaseCredentialsProvider.prototype.invalidateToken=
function(){this.forceRefresh=!0};FirebaseCredentialsProvider.prototype.setUserChangeListener=function(listener){assert(!this.userListener,"Can only call setUserChangeListener() once.");this.userListener=listener;this.currentUser&&listener(this.currentUser)};FirebaseCredentialsProvider.prototype.removeUserChangeListener=function(){assert(null!=this.tokenListener,"removeUserChangeListener() called twice");assert(null!==this.userListener,"removeUserChangeListener() called when no listener registered");
this.app.INTERNAL.removeAuthTokenListener(this.tokenListener);this.userListener=this.tokenListener=null};FirebaseCredentialsProvider.prototype.getUser=function(){"function"!==typeof this.app.INTERNAL.getUid&&fail("This version of the Firestore SDK requires at least version 3.7.0 of firebase.js.");var currentUid=this.app.INTERNAL.getUid();assert(null===currentUid||"string"===typeof currentUid,"Received invalid UID: "+currentUid);return new User(currentUid)};return FirebaseCredentialsProvider}(),FirstPartyToken=
function(){function FirstPartyToken(gapi,sessionIndex){this.gapi=gapi;this.sessionIndex=sessionIndex;this.type="FirstParty";this.user=User.FIRST_PARTY;assert(this.gapi&&this.gapi.auth&&this.gapi.auth.getAuthHeaderValueForFirstParty,"unexpected gapi interface")}Object.defineProperty(FirstPartyToken.prototype,"authHeaders",{get:function(){return{Authorization:this.gapi.auth.getAuthHeaderValueForFirstParty([]),"X-Goog-AuthUser":this.sessionIndex}},enumerable:!0,configurable:!0});return FirstPartyToken}(),
FirstPartyCredentialsProvider=function(){function FirstPartyCredentialsProvider(gapi,sessionIndex){this.gapi=gapi;this.sessionIndex=sessionIndex;assert(this.gapi&&this.gapi.auth&&this.gapi.auth.getAuthHeaderValueForFirstParty,"unexpected gapi interface")}FirstPartyCredentialsProvider.prototype.getToken=function(){return Promise.resolve(new FirstPartyToken(this.gapi,this.sessionIndex))};FirstPartyCredentialsProvider.prototype.setUserChangeListener=function(listener){listener(User.FIRST_PARTY)};FirstPartyCredentialsProvider.prototype.removeUserChangeListener=
function(){};FirstPartyCredentialsProvider.prototype.invalidateToken=function(){};return FirstPartyCredentialsProvider}(),FieldValueImpl=function(){function FieldValueImpl(methodName){this.methodName=methodName}FieldValueImpl.delete=function(){return DeleteFieldValueImpl.instance};FieldValueImpl.serverTimestamp=function(){return ServerTimestampFieldValueImpl.instance};FieldValueImpl.arrayUnion=function(){for(var elements=[],_i=0;_i<arguments.length;_i++)elements[_i]=arguments[_i];validateAtLeastNumberOfArgs("FieldValue.arrayUnion",
arguments,1);return new ArrayUnionFieldValueImpl(elements)};FieldValueImpl.arrayRemove=function(){for(var elements=[],_i=0;_i<arguments.length;_i++)elements[_i]=arguments[_i];validateAtLeastNumberOfArgs("FieldValue.arrayRemove",arguments,1);return new ArrayRemoveFieldValueImpl(elements)};FieldValueImpl.prototype.isEqual=function(other){return this===other};return FieldValueImpl}(),DeleteFieldValueImpl=function(_super){function DeleteFieldValueImpl(){return _super.call(this,"FieldValue.delete")||this}
tslib_1.__extends(DeleteFieldValueImpl,_super);DeleteFieldValueImpl.instance=new DeleteFieldValueImpl;return DeleteFieldValueImpl}(FieldValueImpl),ServerTimestampFieldValueImpl=function(_super){function ServerTimestampFieldValueImpl(){return _super.call(this,"FieldValue.serverTimestamp")||this}tslib_1.__extends(ServerTimestampFieldValueImpl,_super);ServerTimestampFieldValueImpl.instance=new ServerTimestampFieldValueImpl;return ServerTimestampFieldValueImpl}(FieldValueImpl),ArrayUnionFieldValueImpl=
function(_super){function ArrayUnionFieldValueImpl(_elements){var _this=_super.call(this,"FieldValue.arrayUnion")||this;_this._elements=_elements;return _this}tslib_1.__extends(ArrayUnionFieldValueImpl,_super);return ArrayUnionFieldValueImpl}(FieldValueImpl),ArrayRemoveFieldValueImpl=function(_super){function ArrayRemoveFieldValueImpl(_elements){var _this=_super.call(this,"FieldValue.arrayRemove")||this;_this._elements=_elements;return _this}tslib_1.__extends(ArrayRemoveFieldValueImpl,_super);return ArrayRemoveFieldValueImpl}(FieldValueImpl),
PublicFieldValue=makeConstructorPrivate(FieldValueImpl,"Use FieldValue.\x3cfield\x3e() instead."),RESERVED_FIELD_REGEX=/^__.*__$/,ParsedSetData=function(){function ParsedSetData(data,fieldMask,fieldTransforms){this.data=data;this.fieldMask=fieldMask;this.fieldTransforms=fieldTransforms}ParsedSetData.prototype.toMutations=function(key,precondition){var mutations=[];null!==this.fieldMask?mutations.push(new PatchMutation(key,this.data,this.fieldMask,precondition)):mutations.push(new SetMutation(key,
this.data,precondition));0<this.fieldTransforms.length&&mutations.push(new TransformMutation(key,this.fieldTransforms));return mutations};return ParsedSetData}(),ParsedUpdateData=function(){function ParsedUpdateData(data,fieldMask,fieldTransforms){this.data=data;this.fieldMask=fieldMask;this.fieldTransforms=fieldTransforms}ParsedUpdateData.prototype.toMutations=function(key,precondition){precondition=[new PatchMutation(key,this.data,this.fieldMask,precondition)];0<this.fieldTransforms.length&&precondition.push(new TransformMutation(key,
this.fieldTransforms));return precondition};return ParsedUpdateData}(),UserDataSource;(function(UserDataSource){UserDataSource[UserDataSource.Set=0]="Set";UserDataSource[UserDataSource.Update=1]="Update";UserDataSource[UserDataSource.MergeSet=2]="MergeSet";UserDataSource[UserDataSource.Argument=3]="Argument"})(UserDataSource||(UserDataSource={}));var ParseContext=function(){function ParseContext(dataSource,methodName,path,arrayElement,fieldTransforms,fieldMask){this.dataSource=dataSource;this.methodName=
methodName;this.path=path;this.arrayElement=arrayElement;void 0===fieldTransforms&&this.validatePath();this.arrayElement=void 0!==arrayElement?arrayElement:!1;this.fieldTransforms=fieldTransforms||[];this.fieldMask=fieldMask||[]}ParseContext.prototype.childContextForField=function(field){var childPath=null==this.path?null:this.path.child(field);childPath=new ParseContext(this.dataSource,this.methodName,childPath,!1,this.fieldTransforms,this.fieldMask);childPath.validatePathSegment(field);return childPath};
ParseContext.prototype.childContextForFieldPath=function(field){field=null==this.path?null:this.path.child(field);field=new ParseContext(this.dataSource,this.methodName,field,!1,this.fieldTransforms,this.fieldMask);field.validatePath();return field};ParseContext.prototype.childContextForArray=function(index){return new ParseContext(this.dataSource,this.methodName,null,!0,this.fieldTransforms,this.fieldMask)};ParseContext.prototype.createError=function(reason){var fieldDescription=null===this.path||
this.path.isEmpty()?"":" (found in field "+this.path.toString()+")";return new FirestoreError(Code.INVALID_ARGUMENT,"Function "+this.methodName+"() called with invalid data. "+reason+fieldDescription)};ParseContext.prototype.contains=function(fieldPath){return void 0!==this.fieldMask.find(function(field){return fieldPath.isPrefixOf(field)})||void 0!==this.fieldTransforms.find(function(transform){return fieldPath.isPrefixOf(transform.field)})};ParseContext.prototype.validatePath=function(){if(null!==
this.path)for(var i=0;i<this.path.length;i++)this.validatePathSegment(this.path.get(i))};ParseContext.prototype.validatePathSegment=function(segment){if(isWrite(this.dataSource)&&RESERVED_FIELD_REGEX.test(segment))throw this.createError("Document fields cannot begin and end with __");};return ParseContext}(),DocumentKeyReference=function(){return function(databaseId,key){this.databaseId=databaseId;this.key=key}}(),UserDataConverter=function(){function UserDataConverter(preConverter){this.preConverter=
preConverter}UserDataConverter.prototype.parseSetData=function(methodName,input){methodName=new ParseContext(UserDataSource.Set,methodName,FieldPath.EMPTY_PATH);validatePlainObject("Data must be an object, but it was:",methodName,input);input=this.parseData(input,methodName);return new ParsedSetData(input,null,methodName.fieldTransforms)};UserDataConverter.prototype.parseMergeData=function(methodName,input,fieldPaths){var context=new ParseContext(UserDataSource.MergeSet,methodName,FieldPath.EMPTY_PATH);
validatePlainObject("Data must be an object, but it was:",context,input);input=this.parseData(input,context);if(fieldPaths){for(var validatedFieldPaths=[],_i=0;_i<fieldPaths.length;_i++){var stringOrFieldPath=fieldPaths[_i],fieldPath=void 0;stringOrFieldPath instanceof FieldPath$1?fieldPath=stringOrFieldPath:"string"===typeof stringOrFieldPath?fieldPath=fieldPathFromDotSeparatedString(methodName,stringOrFieldPath):fail("Expected stringOrFieldPath to be a string or a FieldPath");if(!context.contains(fieldPath))throw new FirestoreError(Code.INVALID_ARGUMENT,
"Field '"+fieldPath+"' is specified in your field mask but missing from your input data.");validatedFieldPaths.push(fieldPath)}var fieldMask=new FieldMask(validatedFieldPaths);methodName=context.fieldTransforms.filter(function(transform){return fieldMask.covers(transform.field)})}else fieldMask=new FieldMask(context.fieldMask),methodName=context.fieldTransforms;return new ParsedSetData(input,fieldMask,methodName)};UserDataConverter.prototype.parseUpdateData=function(methodName,input){var _this=this,
context=new ParseContext(UserDataSource.Update,methodName,FieldPath.EMPTY_PATH);validatePlainObject("Data must be an object, but it was:",context,input);var fieldMaskPaths=[],updateData=ObjectValue.EMPTY;forEach(input,function(key,value){key=fieldPathFromDotSeparatedString(methodName,key);var childContext=context.childContextForFieldPath(key);value=_this.runPreConverter(value,childContext);value instanceof DeleteFieldValueImpl?fieldMaskPaths.push(key):(value=_this.parseData(value,childContext),null!=
value&&(fieldMaskPaths.push(key),updateData=updateData.set(key,value)))});input=new FieldMask(fieldMaskPaths);return new ParsedUpdateData(updateData,input,context.fieldTransforms)};UserDataConverter.prototype.parseUpdateVarargs=function(methodName,field,value,moreFieldsAndValues){var context=new ParseContext(UserDataSource.Update,methodName,FieldPath.EMPTY_PATH);field=[fieldPathFromArgument(methodName,field)];value=[value];if(0!==moreFieldsAndValues.length%2)throw new FirestoreError(Code.INVALID_ARGUMENT,
"Function "+methodName+"() needs to be called with an even number of arguments that alternate between field names and values.");for(var i=0;i<moreFieldsAndValues.length;i+=2)field.push(fieldPathFromArgument(methodName,moreFieldsAndValues[i])),value.push(moreFieldsAndValues[i+1]);moreFieldsAndValues=[];methodName=ObjectValue.EMPTY;for(i=0;i<field.length;++i){var path=field[i],childContext=context.childContextForFieldPath(path),value_1=this.runPreConverter(value[i],childContext);value_1 instanceof DeleteFieldValueImpl?
moreFieldsAndValues.push(path):(childContext=this.parseData(value_1,childContext),null!=childContext&&(moreFieldsAndValues.push(path),methodName=methodName.set(path,childContext)))}field=new FieldMask(moreFieldsAndValues);return new ParsedUpdateData(methodName,field,context.fieldTransforms)};UserDataConverter.prototype.parseQueryValue=function(methodName,input){methodName=new ParseContext(UserDataSource.Argument,methodName,FieldPath.EMPTY_PATH);input=this.parseData(input,methodName);assert(null!=
input,"Parsed data should not be null.");assert(0===methodName.fieldTransforms.length,"Field transforms should have been disallowed.");return input};UserDataConverter.prototype.runPreConverter=function(input,context){try{return this.preConverter(input)}catch(e){throw context.createError(e instanceof Error?e.message:e.toString());}};UserDataConverter.prototype.parseData=function(input,context){input=this.runPreConverter(input,context);if(looksLikeJsonObject(input))return validatePlainObject("Unsupported field value:",
context,input),this.parseObject(input,context);if(input instanceof FieldValueImpl)return this.parseSentinelFieldValue(input,context),null;context.path&&context.fieldMask.push(context.path);if(input instanceof Array){if(context.arrayElement)throw context.createError("Nested arrays are not supported");return this.parseArray(input,context)}return this.parseScalarValue(input,context)};UserDataConverter.prototype.parseObject=function(obj,context){var _this=this,result=new SortedMap$jscomp$0(primitiveComparator);
forEach(obj,function(key,val){val=_this.parseData(val,context.childContextForField(key));null!=val&&(result=result.insert(key,val))});return new ObjectValue(result)};UserDataConverter.prototype.parseArray=function(array,context){for(var result=[],entryIndex=0,_i=0;_i<array.length;_i++){var parsedEntry=this.parseData(array[_i],context.childContextForArray(entryIndex));null==parsedEntry&&(parsedEntry=NullValue.INSTANCE);result.push(parsedEntry);entryIndex++}return new ArrayValue(result)};UserDataConverter.prototype.parseSentinelFieldValue=
function(value,context){if(!isWrite(context.dataSource))throw context.createError(value.methodName+"() can only be used with update() and set()");if(null===context.path)throw context.createError(value.methodName+"() is not currently supported inside arrays");if(value instanceof DeleteFieldValueImpl)if(context.dataSource===UserDataSource.MergeSet)context.fieldMask.push(context.path);else{if(context.dataSource===UserDataSource.Update)throw assert(0<context.path.length,"FieldValue.delete() at the top level should have already been handled."),
context.createError("FieldValue.delete() can only appear at the top level of your update data");throw context.createError("FieldValue.delete() cannot be used with set() unless you pass {merge:true}");}else value instanceof ServerTimestampFieldValueImpl?context.fieldTransforms.push(new FieldTransform(context.path,ServerTimestampTransform.instance)):value instanceof ArrayUnionFieldValueImpl?(value=this.parseArrayTransformElements(value.methodName,value._elements),value=new ArrayUnionTransformOperation(value),
context.fieldTransforms.push(new FieldTransform(context.path,value))):value instanceof ArrayRemoveFieldValueImpl?(value=this.parseArrayTransformElements(value.methodName,value._elements),value=new ArrayRemoveTransformOperation(value),context.fieldTransforms.push(new FieldTransform(context.path,value))):fail("Unknown FieldValue type: "+value)};UserDataConverter.prototype.parseScalarValue=function(value,context){if(null===value)return NullValue.INSTANCE;if("number"===typeof value)return isInteger(value)&&
value<=MAX_SAFE_INTEGER&&value>=MIN_SAFE_INTEGER?new IntegerValue(value):new DoubleValue(value);if("boolean"===typeof value)return BooleanValue.of(value);if("string"===typeof value)return new StringValue(value);if(value instanceof Date)return new TimestampValue(Timestamp.fromDate(value));if(value instanceof Timestamp)return new TimestampValue(new Timestamp(value.seconds,1E3*Math.floor(value.nanoseconds/1E3)));if(value instanceof GeoPoint)return new GeoPointValue(value);if(value instanceof Blob$jscomp$0)return new BlobValue(value);
if(value instanceof DocumentKeyReference)return new RefValue(value.databaseId,value.key);throw context.createError("Unsupported field value: "+valueDescription(value));};UserDataConverter.prototype.parseArrayTransformElements=function(methodName,elements){var _this=this;return elements.map(function(element,i){var context=new ParseContext(UserDataSource.Argument,methodName,FieldPath.EMPTY_PATH);return _this.parseData(element,context.childContextForArray(i))})};return UserDataConverter}(),FirestoreSettings=
function(){function FirestoreSettings(settings){if(void 0===settings.host){if(void 0!==settings.ssl)throw new FirestoreError(Code.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com";this.ssl=!0}else{validateType("settings","string","host option",settings.host);this.host=settings.host;validateNamedOptionalType("settings","boolean","ssl",settings.ssl);var value=settings.ssl;this.ssl=void 0!==value?value:!0}validateOptionNames("settings",settings,
["host","ssl","credentials","timestampsInSnapshots"]);validateNamedOptionalType("settings","object","credentials",settings.credentials);this.credentials=settings.credentials;validateNamedOptionalType("settings","boolean","timestampsInSnapshots",settings.timestampsInSnapshots);settings=settings.timestampsInSnapshots;this.timestampsInSnapshots=void 0!==settings?settings:!1}FirestoreSettings.prototype.isEqual=function(other){return this.host===other.host&&this.ssl===other.ssl&&this.timestampsInSnapshots===
other.timestampsInSnapshots&&this.credentials===other.credentials};return FirestoreSettings}(),FirestoreConfig=function(){return function(){}}(),Firestore=function(){function Firestore(databaseIdOrApp){var _this=this;this._queue=new AsyncQueue;this.INTERNAL={delete:function(options){return tslib_1.__awaiter(_this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){return this._firestoreClient?[2,this._firestoreClient.shutdown(options)]:[2]})})}};var config=new FirestoreConfig;if("object"===
typeof databaseIdOrApp.options)config.firebaseApp=databaseIdOrApp,config.databaseId=Firestore.databaseIdFromApp(databaseIdOrApp),config.persistenceKey=config.firebaseApp.name,config.credentials=new FirebaseCredentialsProvider(databaseIdOrApp);else{if(!databaseIdOrApp.projectId)throw new FirestoreError(Code.INVALID_ARGUMENT,"Must provide projectId");config.databaseId=new DatabaseId(databaseIdOrApp.projectId,databaseIdOrApp.database);config.persistenceKey="[DEFAULT]";config.credentials=new EmptyCredentialsProvider}config.settings=
new FirestoreSettings({});this._config=config;this._databaseId=config.databaseId}Firestore.prototype.settings=function(settingsLiteral){validateExactNumberOfArgs("Firestore.settings",arguments,1);validateArgType("Firestore.settings","object",1,settingsLiteral);if(contains(settingsLiteral,"persistence"))throw new FirestoreError(Code.INVALID_ARGUMENT,'"persistence" is now specified with a separate call to firestore.enablePersistence().');var newSettings=new FirestoreSettings(settingsLiteral);if(this._firestoreClient&&
!this._config.settings.isEqual(newSettings))throw new FirestoreError(Code.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only call settings() before calling any other methods on a Firestore object.");this._config.settings=newSettings;if(void 0!==newSettings.credentials){var JSCompiler_temp_const=this._config;a:if(newSettings=newSettings.credentials)switch(newSettings.type){case "gapi":newSettings=new FirstPartyCredentialsProvider(newSettings.client,
newSettings.sessionIndex||"0");break a;case "provider":newSettings=newSettings.client;break a;default:throw new FirestoreError(Code.INVALID_ARGUMENT,"makeCredentialsProvider failed due to invalid credential type");}else newSettings=new EmptyCredentialsProvider;JSCompiler_temp_const.credentials=newSettings}};Firestore.prototype.enableNetwork=function(){this.ensureClientConfigured();return this._firestoreClient.enableNetwork()};Firestore.prototype.disableNetwork=function(){this.ensureClientConfigured();
return this._firestoreClient.disableNetwork()};Firestore.prototype.enablePersistence=function(){if(this._firestoreClient)throw new FirestoreError(Code.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only call enablePersistence() before calling any other methods on a Firestore object.");return this.configureClient(!0)};Firestore.prototype.ensureClientConfigured=function(){this._firestoreClient||this.configureClient(!1);return this._firestoreClient};
Firestore.prototype.configureClient=function(persistence){var _this=this;assert(!!this._config.settings.host,"FirestoreSettings.host cannot be falsey");this._config.settings.timestampsInSnapshots||error$jscomp$0("\nThe behavior for Date objects stored in Firestore is going to change\nAND YOUR APP MAY BREAK.\nTo hide this warning and ensure your app does not break, you need to add the\nfollowing code to your app before calling any other Cloud Firestore methods:\n\n  const firestore \x3d firebase.firestore();\n  const settings \x3d {/* your settings... */ timestampsInSnapshots: true};\n  firestore.settings(settings);\n\nWith this change, timestamps stored in Cloud Firestore will be read back as\nFirebase Timestamp objects instead of as system Date objects. So you will also\nneed to update code expecting a Date to instead expect a Timestamp. For example:\n\n  // Old:\n  const date \x3d snapshot.get('created_at');\n  // New:\n  const timestamp \x3d snapshot.get('created_at');\n  const date \x3d timestamp.toDate();\n\nPlease audit all existing usages of Date when you enable the new behavior. In a\nfuture release, the behavior will change to the new behavior, so if you do not\nfollow these steps, YOUR APP MAY BREAK.");
assert(!this._firestoreClient,"configureClient() called multiple times");var databaseInfo=new DatabaseInfo(this._config.databaseId,this._config.persistenceKey,this._config.settings.host,this._config.settings.ssl);this._dataConverter=new UserDataConverter(function(value){if(value instanceof DocumentReference){var thisDb=_this._config.databaseId,otherDb=value.firestore._config.databaseId;if(!otherDb.isEqual(thisDb))throw new FirestoreError(Code.INVALID_ARGUMENT,"Document reference is for database "+
(otherDb.projectId+"/"+otherDb.database+" but should be ")+("for database "+thisDb.projectId+"/"+thisDb.database));return new DocumentKeyReference(_this._config.databaseId,value._key)}return value});this._firestoreClient=new FirestoreClient(PlatformSupport.getPlatform(),databaseInfo,this._config.credentials,this._queue);return this._firestoreClient.start(persistence)};Firestore.databaseIdFromApp=function(app){app=app.options;if(!contains(app,"projectId")){if(contains(app,"firestoreId"))throw new FirestoreError(Code.INVALID_ARGUMENT,
'"firestoreId" is now specified as "projectId" in firebase.initializeApp.');throw new FirestoreError(Code.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');}if(contains(app,"firestoreOptions"))throw new FirestoreError(Code.INVALID_ARGUMENT,'"firestoreOptions" values are now specified with Firestore.settings()');app=app.projectId;if(!app||"string"!==typeof app)throw new FirestoreError(Code.INVALID_ARGUMENT,"projectId must be a string in FirebaseApp.options");return new DatabaseId(app)};
Object.defineProperty(Firestore.prototype,"app",{get:function(){if(!this._config.firebaseApp)throw new FirestoreError(Code.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._config.firebaseApp},enumerable:!0,configurable:!0});Firestore.prototype.collection=function(pathString){validateExactNumberOfArgs("Firestore.collection",arguments,1);validateArgType("Firestore.collection","string",1,pathString);if(!pathString)throw new FirestoreError(Code.INVALID_ARGUMENT,
"Must provide a non-empty collection path to collection()");this.ensureClientConfigured();return new CollectionReference(ResourcePath.fromString(pathString),this)};Firestore.prototype.doc=function(pathString){validateExactNumberOfArgs("Firestore.doc",arguments,1);validateArgType("Firestore.doc","string",1,pathString);if(!pathString)throw new FirestoreError(Code.INVALID_ARGUMENT,"Must provide a non-empty document path to doc()");this.ensureClientConfigured();return DocumentReference.forPath(ResourcePath.fromString(pathString),
this)};Firestore.prototype.runTransaction=function(updateFunction){var _this=this;validateExactNumberOfArgs("Firestore.runTransaction",arguments,1);validateArgType("Firestore.runTransaction","function",1,updateFunction);return this.ensureClientConfigured().transaction(function(transaction){return updateFunction(new Transaction$1(_this,transaction))})};Firestore.prototype.batch=function(){this.ensureClientConfigured();return new WriteBatch(this)};Object.defineProperty(Firestore,"logLevel",{get:function(){switch(getLogLevel()){case LogLevel$jscomp$0.DEBUG:return"debug";
case LogLevel$jscomp$0.ERROR:return"error";case LogLevel$jscomp$0.SILENT:return"silent";default:return fail("Unknown log level: "+getLogLevel())}},enumerable:!0,configurable:!0});Firestore.setLogLevel=function(level){validateExactNumberOfArgs("Firestore.setLogLevel",arguments,1);validateArgType("Firestore.setLogLevel","string",1,level);switch(level){case "debug":setLogLevel(LogLevel$jscomp$0.DEBUG);break;case "error":setLogLevel(LogLevel$jscomp$0.ERROR);break;case "silent":setLogLevel(LogLevel$jscomp$0.SILENT);
break;default:throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid log level: "+level);}};Firestore.prototype._areTimestampsInSnapshotsEnabled=function(){return this._config.settings.timestampsInSnapshots};return Firestore}(),Transaction$1=function(){function Transaction(_firestore,_transaction){this._firestore=_firestore;this._transaction=_transaction}Transaction.prototype.get=function(documentRef){var _this=this;validateExactNumberOfArgs("Transaction.get",arguments,1);var ref=validateReference("Transaction.get",
documentRef,this._firestore);return this._transaction.lookup([ref._key]).then(function(docs){if(!docs||1!==docs.length)return fail("Mismatch in docs returned from document lookup.");docs=docs[0];return docs instanceof NoDocument?new DocumentSnapshot(_this._firestore,ref._key,null,!1):new DocumentSnapshot(_this._firestore,ref._key,docs,!1)})};Transaction.prototype.set=function(documentRef,value,options){validateBetweenNumberOfArgs("Transaction.set",arguments,2,3);var ref=validateReference("Transaction.set",
documentRef,this._firestore);options=validateSetOptions("Transaction.set",options);var parsed=options.merge||options.mergeFields?this._firestore._dataConverter.parseMergeData("Transaction.set",value,options.mergeFields):this._firestore._dataConverter.parseSetData("Transaction.set",value);this._transaction.set(ref._key,parsed);return this};Transaction.prototype.update=function(documentRef,fieldOrUpdateData,value){for(var moreFieldsAndValues=[],_i=3;_i<arguments.length;_i++)moreFieldsAndValues[_i-3]=
arguments[_i];"string"===typeof fieldOrUpdateData||fieldOrUpdateData instanceof FieldPath$1?(validateAtLeastNumberOfArgs("Transaction.update",arguments,3),_i=validateReference("Transaction.update",documentRef,this._firestore),moreFieldsAndValues=this._firestore._dataConverter.parseUpdateVarargs("Transaction.update",fieldOrUpdateData,value,moreFieldsAndValues)):(validateExactNumberOfArgs("Transaction.update",arguments,2),_i=validateReference("Transaction.update",documentRef,this._firestore),moreFieldsAndValues=
this._firestore._dataConverter.parseUpdateData("Transaction.update",fieldOrUpdateData));this._transaction.update(_i._key,moreFieldsAndValues);return this};Transaction.prototype.delete=function(documentRef){validateExactNumberOfArgs("Transaction.delete",arguments,1);var ref=validateReference("Transaction.delete",documentRef,this._firestore);this._transaction.delete(ref._key);return this};return Transaction}(),WriteBatch=function(){function WriteBatch(_firestore){this._firestore=_firestore;this._mutations=
[];this._committed=!1}WriteBatch.prototype.set=function(documentRef,value,options){validateBetweenNumberOfArgs("WriteBatch.set",arguments,2,3);this.verifyNotCommitted();var ref=validateReference("WriteBatch.set",documentRef,this._firestore);options=validateSetOptions("WriteBatch.set",options);var parsed=options.merge||options.mergeFields?this._firestore._dataConverter.parseMergeData("WriteBatch.set",value,options.mergeFields):this._firestore._dataConverter.parseSetData("WriteBatch.set",value);this._mutations=
this._mutations.concat(parsed.toMutations(ref._key,Precondition.NONE));return this};WriteBatch.prototype.update=function(documentRef,fieldOrUpdateData,value){for(var moreFieldsAndValues=[],_i=3;_i<arguments.length;_i++)moreFieldsAndValues[_i-3]=arguments[_i];this.verifyNotCommitted();"string"===typeof fieldOrUpdateData||fieldOrUpdateData instanceof FieldPath$1?(validateAtLeastNumberOfArgs("WriteBatch.update",arguments,3),_i=validateReference("WriteBatch.update",documentRef,this._firestore),moreFieldsAndValues=
this._firestore._dataConverter.parseUpdateVarargs("WriteBatch.update",fieldOrUpdateData,value,moreFieldsAndValues)):(validateExactNumberOfArgs("WriteBatch.update",arguments,2),_i=validateReference("WriteBatch.update",documentRef,this._firestore),moreFieldsAndValues=this._firestore._dataConverter.parseUpdateData("WriteBatch.update",fieldOrUpdateData));this._mutations=this._mutations.concat(moreFieldsAndValues.toMutations(_i._key,Precondition.exists(!0)));return this};WriteBatch.prototype.delete=function(documentRef){validateExactNumberOfArgs("WriteBatch.delete",
arguments,1);this.verifyNotCommitted();var ref=validateReference("WriteBatch.delete",documentRef,this._firestore);this._mutations=this._mutations.concat(new DeleteMutation(ref._key,Precondition.NONE));return this};WriteBatch.prototype.commit=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(_a){this.verifyNotCommitted();this._committed=!0;return 0<this._mutations.length?[2,this._firestore.ensureClientConfigured().write(this._mutations)]:[2]})})};
WriteBatch.prototype.verifyNotCommitted=function(){if(this._committed)throw new FirestoreError(Code.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.");};return WriteBatch}(),DocumentReference=function(){function DocumentReference(_key,firestore){this._key=_key;this.firestore=firestore;this._firestoreClient=this.firestore.ensureClientConfigured()}DocumentReference.forPath=function(path,firestore){if(0!==path.length%2)throw new FirestoreError(Code.INVALID_ARGUMENT,
"Invalid document reference. Document references must have an even number of segments, but "+(path.canonicalString()+" has "+path.length));return new DocumentReference(new DocumentKey(path),firestore)};Object.defineProperty(DocumentReference.prototype,"id",{get:function(){return this._key.path.lastSegment()},enumerable:!0,configurable:!0});Object.defineProperty(DocumentReference.prototype,"parent",{get:function(){return new CollectionReference(this._key.path.popLast(),this.firestore)},enumerable:!0,
configurable:!0});Object.defineProperty(DocumentReference.prototype,"path",{get:function(){return this._key.path.canonicalString()},enumerable:!0,configurable:!0});DocumentReference.prototype.collection=function(pathString){validateExactNumberOfArgs("DocumentReference.collection",arguments,1);validateArgType("DocumentReference.collection","string",1,pathString);if(!pathString)throw new FirestoreError(Code.INVALID_ARGUMENT,"Must provide a non-empty collection name to collection()");var path=ResourcePath.fromString(pathString);
return new CollectionReference(this._key.path.child(path),this.firestore)};DocumentReference.prototype.isEqual=function(other){if(!(other instanceof DocumentReference))throw invalidClassError("isEqual","DocumentReference",1,other);return this.firestore===other.firestore&&this._key.isEqual(other._key)};DocumentReference.prototype.set=function(value,options){validateBetweenNumberOfArgs("DocumentReference.set",arguments,1,2);options=validateSetOptions("DocumentReference.set",options);var parsed=options.merge||
options.mergeFields?this.firestore._dataConverter.parseMergeData("DocumentReference.set",value,options.mergeFields):this.firestore._dataConverter.parseSetData("DocumentReference.set",value);return this._firestoreClient.write(parsed.toMutations(this._key,Precondition.NONE))};DocumentReference.prototype.update=function(fieldOrUpdateData,value){for(var moreFieldsAndValues=[],_i=2;_i<arguments.length;_i++)moreFieldsAndValues[_i-2]=arguments[_i];"string"===typeof fieldOrUpdateData||fieldOrUpdateData instanceof
FieldPath$1?(validateAtLeastNumberOfArgs("DocumentReference.update",arguments,2),moreFieldsAndValues=this.firestore._dataConverter.parseUpdateVarargs("DocumentReference.update",fieldOrUpdateData,value,moreFieldsAndValues)):(validateExactNumberOfArgs("DocumentReference.update",arguments,1),moreFieldsAndValues=this.firestore._dataConverter.parseUpdateData("DocumentReference.update",fieldOrUpdateData));return this._firestoreClient.write(moreFieldsAndValues.toMutations(this._key,Precondition.exists(!0)))};
DocumentReference.prototype.delete=function(){validateExactNumberOfArgs("DocumentReference.delete",arguments,0);return this._firestoreClient.write([new DeleteMutation(this._key,Precondition.NONE)])};DocumentReference.prototype.onSnapshot=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];validateBetweenNumberOfArgs("DocumentReference.onSnapshot",arguments,1,4);var options={includeMetadataChanges:!1};_i=0;"object"!==typeof args[_i]||isPartialObserver(args[_i])||(options=
args[_i],validateOptionNames("DocumentReference.onSnapshot",options,["includeMetadataChanges"]),validateNamedOptionalType("DocumentReference.onSnapshot","boolean","includeMetadataChanges",options.includeMetadataChanges),_i++);options={includeMetadataChanges:options.includeMetadataChanges};isPartialObserver(args[_i])?args=args[_i]:(validateArgType("DocumentReference.onSnapshot","function",_i,args[_i]),validateOptionalArgType("DocumentReference.onSnapshot","function",_i+1,args[_i+1]),validateOptionalArgType("DocumentReference.onSnapshot",
"function",_i+2,args[_i+2]),args={next:args[_i],error:args[_i+1],complete:args[_i+2]});return this.onSnapshotInternal(options,args)};DocumentReference.prototype.onSnapshotInternal=function(options,observer){var _this=this,errHandler=function(err){console.error("Uncaught Error in onSnapshot:",err)};observer.error&&(errHandler=observer.error.bind(observer));var asyncObserver=new AsyncObserver({next:function(snapshot){if(observer.next){assert(1>=snapshot.docs.size,"Too many documents returned on a document query");
var doc=snapshot.docs.get(_this._key);observer.next(new DocumentSnapshot(_this.firestore,_this._key,doc,snapshot.fromCache))}},error:errHandler}),internalListener=this._firestoreClient.listen(Query$jscomp$0.atPath(this._key.path),asyncObserver,options);return function(){asyncObserver.mute();_this._firestoreClient.unlisten(internalListener)}};DocumentReference.prototype.get=function(options){var _this=this;validateOptionNames("DocumentReference.get",options,["source"]);options&&validateNamedOptionalPropertyEquals("DocumentReference.get",
"options","source",options.source,["default","server","cache"]);return new Promise(function(resolve,reject){options&&"cache"===options.source?_this.firestore.ensureClientConfigured().getDocumentFromLocalCache(_this._key).then(function(doc){resolve(new DocumentSnapshot(_this.firestore,_this._key,doc,!0))},reject):_this.getViaSnapshotListener(resolve,reject,options)})};DocumentReference.prototype.getViaSnapshotListener=function(resolve,reject,options){var unlisten=this.onSnapshotInternal({includeMetadataChanges:!0,
waitForSyncWhenOnline:!0},{next:function(snap){unlisten();!snap.exists&&snap.metadata.fromCache?reject(new FirestoreError(Code.UNAVAILABLE,"Failed to get document because the client is offline.")):snap.exists&&snap.metadata.fromCache&&options&&"server"===options.source?reject(new FirestoreError(Code.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):resolve(snap)},
error:reject})};return DocumentReference}(),SnapshotMetadata=function(){function SnapshotMetadata(hasPendingWrites,fromCache){this.hasPendingWrites=hasPendingWrites;this.fromCache=fromCache}SnapshotMetadata.prototype.isEqual=function(other){return this.hasPendingWrites===other.hasPendingWrites&&this.fromCache===other.fromCache};return SnapshotMetadata}(),DocumentSnapshot=function(){function DocumentSnapshot(_firestore,_key,_document,_fromCache){this._firestore=_firestore;this._key=_key;this._document=
_document;this._fromCache=_fromCache}DocumentSnapshot.prototype.data=function(options){validateBetweenNumberOfArgs("DocumentSnapshot.data",arguments,0,1);options=validateSnapshotOptions("DocumentSnapshot.data",options);return this._document?this.convertObject(this._document.data,FieldValueOptions.fromSnapshotOptions(options,this._firestore._areTimestampsInSnapshotsEnabled())):void 0};DocumentSnapshot.prototype.get=function(fieldPath,options){validateBetweenNumberOfArgs("DocumentSnapshot.get",arguments,
1,2);options=validateSnapshotOptions("DocumentSnapshot.get",options);if(this._document){var value=this._document.data.field(fieldPathFromArgument("DocumentSnapshot.get",fieldPath));if(void 0!==value)return this.convertValue(value,FieldValueOptions.fromSnapshotOptions(options,this._firestore._areTimestampsInSnapshotsEnabled()))}};Object.defineProperty(DocumentSnapshot.prototype,"id",{get:function(){return this._key.path.lastSegment()},enumerable:!0,configurable:!0});Object.defineProperty(DocumentSnapshot.prototype,
"ref",{get:function(){return new DocumentReference(this._key,this._firestore)},enumerable:!0,configurable:!0});Object.defineProperty(DocumentSnapshot.prototype,"exists",{get:function(){return null!==this._document},enumerable:!0,configurable:!0});Object.defineProperty(DocumentSnapshot.prototype,"metadata",{get:function(){return new SnapshotMetadata(null!==this._document&&this._document.hasLocalMutations,this._fromCache)},enumerable:!0,configurable:!0});DocumentSnapshot.prototype.isEqual=function(other){if(!(other instanceof
DocumentSnapshot))throw invalidClassError("isEqual","DocumentSnapshot",1,other);return this._firestore===other._firestore&&this._fromCache===other._fromCache&&this._key.isEqual(other._key)&&(null===this._document?null===other._document:this._document.isEqual(other._document))};DocumentSnapshot.prototype.convertObject=function(data,options){var _this=this,result={};data.forEach(function(key,value){result[key]=_this.convertValue(value,options)});return result};DocumentSnapshot.prototype.convertValue=
function(value,options){if(value instanceof ObjectValue)return this.convertObject(value,options);if(value instanceof ArrayValue)return this.convertArray(value,options);if(value instanceof RefValue){options=value.value(options);var database=this._firestore.ensureClientConfigured().databaseId();value.databaseId.isEqual(database)||error$jscomp$0("Document "+this._key.path+" contains a document reference within a different database ("+(value.databaseId.projectId+"/"+value.databaseId.database+") which is not ")+
"supported. It will be treated as a reference in the current "+("database ("+database.projectId+"/"+database.database+") ")+"instead.");return new DocumentReference(options,this._firestore)}return value.value(options)};DocumentSnapshot.prototype.convertArray=function(data,options){var _this=this;return data.internalValue.map(function(value){return _this.convertValue(value,options)})};return DocumentSnapshot}(),QueryDocumentSnapshot=function(_super){function QueryDocumentSnapshot(firestore,key,document,
fromCache){return _super.call(this,firestore,key,document,fromCache)||this}tslib_1.__extends(QueryDocumentSnapshot,_super);QueryDocumentSnapshot.prototype.data=function(options){options=_super.prototype.data.call(this,options);assert("object"===typeof options,"Document in a QueryDocumentSnapshot should exist");return options};return QueryDocumentSnapshot}(DocumentSnapshot),Query$1=function(){function Query$$1(_query,firestore){this._query=_query;this.firestore=firestore}Query$$1.prototype.where=function(field,
opStr,value){validateExactNumberOfArgs("Query.where",arguments,3);validateArgType("Query.where","string",2,opStr);validateDefined("Query.where",3,value);var fieldPath=fieldPathFromArgument("Query.where",field),relationOp=RelationOp.fromString(opStr);if(fieldPath.isKeyField()){if(relationOp===RelationOp.ARRAY_CONTAINS)throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid Query. You can't perform array-contains queries on FieldPath.documentId() since document IDs are not arrays.");if("string"===typeof value){if(-1!==
value.indexOf("/"))throw new FirestoreError(Code.INVALID_ARGUMENT,"Function Query.where() requires its third parameter to be a valid document ID if the first parameter is FieldPath.documentId(), but it contains a slash.");if(""===value)throw new FirestoreError(Code.INVALID_ARGUMENT,"Function Query.where() requires its third parameter to be a valid document ID if the first parameter is FieldPath.documentId(), but it was an empty string.");var fieldValue=this._query.path.child(new ResourcePath([value]));
assert(0===fieldValue.length%2,"Path should be a document key");fieldValue=new RefValue(this.firestore._databaseId,new DocumentKey(fieldValue))}else if(value instanceof DocumentReference)fieldValue=new RefValue(this.firestore._databaseId,value._key);else throw new FirestoreError(Code.INVALID_ARGUMENT,"Function Query.where() requires its third parameter to be a string or a DocumentReference if the first parameter is FieldPath.documentId(), but it was: "+(valueDescription(value)+"."));}else fieldValue=
this.firestore._dataConverter.parseQueryValue("Query.where",value);fieldPath=Filter.create(fieldPath,relationOp,fieldValue);this.validateNewFilter(fieldPath);return new Query$$1(this._query.addFilter(fieldPath),this.firestore)};Query$$1.prototype.orderBy=function(field,directionStr){validateBetweenNumberOfArgs("Query.orderBy",arguments,1,2);validateOptionalArgType("Query.orderBy","string",2,directionStr);if(void 0===directionStr||"asc"===directionStr)var direction=Direction.ASCENDING;else if("desc"===
directionStr)direction=Direction.DESCENDING;else throw new FirestoreError(Code.INVALID_ARGUMENT,"Function Query.orderBy() has unknown direction '"+directionStr+"', expected 'asc' or 'desc'.");if(null!==this._query.startAt)throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid query. You must not call Query.startAt() or Query.startAfter() before calling Query.orderBy().");if(null!==this._query.endAt)throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid query. You must not call Query.endAt() or Query.endBefore() before calling Query.orderBy().");
var fieldPath=fieldPathFromArgument("Query.orderBy",field);direction=new OrderBy(fieldPath,direction);this.validateNewOrderBy(direction);return new Query$$1(this._query.addOrderBy(direction),this.firestore)};Query$$1.prototype.limit=function(n){validateExactNumberOfArgs("Query.limit",arguments,1);validateArgType("Query.limit","number",1,n);if(0>=n)throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid Query. Query limit ("+n+") is invalid. Limit must be positive.");return new Query$$1(this._query.withLimit(n),
this.firestore)};Query$$1.prototype.startAt=function(docOrField){for(var fields=[],_i=1;_i<arguments.length;_i++)fields[_i-1]=arguments[_i];validateAtLeastNumberOfArgs("Query.startAt",arguments,1);fields=this.boundFromDocOrFields("Query.startAt",docOrField,fields,!0);return new Query$$1(this._query.withStartAt(fields),this.firestore)};Query$$1.prototype.startAfter=function(docOrField){for(var fields=[],_i=1;_i<arguments.length;_i++)fields[_i-1]=arguments[_i];validateAtLeastNumberOfArgs("Query.startAfter",
arguments,1);fields=this.boundFromDocOrFields("Query.startAfter",docOrField,fields,!1);return new Query$$1(this._query.withStartAt(fields),this.firestore)};Query$$1.prototype.endBefore=function(docOrField){for(var fields=[],_i=1;_i<arguments.length;_i++)fields[_i-1]=arguments[_i];validateAtLeastNumberOfArgs("Query.endBefore",arguments,1);fields=this.boundFromDocOrFields("Query.endBefore",docOrField,fields,!0);return new Query$$1(this._query.withEndAt(fields),this.firestore)};Query$$1.prototype.endAt=
function(docOrField){for(var fields=[],_i=1;_i<arguments.length;_i++)fields[_i-1]=arguments[_i];validateAtLeastNumberOfArgs("Query.endAt",arguments,1);fields=this.boundFromDocOrFields("Query.endAt",docOrField,fields,!1);return new Query$$1(this._query.withEndAt(fields),this.firestore)};Query$$1.prototype.isEqual=function(other){if(!(other instanceof Query$$1))throw invalidClassError("isEqual","Query",1,other);return this.firestore===other.firestore&&this._query.isEqual(other._query)};Query$$1.prototype.boundFromDocOrFields=
function(methodName,docOrField,fields,before){validateDefined(methodName,1,docOrField);if(docOrField instanceof DocumentSnapshot){if(0<fields.length)throw new FirestoreError(Code.INVALID_ARGUMENT,"Too many arguments provided to "+methodName+"().");if(!docOrField.exists)throw new FirestoreError(Code.NOT_FOUND,"Can't use a DocumentSnapshot that doesn't exist for "+(methodName+"()."));return this.boundFromDocument(methodName,docOrField._document,before)}docOrField=[docOrField].concat(fields);return this.boundFromFields(methodName,
docOrField,before)};Query$$1.prototype.boundFromDocument=function(methodName,doc,before){methodName=[];for(var _i=0,_a=this._query.orderBy;_i<_a.length;_i++){var orderBy=_a[_i];if(orderBy.field.isKeyField())methodName.push(new RefValue(this.firestore._databaseId,doc.key));else{var value=doc.field(orderBy.field);if(void 0!==value)methodName.push(value);else throw doc=orderBy.field.canonicalString(),new FirestoreError(Code.INVALID_ARGUMENT,"Invalid query. You are trying to start or end a query using a "+
("document for which the field '"+doc+"' (used as the ")+"orderBy) does not exist.");}}return new Bound(methodName,before)};Query$$1.prototype.boundFromFields=function(methodName,values,before){var orderBy=this._query.explicitOrderBy;if(values.length>orderBy.length)throw new FirestoreError(Code.INVALID_ARGUMENT,"Too many arguments provided to "+methodName+"(). The number of arguments must be less than or equal to the number of Query.orderBy() clauses");for(var components=[],i=0;i<values.length;i++){var rawValue=
values[i];if(orderBy[i].field.isKeyField()){if("string"!==typeof rawValue)throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid query. Expected a string for document ID in "+(methodName+"(), but got a "+typeof rawValue));if(-1!==rawValue.indexOf("/"))throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid query. Document ID '"+rawValue+"' contains a slash in "+(methodName+"()"));rawValue=new DocumentKey(this._query.path.child(rawValue));components.push(new RefValue(this.firestore._databaseId,rawValue))}else rawValue=
this.firestore._dataConverter.parseQueryValue(methodName,rawValue),components.push(rawValue)}return new Bound(components,before)};Query$$1.prototype.onSnapshot=function(){for(var args=[],_i=0;_i<arguments.length;_i++)args[_i]=arguments[_i];validateBetweenNumberOfArgs("Query.onSnapshot",arguments,1,4);_i={};var currArg=0;"object"!==typeof args[currArg]||isPartialObserver(args[currArg])||(_i=args[currArg],validateOptionNames("Query.onSnapshot",_i,["includeMetadataChanges"]),validateNamedOptionalType("Query.onSnapshot",
"boolean","includeMetadataChanges",_i.includeMetadataChanges),currArg++);isPartialObserver(args[currArg])?args=args[currArg]:(validateArgType("Query.onSnapshot","function",currArg,args[currArg]),validateOptionalArgType("Query.onSnapshot","function",currArg+1,args[currArg+1]),validateOptionalArgType("Query.onSnapshot","function",currArg+2,args[currArg+2]),args={next:args[currArg],error:args[currArg+1],complete:args[currArg+2]});return this.onSnapshotInternal(_i,args)};Query$$1.prototype.onSnapshotInternal=
function(options,observer){var _this=this,errHandler=function(err){console.error("Uncaught Error in onSnapshot:",err)};observer.error&&(errHandler=observer.error.bind(observer));var asyncObserver=new AsyncObserver({next:function(result){observer.next&&observer.next(new QuerySnapshot(_this.firestore,_this._query,result))},error:errHandler}),firestoreClient=this.firestore.ensureClientConfigured(),internalListener=firestoreClient.listen(this._query,asyncObserver,options);return function(){asyncObserver.mute();
firestoreClient.unlisten(internalListener)}};Query$$1.prototype.get=function(options){var _this=this;validateBetweenNumberOfArgs("Query.get",arguments,0,1);return new Promise(function(resolve,reject){options&&"cache"===options.source?_this.firestore.ensureClientConfigured().getDocumentsFromLocalCache(_this._query).then(function(viewSnap){resolve(new QuerySnapshot(_this.firestore,_this._query,viewSnap))},reject):_this.getViaSnapshotListener(resolve,reject,options)})};Query$$1.prototype.getViaSnapshotListener=
function(resolve,reject,options){var unlisten=this.onSnapshotInternal({includeMetadataChanges:!0,waitForSyncWhenOnline:!0},{next:function(result){unlisten();result.metadata.fromCache&&options&&"server"===options.source?reject(new FirestoreError(Code.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):resolve(result)},error:reject})};Query$$1.prototype.validateNewFilter=
function(filter){if(filter instanceof RelationFilter)if(filter.isInequality()){var existingField=this._query.getInequalityFilterField();if(null!==existingField&&!existingField.isEqual(filter.field))throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid query. All where filters with an inequality (\x3c, \x3c\x3d, \x3e, or \x3e\x3d) must be on the same field. But you have"+(" inequality filters on '"+existingField.toString()+"'")+(" and '"+filter.field.toString()+"'"));existingField=this._query.getFirstOrderByField();
null!==existingField&&this.validateOrderByAndInequalityMatch(filter.field,existingField)}else if(filter.op===RelationOp.ARRAY_CONTAINS&&this._query.hasArrayContainsFilter())throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid query. Queries only support a single array-contains filter.");};Query$$1.prototype.validateNewOrderBy=function(orderBy){if(null===this._query.getFirstOrderByField()){var inequalityField=this._query.getInequalityFilterField();null!==inequalityField&&this.validateOrderByAndInequalityMatch(inequalityField,
orderBy.field)}};Query$$1.prototype.validateOrderByAndInequalityMatch=function(inequality,orderBy){if(!orderBy.isEqual(inequality))throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid query. You have a where filter with an inequality "+("(\x3c, \x3c\x3d, \x3e, or \x3e\x3d) on field '"+inequality.toString()+"' ")+("and so you must also use '"+inequality.toString()+"' ")+"as your first Query.orderBy(), but your first Query.orderBy() "+("is on field '"+orderBy.toString()+"' instead."));};return Query$$1}(),
QuerySnapshot=function(){function QuerySnapshot(_firestore,_originalQuery,_snapshot){this._firestore=_firestore;this._originalQuery=_originalQuery;this._snapshot=_snapshot;this._cachedChangesIncludeMetadataChanges=this._cachedChanges=null;this.metadata=new SnapshotMetadata(_snapshot.hasPendingWrites,_snapshot.fromCache)}Object.defineProperty(QuerySnapshot.prototype,"docs",{get:function(){var result=[];this.forEach(function(doc){return result.push(doc)});return result},enumerable:!0,configurable:!0});
Object.defineProperty(QuerySnapshot.prototype,"empty",{get:function(){return this._snapshot.docs.isEmpty()},enumerable:!0,configurable:!0});Object.defineProperty(QuerySnapshot.prototype,"size",{get:function(){return this._snapshot.docs.size},enumerable:!0,configurable:!0});QuerySnapshot.prototype.forEach=function(callback,thisArg){var _this=this;validateBetweenNumberOfArgs("QuerySnapshot.forEach",arguments,1,2);validateArgType("QuerySnapshot.forEach","function",1,callback);this._snapshot.docs.forEach(function(doc){callback.call(thisArg,
_this.convertToDocumentImpl(doc))})};Object.defineProperty(QuerySnapshot.prototype,"query",{get:function(){return new Query$1(this._originalQuery,this._firestore)},enumerable:!0,configurable:!0});QuerySnapshot.prototype.docChanges=function(options){validateOptionNames("QuerySnapshot.docChanges",options,["includeMetadataChanges"]);options&&validateNamedOptionalType("QuerySnapshot.docChanges","boolean","includeMetadataChanges",options.includeMetadataChanges);if((options=options&&options.includeMetadataChanges)&&
this._snapshot.excludesMetadataChanges)throw new FirestoreError(Code.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===options||(this._cachedChanges=changesFromSnapshot(this._firestore,options,this._snapshot),this._cachedChangesIncludeMetadataChanges=options);return this._cachedChanges};QuerySnapshot.prototype.isEqual=function(other){if(!(other instanceof
QuerySnapshot))throw invalidClassError("isEqual","QuerySnapshot",1,other);return this._firestore===other._firestore&&this._originalQuery.isEqual(other._originalQuery)&&this._snapshot.isEqual(other._snapshot)};QuerySnapshot.prototype.convertToDocumentImpl=function(doc){return new QueryDocumentSnapshot(this._firestore,doc.key,doc,this.metadata.fromCache)};return QuerySnapshot}();["length","forEach","map"].concat("undefined"!==typeof Symbol?[Symbol.iterator]:[]).forEach(function(property){try{Object.defineProperty(QuerySnapshot.prototype.docChanges,
property,{get:function(){throw new FirestoreError(Code.INVALID_ARGUMENT,'QuerySnapshot.docChanges has been changed from a property into a method, so usages like "querySnapshot.docChanges" should become "querySnapshot.docChanges()"');}})}catch(err){}});var CollectionReference=function(_super){function CollectionReference(path,firestore){firestore=_super.call(this,Query$jscomp$0.atPath(path),firestore)||this;if(1!==path.length%2)throw new FirestoreError(Code.INVALID_ARGUMENT,"Invalid collection reference. Collection references must have an odd number of segments, but "+
(path.canonicalString()+" has "+path.length));return firestore}tslib_1.__extends(CollectionReference,_super);Object.defineProperty(CollectionReference.prototype,"id",{get:function(){return this._query.path.lastSegment()},enumerable:!0,configurable:!0});Object.defineProperty(CollectionReference.prototype,"parent",{get:function(){var parentPath=this._query.path.popLast();return parentPath.isEmpty()?null:new DocumentReference(new DocumentKey(parentPath),this.firestore)},enumerable:!0,configurable:!0});
Object.defineProperty(CollectionReference.prototype,"path",{get:function(){return this._query.path.canonicalString()},enumerable:!0,configurable:!0});CollectionReference.prototype.doc=function(pathString){validateBetweenNumberOfArgs("CollectionReference.doc",arguments,0,1);0===arguments.length&&(pathString=AutoId.newId());validateArgType("CollectionReference.doc","string",1,pathString);if(""===pathString)throw new FirestoreError(Code.INVALID_ARGUMENT,"Document path must be a non-empty string");var path=
ResourcePath.fromString(pathString);return DocumentReference.forPath(this._query.path.child(path),this.firestore)};CollectionReference.prototype.add=function(value){validateExactNumberOfArgs("CollectionReference.add",arguments,1);validateArgType("CollectionReference.add","object",1,value);var docRef=this.doc();return docRef.set(value).then(function(){return docRef})};return CollectionReference}(Query$1),PublicFirestore=makeConstructorPrivate(Firestore,"Use firebase.firestore() instead."),PublicTransaction=
makeConstructorPrivate(Transaction$1,"Use firebase.firestore().runTransaction() instead."),PublicWriteBatch=makeConstructorPrivate(WriteBatch,"Use firebase.firestore().batch() instead."),PublicDocumentReference=makeConstructorPrivate(DocumentReference,"Use firebase.firestore().doc() instead."),PublicDocumentSnapshot=makeConstructorPrivate(DocumentSnapshot),PublicQueryDocumentSnapshot=makeConstructorPrivate(QueryDocumentSnapshot),PublicQuery=makeConstructorPrivate(Query$1),PublicQuerySnapshot=makeConstructorPrivate(QuerySnapshot),
PublicCollectionReference=makeConstructorPrivate(CollectionReference,"Use firebase.firestore().collection() instead."),firestoreNamespace={Firestore:PublicFirestore,GeoPoint:GeoPoint,Timestamp:Timestamp,Blob:PublicBlob,Transaction:PublicTransaction,WriteBatch:PublicWriteBatch,DocumentReference:PublicDocumentReference,DocumentSnapshot:PublicDocumentSnapshot,Query:PublicQuery,QueryDocumentSnapshot:PublicQueryDocumentSnapshot,QuerySnapshot:PublicQuerySnapshot,CollectionReference:PublicCollectionReference,
FieldPath:FieldPath$1,FieldValue:PublicFieldValue,setLogLevel:Firestore.setLogLevel};configureForFirebase(firebase);exports.registerFirestore=function(instance){configureForFirebase(instance)}}
//# sourceMappingURL=module$node_modules$$firebase$firestore$dist$index_cjs.js.map
